{# templates/pet/pet_form.html.twig #}
{% extends 'forms/_form_base.html.twig' %}

{# Título principal da página #}
{% block form_page_title %}
    {% if pet is defined %}Editar Pet{% else %}Novo Pet{% endif %}
{% endblock %}

{# Itens do breadcrumb #}
{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-primary">Pets</a></li>
    <li class="breadcrumb-item active">{% if pet is defined %}Editar{% else %}Novo{% endif %}</li>
{% endblock %}

{# Conteúdo do formulário #}
{% block form_content %}
    <form method="post"
          action="{% if pet is defined %}{{ path('pet_editar', {'id': pet.id}) }}{% else %}{{ path('pet_novo') }}{% endif %}">
        <div class="mb-3">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome" name="nome" value="{{ pet.nome|default('') }}" required>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="especie" class="form-label">Espécie</label>
                <input type="text" class="form-control" id="especie" name="especie"
                       value="{{ pet.especie|default('') }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="sexo" class="form-label">Sexo</label>
                <select class="form-control" id="sexo" name="sexo">
                    <option value="">Selecionar</option>
                    <option value="M" {% if pet.sexo is defined and pet.sexo == 'M' %}selected{% endif %}>Macho</option>
                    <option value="F" {% if pet.sexo is defined and pet.sexo == 'F' %}selected{% endif %}>Fêmea</option>
                </select>
            </div>
        </div>
        <div class="mb-3 autocomplete">
            <label for="raca" class="form-label">Raça</label>
            <input type="text" class="form-control" id="raca" name="raca" value="{{ pet.raca|default('') }}">
            <div id="autocomplete-list" class="autocomplete-items"></div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="porte" class="form-label">Porte</label>
                <select class="form-control" id="porte" name="porte">
                    <option value="">Selecionar</option>
                    <option value="Pequeno" {% if pet.porte is defined and pet.porte == 'Pequeno' %}selected{% endif %}>
                        Pequeno
                    </option>
                    <option value="Médio" {% if pet.porte is defined and pet.porte == 'Médio' %}selected{% endif %}>
                        Médio
                    </option>
                    <option value="Grande" {% if pet.porte is defined and pet.porte == 'Grande' %}selected{% endif %}>
                        Grande
                    </option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="idade" class="form-label">Idade</label>
                <input type="number" class="form-control" id="idade" name="idade" value="{{ pet.idade|default('') }}">
            </div>
        </div>
        <div class="mb-3">
            <label for="observacoes" class="form-label">Observações</label>
            <textarea class="form-control" id="observacoes" name="observacoes"
                      rows="3">{{ pet.observacoes|default('') }}</textarea>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="peso" class="form-label">Peso (kg)</label>
                <input type="number" step="0.01" class="form-control" id="peso" name="peso"
                       value="{{ pet.peso|default('') }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="castrado" class="form-label">Castrado</label>
                <select class="form-control" id="castrado" name="castrado">
                    <option value="0" {% if pet.castrado is defined and pet.castrado == 0 %}selected{% endif %}>Não
                    </option>
                    <option value="1" {% if pet.castrado is defined and pet.castrado == 1 %}selected{% endif %}>Sim
                    </option>
                </select>
            </div>
        </div>
        <div class="mb-3">
            <label for="dono_id" class="form-label">Dono</label>
            <select class="form-control" id="dono_id" name="dono_id">
                <option value="">Selecionar cliente</option>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}"
                            {% if pet.dono_id is defined and cliente.id == pet.dono_id %}selected{% endif %}>{{ cliente.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-success w-50">Salvar</button>
        </div>
    </form>
{% endblock %}

{# JavaScript específico para este formulário #}
{% block form_javascripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var racas = {{ racas|json_encode()|raw }};
            var input = document.getElementById("raca");

            input.addEventListener("input", function () {
                var val = this.value;
                closeAllLists();
                if (!val) return false;

                var divList = document.createElement("div");
                divList.setAttribute("id", "autocomplete-list");
                divList.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(divList);

                racas.forEach(function (raca) {
                    if (raca.toLowerCase().includes(val.toLowerCase())) {
                        var item = document.createElement("div");
                        item.setAttribute("class", "lista");
                        item.innerHTML = "<strong>" + raca.substr(0, val.length) + "</strong>" + raca.substr(val.length);
                        item.innerHTML += "<input type='hidden' value='" + raca + "'>";
                        item.addEventListener("click", function () {
                            input.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        divList.appendChild(item);
                    }
                });
            });

            function closeAllLists(elmnt) {
                var items = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != input) {
                        items[i].parentNode.removeChild(items[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        });
    </script>
{% endblock %}