{% extends 'base.html.twig' %}

{% block title %}Ficha de Internação - {{ internacao.pet_nome }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
    .main-card, .info-card {
      background: #fff; border-radius: 12px; padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e9ecef; height: 100%;
    }
    .info-card { padding: 30px; }
    .info-card h5 { font-size: 1.5rem; font-weight: 600; }
    .pet-avatar { width: 110px; height: 110px; object-fit: cover; border-radius: 50%; border: 4px solid #e9ecef; }
    .debt-tag { background-color: #dc3545; color: white; padding: 8px 15px; border-radius: 8px; font-size: 1rem; font-weight: bold; display: inline-block; }

    .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; border-bottom: 3px solid transparent; }
    .nav-tabs .nav-link.active { color: #0d6efd; background-color: #fff; border-color: #dee2e6 #dee2e6 #0d6efd; font-weight: bold; }

    .timeline { position: relative; padding-left: 35px; list-style: none; }
    .timeline:before { content: ''; position: absolute; left: 12px; top: 5px; bottom: 5px; width: 3px; background: #e9ecef; border-radius: 2px; }
    .timeline-item { position: relative; margin-bottom: 25px; }
    .timeline-icon {
      position: absolute; left: -32px; top: 0; width: 45px; height: 45px;
      border-radius: 50%; background: #fff; border: 3px solid #e9ecef;
      color: #495057; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;
    }
    .timeline-content { transition: border-color 0.3s; }
    .timeline-content .timeline-date { font-size: 0.85em; color: #dc3545; font-weight: bold; margin-bottom: 4px; }
    a.timeline-text { font-size: 1rem; font-weight: 500; color: #343a40; text-decoration: none; display: block; }
    a.timeline-text:hover { color: #0d6efd; }

    .bg-purple { background-color: #6f42c1 !important; }
  </style>
{% endblock %}

{% block body %}
<div class="container-fluid my-4">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Ficha de Internação</h4>
      <a href="{{ path('clinica_detalhes_pet', {'id': internacao.pet_id}) }}" class="btn btn-light">
        <i class="fas fa-arrow-left me-2"></i>Voltar
      </a>
    </div>

    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h5 class="mb-0">{{ internacao.pet_nome }} ({{ internacao.pet_id }})</h5>
          <p class="text-muted mb-0">
            {{ internacao.pet_raca ?? '-' }}, {{ internacao.pet_sexo ?? '-' }}, {{ internacao.pet_idade ?? '-' }}
          </p>
          <p class="text-muted mb-0">
            Tutor: {{ internacao.dono_nome ?? '-' }}{% if internacao.dono_id %} ({{ internacao.dono_id }}){% endif %}
          </p>
        </div>
        <div class="text-end">
          {% if internacao.situacao %}<span class="badge bg-warning">{{ internacao.situacao }}</span>{% endif %}
          <p class="mb-0">Duração: {{ internacao.duracao ?? '-' }}</p>
          <p class="mb-0">Veterinário: {{ internacao.veterinario_nome ?? '-' }}</p>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-3"><strong>Motivo:</strong> {{ internacao.motivo ?? '-' }}</div>
        <div class="col-md-3"><strong>Risco:</strong> {{ internacao.risco ?? '-' }}</div>
        <div class="col-md-3"><strong>Box:</strong> {{ internacao.box ?? '-' }}</div>
        <div class="col-md-3"><strong>Prognóstico:</strong> {{ internacao.prognostico ?? '-' }}</div>
        <div class="col-md-3">
          <strong>Alta prevista:</strong>
          {{ internacao.alta_prevista ? internacao.alta_prevista|date('d/m/Y') : '-' }}
        </div>
      </div>

      <div class="mb-3">
        <strong>Anotações:</strong>
        <div class="text-muted">{{ internacao.anotacoes ?: '-' }}</div>
      </div>

      <hr>

      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-sm btn-primary me-2"><i class="fas fa-edit me-1"></i> Editar</button>
        <button 
            class="btn btn-sm btn-success me-2"
            id="btn-alta"
            data-url="{{ path('clinica_internacao_alta', {id: internacao.id}) }}"
            data-token="{{ csrf_token('alta_internacao_' ~ internacao.id) }}">
            <i class="fas fa-check me-1"></i> Alta
        </button>
        <button class="btn btn-sm btn-danger me-2"><i class="fas fa-times me-1"></i> Óbito</button>
        <button class="btn btn-sm btn-secondary me-2"><i class="fas fa-boxes me-1"></i> Box</button>
        <button class="btn btn-sm btn-warning me-2"><i class="fas fa-ban me-1"></i> Cancelar</button>
        <button class="btn btn-sm btn-info me-2"><i class="fas fa-print me-1"></i> Imprimir</button>
      </div>

      <ul class="nav nav-tabs" id="internacaoTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico-content" type="button" role="tab" aria-controls="historico-content" aria-selected="true">
            Histórico
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="prescricao-tab" data-bs-toggle="tab" data-bs-target="#prescricao-content" type="button" role="tab" aria-controls="prescricao-content" aria-selected="false">
            Prescrição Médica
          </button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 p-3" id="internacaoTabContent">
        {# HISTÓRICO / LINHA DO TEMPO #}
        <div class="tab-pane fade show active" id="historico-content" role="tabpanel" aria-labelledby="historico-tab">

          <div class="d-flex justify-content-end mb-3">
            <div class="dropdown">
              <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-plus me-1"></i> Adicionar
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">Ocorrência</a></li>
                <li><a class="dropdown-item" href="#">Enviar Mensagem</a></li>
                <li><a class="dropdown-item" href="#">Peso</a></li>
                <li><a class="dropdown-item" href="#">Relatório Médico</a></li>
              </ul>
            </div>
          </div>

          {# IMPORTANTE: não sobrescrever a timeline. Renderiza exatamente o que veio do controller. #}
          <ul class="timeline" style="max-height: 400px; overflow-y: auto;">
            {% for ev in timeline|default([]) %}
              {% set tipo  = (ev.tipo ?? 'internacao')|lower %}
              {% set icone = 'fa-notes-medical' %}
              {% set badge = 'bg-secondary' %}

              {% if tipo in ['consulta','retorno'] %}
                {% set icone = 'fa-stethoscope' %}{% set badge = 'bg-primary' %}
              {% elseif tipo == 'receita' %}
                {% set icone = 'fa-file-prescription' %}{% set badge = 'bg-purple' %}
              {% elseif tipo in ['medicacao','medicação','medicacao_exec','execucao'] %}
                {% set icone = 'fa-pills' %}{% set badge = 'bg-info' %}
              {% elseif tipo == 'peso' %}
                {% set icone = 'fa-weight' %}{% set badge = 'bg-warning' %}
              {% elseif tipo in ['ocorrencia','ocorrência','alerta'] %}
                {% set icone = 'fa-exclamation-circle' %}{% set badge = 'bg-danger' %}
              {% elseif tipo in ['internacao','internação','admissao','admissão','alta'] %}
                {% set icone = 'fa-hospital' %}{% set badge = 'bg-success' %}
              {% endif %}

              <li class="timeline-item">
                <div class="timeline-icon {{ badge }} text-white"><i class="fas {{ icone }}"></i></div>
                <div class="timeline-content">
                  <p class="timeline-date">
                    {# aceita DateTime ou string no formato SQL #}
                    {{ ev.data_hora ? (ev.data_hora is iterable ? ev.data_hora : ev.data_hora)|date('d/m/Y H:i') : '-' }}
                  </p>
                  <h6 class="mb-1">
                    {{ ev.titulo
                      ?? (tipo in ['consulta','retorno'] ? 'Atendimento - ' ~ (tipo|capitalize) : '—') }}
                  </h6>
                  {% if ev.descricao %}
                    <p class="text-muted">{{ ev.descricao }}</p>
                  {% endif %}
                </div>
              </li>
            {% else %}
              <li class="ms-2">Nenhum evento registrado.</li>
            {% endfor %}
          </ul>
        </div>

        <div class="tab-pane fade" id="prescricao-content" role="tabpanel" aria-labelledby="prescricao-tab">
          <p>Conteúdo da Prescrição Médica aqui...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  <script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('#btn-alta');
    if (!btn) return;

    if (!confirm('Confirmar alta desta internação?')) return;

    const url = btn.dataset.url;
    const token = btn.dataset.token;

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
        body: new URLSearchParams({_token: token})
      });

      const data = await resp.json();
      if (data.ok) {
        alert('Internação finalizada com sucesso!');
        // mantém na mesma ficha (recarrega e puxa timeline atualizada do controller)
        window.location.href = "{{ path('clinica_ficha_internacao', {id: internacao.id}) }}";
      } else {
        alert(data.msg || 'Não foi possível finalizar.');
      }
    } catch (err) {
      console.error(err);
      alert('Falha na requisição.');
    }
  });
  </script>
{% endblock %}
