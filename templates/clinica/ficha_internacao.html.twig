{% extends 'baseClinica.html.twig' %}

{% block title %}Ficha de Internação - {{ internacao.pet_nome }}{% endblock %}

{% block body %}
    <div class="container-fluid my-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">Ficha de Internação</h4>
                <a href="{{ path('clinica_detalhes_pet', {'id': internacao.pet_id}) }}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>

            <div class="card-body">
                {# Dados principais do pet #}
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="mb-0">{{ internacao.pet_nome }} ({{ internacao.pet_id }})</h5>
                        <p class="text-muted mb-0">{{ internacao.pet_raca ?? '-' }}, {{ internacao.pet_sexo ?? '-' }}
                            , {{ internacao.pet_idade ?? '-' }}</p>
                        <p class="text-muted mb-0">
                            Tutor: {{ internacao.dono_nome ?? '-' }}{% if internacao.dono_id %} ({{ internacao.dono_id }}){% endif %}</p>
                    </div>
                    <div class="text-end">
                        {% if internacao.situacao %}<span
                                class="badge bg-warning">{{ internacao.situacao }}</span>{% endif %}
                        <p class="mb-0">Duração: {{ internacao.duracao ?? '-' }}</p>
                        <p class="mb-0">Veterinário: {{ internacao.veterinario_nome ?? '-' }}</p>
                    </div>
                </div>

                {# Dados clínicos #}
                <div class="row g-3 mb-3">
                    <div class="col-md-3"><strong>Motivo:</strong> {{ internacao.motivo ?? '-' }}</div>
                    <div class="col-md-3"><strong>Risco:</strong> {{ internacao.risco ?? '-' }}</div>
                    <div class="col-md-3"><strong>Box:</strong> {{ internacao.box ?? '-' }}</div>
                    <div class="col-md-3"><strong>Prognóstico:</strong> {{ internacao.prognostico ?? '-' }}</div>
                    <div class="col-md-3"><strong>Alta
                            prevista:</strong> {{ internacao.alta_prevista ? internacao.alta_prevista|date('d/m/Y') : '-' }}
                    </div>
                </div>

                <div class="mb-3"><strong>Anotações:</strong>
                    <div class="text-muted">{{ internacao.anotacoes is not empty ? internacao.anotacoes|raw : '-' }}</div>
                </div>

                <hr>

                {# Ações #}
                <div class="d-flex justify-content-end mb-3">
                    {# <button class="btn btn-sm btn-primary me-2"><i class="fas fa-edit me-1"></i> Editar</button> #}
                    <button class="btn btn-sm btn-success me-2 internacao-acao"
                            data-url="{{ path('clinica_internacao_acao', {id: internacao.id, acao: 'alta'}) }}"
                            data-token="{{ csrf_token('internacao_acao_' ~ internacao.id) }}">
                        <i class="fas fa-check me-1"></i> Alta
                    </button>
                    <button class="btn btn-sm btn-danger me-2 internacao-acao"
                            data-url="{{ path('clinica_internacao_acao', {id: internacao.id, acao: 'obito'}) }}"
                            data-token="{{ csrf_token('internacao_acao_' ~ internacao.id) }}">
                        <i class="fas fa-skull me-1"></i> Óbito
                    </button>
                    <button class="btn btn-sm btn-warning me-2 internacao-acao"
                            data-url="{{ path('clinica_internacao_acao', {id: internacao.id, acao: 'cancelar'}) }}"
                            data-token="{{ csrf_token('internacao_acao_' ~ internacao.id) }}">
                        <i class="fas fa-ban me-1"></i> Cancelar
                    </button>
                </div>

                {# Tabs #}
                <ul class="nav nav-tabs" id="internacaoTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="historico-tab" data-bs-toggle="tab"
                                data-bs-target="#historico-content" type="button">Histórico
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="prescricao-tab" data-bs-toggle="tab"
                                data-bs-target="#prescricao-content" type="button">Prescrição e Calendário
                        </button>
                    </li>
                </ul>

                <div class="tab-content border border-top-0 p-3" id="internacaoTabContent">
                    {# Histórico #}
                    <div class="tab-pane fade show active" id="historico-content">
                        <div style="max-height: 400px; overflow-y: auto;">
                            <ul class="timeline">
                                {% for ev in timeline|default([]) %}
                                    {% set tipo = (ev.tipo ?? 'internacao')|lower %}
                                    {% set icone, badge = 'fa-notes-medical', 'bg-secondary' %}
                                    {% if tipo in ['consulta','retorno'] %}{% set icone, badge = 'fa-stethoscope', 'bg-primary' %}
                                    {% elseif tipo == 'receita' %}{% set icone, badge = 'fa-file-prescription', 'bg-purple' %}
                                    {% elseif tipo in ['medicacao','medicação','medicacao_exec','execucao'] %}{% set icone, badge = 'fa-pills', 'bg-info' %}
                                    {% elseif tipo == 'peso' %}{% set icone, badge = 'fa-weight', 'bg-warning' %}
                                    {% elseif tipo in ['ocorrencia','ocorrência','alerta'] %}{% set icone, badge = 'fa-exclamation-circle', 'bg-danger' %}
                                    {% elseif tipo in ['alta'] %}
                                        {% set icone, badge = 'fa-hospital', 'bg-success' %}
                                    {% elseif tipo in ['obito'] %}
                                        {% set icone, badge = 'fa-hospital', 'bg-danger' %}
                                    {% elseif tipo in ['cancelar'] %}
                                        {% set icone, badge = 'fa-hospital', 'bg-warning' %}
                                    {% elseif tipo in ['internacao','internação','admissao','admissão'] %}
                                        {% set icone, badge = 'fa-hospital', 'bg-primary' %}
                                    {% endif %}
                                    <li class="timeline-item">
                                        <div class="timeline-badge {{ badge }}"><i class="fas {{ icone }}"></i></div>
                                        <div class="timeline-panel">
                                            <h5 class="timeline-title">{{ ev.titulo|default(tipo|capitalize) }}</h5>
                                            <small class="text-muted">{{ ev.data_hora|date('d/m/Y H:i')|default('-') }}</small>
                                            {% if ev.descricao %}<p
                                                    class="text-muted">{{ ev.descricao|raw }}</p>{% endif %}
                                        </div>
                                    </li>
                                {% else %}
                                    <li class="ms-2">Nenhum evento registrado.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    {# Prescrições + Calendário #}
                    <div class="tab-pane fade" id="prescricao-content">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-sm btn-info me-2 modal-NovoMedicamento">
                                <i class="fas fa-plus me-1"></i>
                                Adicionar Medicamento
                            </button>
                            <button class="btn btn-sm btn-primary modalPrescricaoBtn"><i class="fas fa-plus me-1"></i>
                                Nova Prescrição
                            </button>
                        </div>

                        <table class="table table-bordered table-striped align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Medicamento</th>
                                <th>Dose</th>
                                <th>Frequência</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for p in prescricoes %}
                                <tr>
                                    <td>{{ p.medicamento.nome }}<p class="text-muted small mb-0">Criado
                                            em: {{ p.criadoEm|date('d/m/Y H:i') }}</p></td>
                                    <td>{{ p.dose }}</td>
                                    <td>A cada {{ p.frequenciaHoras }}h por {{ p.duracaoDias }} dias</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhuma prescrição registrada.</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <hr>
                        <h5 class="mb-3">Calendário de Medicações</h5>
                        <div id="calendar-pet" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Modal Nova Prescrição #}
    <div class="d-none modalPrescricao">
        <form id="formPrescricao" method="post"
              action="{{ path('clinica_internacao_prescricao_nova', {id: internacao.id}) }}">
            <div class="mb-3">
                <label class="form-label">Medicamento</label>
                <select name="medicamento_id" class="form-select" required>
                    {% for med in medicamentos %}
                        <option value="{{ med.id }}">{{ med.nome }} ({{ med.via }} {{ med.concentracao }}
                        )</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Dose</label>
                <input type="text" name="dose" class="form-control" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Frequência (horas)</label>
                    <input type="number" name="frequencia_horas" class="form-control" required min="1">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Duração (dias)</label>
                    <input type="number" name="duracao_dias" class="form-control" required min="1">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Data/Hora da 1ª dose</label>
                <input type="datetime-local" name="data_hora_primeira_dose" class="form-control" required>
            </div>
        </form>
    </div>

    <div class="modalNovoMedicamento d-none">
        <form id="formNovoMedicamento" method="post" action="{{ path('clinica_internacao_medicamento_novo') }}">
            <div class="mb-3">
                <label class="form-label">Nome</label>
                <input type="text" class="form-control" name="nome" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Via de Administração</label>
                <input type="text" class="form-control" name="via" laceholder="Ex: Oral, IV, SC">
            </div>
            <div class="mb-3">
                <label class="form-label">Concentração</label>
                <input type="text" class="form-control" name="concentracao" placeholder="Ex: 5mg/ml">
            </div>


        </form>
    </div>


    {# Modal Novo Medicamento #}


    {# Modal Executar Prescrição #}
    <div class="modalexecutaprescricao d-none">
        <form id="formExecutarPrescricao" method="post">
            <input type="hidden" name="prescricao_id" id="exec-prescricao-id">
            <div class="mb-3">
                <label class="form-label">Hora da aplicação</label>
                <input type="datetime-local" name="hora_aplicacao" class="form-control" required>
            </div>
            <div class="mb-3"><label class="form-label">Veterinário responsável</label>
                <select name="veterinario_id" class="form-select" required>
                    {% for vet in veterinarios %}
                        <option value="{{ vet.id }}">{{ vet.nome }} ({{ vet.crmv }})</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Observações</label>
                <textarea name="anotacoes" class="form-control"></textarea>
            </div>
        </form>
    </div>


{% endblock %}

{% block javascripts %}
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js'></script>
    <script>
        $(function () {
            // === Alterado: Botões de Ações de Internação (Alta, Óbito, Cancelar) ===
            $(document).on('click', '.internacao-acao', async function (e) {
                e.preventDefault();

                const $btn = $(this);
                const url = $btn.data('url');
                const token = $btn.data('token');

                let confirmMsg = 'Confirmar esta ação na internação?';
                if (url.includes('alta')) confirmMsg = 'Confirmar alta desta internação?';
                if (url.includes('obito')) confirmMsg = 'Confirmar óbito desta internação?';
                if (url.includes('cancelar')) confirmMsg = 'Confirmar cancelamento desta internação?';

                if (!confirm(confirmMsg)) return;

                try {
                    const resp = await $.ajax({
                        url: url,
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                        },
                        data: {
                            _token: token
                        }
                    });

                    if (resp.ok) {
                        alert('Ação registrada com sucesso!');
                        location.reload();
                    } else {
                        alert(resp.msg);
                    }
                } catch (err) {
                    alert('Erro ao processar ação.');
                }
            });
            //$('.fc-timeGridWeek-button').trigger('click')

            // Form Nova Prescrição
            // var formPrescricao $('#formPrescricao');
            $('.modalPrescricaoBtn').on('click', function () {
                Utils.modal($('.modalPrescricao').html(), 'secondary', function () {
                    var divModal = $('.modal #formPrescricao');
                    var medicamentoId = divModal.find('select[name="medicamento_id"]').val();
                    var dose = divModal.find('input[name="dose"]').val();
                    var frequencia_horas = divModal.find('input[name="frequencia_horas"]').val();
                    var duracao_dias = divModal.find('input[name="duracao_dias"]').val();
                    var data_hora_primeira_dose = divModal.find('input[name="data_hora_primeira_dose"]').val();

                    var postData = {
                        'medicamentoId': medicamentoId,
                        'dose': dose,
                        'frequencia_horas': frequencia_horas,
                        'duracao_dias': duracao_dias,
                        'data_hora_primeira_dose': data_hora_primeira_dose,
                    };


                    Utils.globalPostAjax(divModal.attr('action'), postData, function (result) {
                        console.log(result)
                        window.location.reload()
                    });

                }, 'lg', 'Nova Prescrição', 'Salvar', 'Cancelar', '');
            });
            // formPrescricao.on('submit', function(e){

            //     return false;
            // }); 
            // const form = document.querySelector('#formPrescricao');
            // if (form) {
            //     form.addEventListener('submit', async e => {
            //         e.preventDefault();
            //         try {
            //             const resp = await fetch(form.action, {method: 'POST', body: new FormData(form)});
            //             const data = await resp.json();
            //             if (data.ok) {
            //                 bootstrap.Modal.getInstance(document.getElementById('modalPrescricao')).hide();
            //                 location.reload();
            //             } else {
            //                 alert(data.msg);
            //             }
            //         } catch (err) {
            //             alert('Erro.');
            //         }
            //     });
            // }

            $('.modal-NovoMedicamento').on('click', function () {
                var conteudoModalMedicamento = $('.modalNovoMedicamento').html()
                Utils.modal(conteudoModalMedicamento, 'secondary', function () {
                    const formNovoMed = $('.modal #formNovoMedicamento');
                    var nome = formNovoMed.find('input[name="nome"]').val();
                    var via = formNovoMed.find('input[name="via"]').val();
                    var concentracao = formNovoMed.find('input[name="concentracao"]').val();

                    var dataPost = {
                        'nome': nome,
                        'via': via,
                        'concentracao': concentracao,
                    };
                    var loading = '';

                    $.ajax({
                        type: 'post',
                        dataType: 'json',
                        url: formNovoMed.attr('action'),
                        data: dataPost,
                        beforeSend: function () {
                            loading = Utils.loadingMessage('Aguarde...')
                            formNovoMed.find('.btn-success').prop('disabled', true)
                        },
                        success: function (result) {
                            Utils.hideModal(loading)
                            formNovoMed.find('.btn-success').prop('disabled', false);
                            if (result.ok == true) {
                                loading = Utils.loadingMessage('Aguarde...')
                                Utils.modal(result.msg, 'success', function () {
                                    Utils.hideModal(loading)
                                    location.reload();
                                });

                            } else {
                                Utils.modal(result.msg, 'danger')
                            }
                        },
                        error: function (x, htt) {
                            Utils.hideModal(loading)
                            formNovoMed.find('.btn-success').prop('disabled', false)
                            console.log(x, htt)
                            Utils.modal("Houve um erro interno, contacte a administração", 'danger');
                        }
                    });
                }, 'md', 'Adicionar Novo Medicamento', "Salvar Medicamento", 'Cancelar')
            })
            // Form Novo Medicamento

            // if (formNovoMed) {
            //     formNovoMed.addEventListener('submit', async e => {
            //         e.preventDefault();
            //         try {
            //             const resp = await fetch(formNovoMed.action, {method: 'POST', body: new FormData(formNovoMed)});
            //             const data = await resp.json();
            //             if (data.ok) {
            //                 bootstrap.Modal.getInstance(document.getElementById('modalNovoMedicamento')).hide();
            //                 location.reload();
            //             } else {
            //                 alert(data.msg);
            //             }
            //         } catch (err) {
            //             alert('Erro.');
            //         }
            //     });
            // }

            // Calendário
            const calendarEl = document.getElementById('calendar-pet');
            var calendario = $('#calendar-pet');
            var eventos = {{ calendario_prescricoes|json_encode|raw }};

            function toDateTimeLocalValue(date) {
                const pad = n => n < 10 ? '0' + n : n;
                return date.getFullYear() + '-' +
                    pad(date.getMonth() + 1) + '-' +
                    pad(date.getDate()) + 'T' +
                    pad(date.getHours()) + ':' +
                    pad(date.getMinutes());
            }

            if (calendario.length) {
                var eventos = {{ calendario_prescricoes|json_encode|raw }};
                window.calendar = new FullCalendar.Calendar(calendario[0], {
                    initialView: 'timeGridWeek',
                    locale: 'pt-br',
                    height: 650,
                    slotMinTime: "00:00:00",
                    slotMaxTime: "24:00:00",
                    allDaySlot: false,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridDay,timeGridWeek,dayGridMonth'
                    },
                    events: eventos,
                    dateClick: function (info) {
                        console.log(info.event)

                        console.log(toDateTimeLocalValue(new Date(info.date)))
                        $(document).find('input[name="data_hora_primeira_dose"]').attr('value', toDateTimeLocalValue(new Date(info.date)));

                        Utils.modal($('.modalPrescricao').html(), 'secondary', function () {
                            var divModal = $('.modal #formPrescricao');
                            //data_hora_primeira_dose
                            //toDateTimeLocalValue(new Date(info.date))
                            var medicamentoId = divModal.find('select[name="medicamento_id"]').val();
                            var dose = divModal.find('input[name="dose"]').val();
                            var frequencia_horas = divModal.find('input[name="frequencia_horas"]').val();
                            var duracao_dias = divModal.find('input[name="duracao_dias"]').val();
                            var data_hora_primeira_dose = divModal.find('input[name="data_hora_primeira_dose"]').val();

                            var postData = {
                                'medicamentoId': medicamentoId,
                                'dose': dose,
                                'frequencia_horas': frequencia_horas,
                                'duracao_dias': duracao_dias,
                                'data_hora_primeira_dose': data_hora_primeira_dose,
                            };


                            Utils.globalPostAjax(divModal.attr('action'), postData, function (result) {
                                console.log(result)
                                window.location.reload()
                            });

                        }, 'lg', 'Nova Prescrição', 'Salvar', 'Cancelar', '');
                        // editingEvent = null;
                        // $('#eventModalLabel').text('Criar Medicação');
                        // $title.val('');
                        // // info.date é Date no fuso local
                        // $date.val(toDateTimeLocalValue(new Date(info.date)));
                        // $deleteBtn.addClass('d-none'); // esconder botão de excluir ao criar
                        // bsModal.show();
                    },

                    // clique no evento abre modal
                    eventClick: function (info) {
                        console.log(info.event)
                        let start = info.event.start;
                        let end = info.event.end;

                        // converte para o formato que o datetime-local aceita
                        let startLocal = start.toISOString().slice(0, 16);

                        $(document).find('input[name="hora_aplicacao"]').attr('value', toDateTimeLocalValue(new Date(startLocal)));

                        var modalContent = $(".modalexecutaprescricao").html();

                        var $form = $("#formExecutarPrescricao");
                        var prescricaoId = info.event.extendedProps.prescricao_id;
                        var habilitaModal = info.event.extendedProps.habilita_modal;
                        console.log(prescricaoId)


                        var url = "{{ path('clinica_internacao_prescricao_executar',{id: internacao.id, eventoId: 'PRESCRICAO_ID'}) }}".replace('PRESCRICAO_ID', prescricaoId);
                        url.replace('PRESCRICAO_ID', prescricaoId);
                        $form.attr("action", url);
                        $("#exec-prescricao-id").val(prescricaoId);

                        if (habilitaModal == false) {
                            Utils.modal('Esta prescrição já foi executada', 'secondary')
                        }
                        if (habilitaModal == true) {


                            Utils.modal(modalContent, 'secondary', function () {
                                // Notify.toast('TESTE', 'success')
                                var postData = {
                                    'hora_aplicacao': $('#formExecutarPrescricao').find('input[name="hora_aplicacao"]').val(),
                                    'veterinario_id': $('#formExecutarPrescricao').find('select[name="veterinario_id"]').val(),
                                    'anotacoes': $('#formExecutarPrescricao').find('input[name="anotacoes"]').val()
                                };
                                Utils.globalPostAjax(url, postData, function (result) {

                                    if (result.ok == true) {
                                        Notify.toast(result.msg || 'Executado!', 'success')
                                        window.calendar.refetchEvents();
                                        window.location.reload();
                                    } else {
                                        Utils.modal(result.msg, 'danger');
                                    }

                                });
                            }, 'md', 'Executar Prescrição', okText = "Confirmar", 'Cancelar');
                        }
                        // new bootstrap.Modal($modal[0]).show();
                    }
                });
                window.calendar.render();
            }

            $('#prescricao-tab').on('click', function () {
                window.calendar.render();
            });


            // Form Executar Prescrição

        });
    </script>
{% endblock %}
