{% extends 'base.html.twig' %}
{% block title %}Ponto de Venda - Controle de Estoque{% endblock %}
{% block page_title %}Controle de Estoque{% endblock %}
{% block body %}
    <div class="pagetitle">
        <h1>Ponto de Venda - Controle de Estoque
            <a class="me-md-5 mt-sm-3 btn btn-primary btm-sm mb-3 float-md-end" href="{{ url('clinica_pdv_index') }}"><i
                        class="bi bi-arrow-left me-1"></i>Voltar</a>
        </h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url('home') }}">Home</a></li>
                <li class="breadcrumb-item">Atendimento</li>
                <li class="breadcrumb-item active">PDV - Controle de estoque</li>
            </ol>
        </nav>
    </div>
    <div class="container-fluid bg-white p-4 mt-4 rounded shadow-sm">
        <!-- üîπ Barra de navega√ß√£o -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-boxes me-2"></i> Controle de Estoque</h3>
            <div class="d-flex gap-2">
                <a href="{{ path('clinica_pdv_index') }}" class="btn btn-outline-success">
                    <i class="bx bx-calculator"></i> PDV
                </a>
                <a href="{{ path('clinica_pdv_caixa') }}" class="btn btn-outline-primary">
                    <i class="bx bx-wallet"></i> Caixa
                </a>
                <a href="javascript:void(0);" class="btn btn-outline-primary novoProd">
                    <i class="bx bx-plus"></i> Novo Produto
                </a>
            </div>
        </div>
        <hr>
        <div class="d-none formProd">
            <div class="tabsProd">
                <ul class="nav nav-tabs gap-2 mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dados">Produto</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#classificacao">Classifica√ß√£o Fiscal
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#impostos">Impostos Atuais</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reforma">Reforma Tribut√°ria</button>
                    </li>
                </ul>
                <form>
                    <div class="tab-content">
                        <!-- PRODUTO -->
                        <div class="tab-pane fade show active" id="dados">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Nome do Produto</label>
                                    <input type="text" class="form-control" placeholder="Ex: Ra√ß√£o Premium Adulto">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select">
                                        <option value="produto">Produto</option>
                                        <option value="servico">Servi√ßo</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Pre√ßo de Venda</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Custo</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estoque</label>
                                    <input type="number" class="form-control">
                                </div>
                            </div>
                        </div>
                        <!-- CLASSIFICA√á√ÉO FISCAL -->
                        <div class="tab-pane fade" id="classificacao">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">NCM</label>
                                    <input type="text" class="form-control" placeholder="0000.00.00">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">CFOP</label>
                                    <input type="text" class="form-control" placeholder="5102">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">CEST (opcional)</label>
                                    <input type="text" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">C√≥digo de Servi√ßo Municipal (NFS-e)</label>
                                    <input type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <!-- IMPOSTOS ATUAIS -->
                        <div class="tab-pane fade" id="impostos">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">ICMS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ISS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">IPI (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">PIS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">COFINS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                            </div>
                        </div>
                        <!-- REFORMA TRIBUT√ÅRIA -->
                        <div class="tab-pane fade" id="reforma">
                            <div class="alert alert-info">
                                <strong>Reforma Tribut√°ria</strong><br>
                                Campos v√°lidos a partir de 01/01/2026 (fase de transi√ß√£o).
                            </div>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">IBS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">CBS (%)</label>
                                    <input type="number" step="0.01" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="novoProduto" tabindex="-1" aria-labelledby="novoProdutoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="novoProdutoLabel">Cadastro de novo Produto</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Formul√°rio de cadastro -->
        <h5 class="mt-3 mb-3 text-primary">Cadastrar novo produto</h5>
        <form method="post" action="{{ path('clinica_estoque_cadastrar') }}" class="row g-3">
            <div class="col-md-3">
                <input type="text" name="nome" class="form-control" placeholder="Nome do produto" required>
            </div>
            <div class="col-md-2">
                <input type="number" step="0.01" name="preco_custo" class="form-control" placeholder="Pre√ßo de custo">
            </div>
            <div class="col-md-2">
                <input type="number" step="0.01" name="preco_venda" class="form-control" placeholder="Pre√ßo de venda">
            </div>
            <div class="col-md-2">
                <input type="number" name="estoque_atual" class="form-control" placeholder="Qtd inicial">
            </div>
            <div class="col-md-2">
                <input type="text" name="unidade" class="form-control" placeholder="Unidade (ex: un, cx)">
            </div>
            <div class="col-md-1">
                <button class="btn btn-sm btn-success p-2 w-100"><i class="bx bx-plus"></i></button>
            </div>
        </form>
        <hr>
        <!-- Tabela de produtos -->
        <h5 class="mt-4 mb-3 text-primary">Produtos cadastrados</h5>
        <table class="table table-striped align-middle">
            <thead class="table-light">
            <tr>
                <th>Produto</th>
                <th>Pre√ßo Venda</th>
                <th>Estoque Atual</th>
                <th>Unidade</th>
                <th width="180">A√ß√µes</th>
            </tr>
            </thead>
            <tbody>
            {% for p in produtos %}
                <tr>
                    <td>{{ p.nome }}</td>
                    <td>R$ {{ p.precoVenda|number_format(2, ',', '.') }}</td>
                    <td><span class="badge bg-info">{{ p.estoqueAtual }}</span></td>
                    <td>{{ p.unidade|default('un') }}</td>
                    <td>
                        <form method="post" action="{{ path('clinica_estoque_entrada', {'id': p.id}) }}" class="d-flex">
                            <input type="number" name="quantidade" class="form-control form-control-sm me-2" min="1"
                                   placeholder="+QTD">
                            <button class="btn btn-sm btn-success"><i class="bi bi-arrow-up"></i></button>
                        </form>
                        <a href="{{ path('clinica_estoque_movimentos', {'id': p.id}) }}"
                           class="btn btn-sm btn-outline-secondary mt-1 w-100">
                            <i class="fas fa-history"></i> Mov.
                        </a>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">Nenhum produto cadastrado.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% block javascripts %}
    <script>
        function initBootstrapUI(container) {
            container = container || $(document);

            container.find('[data-bs-toggle="tab"]').each(function () {
                new bootstrap.Tab(this);
            });
        }


        $(function () {
            $('.novoProd').on('click', function () {
                var modal = Utils.modal($('.formProd').html(), 'secondary', function () {
                    Utils.modal('Aten√ß√£o, voc√™ est√° executando um formulario sem fazer os devidos tratamentos de seus campos.')
                }, 'lg');
                

                // $('#'+modal.id+'.modal .nav-tabs button').on('click', function (e) {
                //     e.preventDefault();
                // });

                return false;
            });
            
            $('.modal').on('shown.bs.modal', function () {
                initBootstrapUI($(this));
            });
        });
    </script>
{% endblock %}