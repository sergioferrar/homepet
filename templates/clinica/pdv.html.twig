{% extends 'base.html.twig' %}
{% block title %}PDV - Ponto de Venda{% endblock %}
{% block page_title %}Ponto de Venda{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}

{% block body %}
    <style>
    /* Estilos do PDV */
    .pdv-container {
        background-color: #fff;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .autocomplete-suggestions {
        position: absolute;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 100%;
    }

    .autocomplete-suggestion {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
    }

    .autocomplete-suggestion:hover {
        background-color: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .item-carrinho {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 0.75rem;
        background-color: #f8f9fa;
        transition: all 0.2s;
    }

    .item-carrinho:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .resumo-venda {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.375rem;
        border: 2px solid #dee2e6;
    }

    .total-valor {
        font-size: 2rem;
        font-weight: bold;
        color: #0d6efd;
    }

    .troco-valor {
        font-size: 1.5rem;
        font-weight: bold;
        color: #198754;
    }

    .badge-produto {
        background-color: #0d6efd;
    }

    .badge-servico {
        background-color: #6f42c1;
    }

    .btn-remover-item {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .quantidade-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .quantidade-controls input {
        width: 60px;
        text-align: center;
    }

    .quantidade-controls button {
        padding: 0.25rem 0.5rem;
    }

    #carrinhoItens {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
    }

    .empty-cart {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-cart i {
        font-size: 4rem;
        opacity: 0.3;
    }
</style>
<div class="container-fluid">
    <div class="pagetitle">
        <h1>Ponto de Venda</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url('home') }}">Home</a></li>
                <li class="breadcrumb-item">Atendimento</li>
                <li class="breadcrumb-item active">PDV</li>
            </ol>
        </nav>
    </div>

    <div class="pdv-container">
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0"><i class="bi bi-cart-check text-primary"></i> Ponto de Venda</h3>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{{ path('clinica_estoque_index') }}" class="btn btn-outline-secondary d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i> Estoque
                </a>
                <a href="{{ path('clinica_pdv_listar') }}" class="btn btn-outline-info d-flex align-items-center">
                    <i class="bi bi-card-checklist me-2"></i> Listagem
                </a>
                <button class="btn btn-outline-danger d-flex align-items-center" id="btnSaidaHeader">
                    <i class="bi bi-box-arrow-up me-2"></i> Registrar Saída
                </button>
                <a href="{{ path('clinica_pdv_caixa') }}" class="btn btn-outline-success d-flex align-items-center">
                    <i class="bi bi-wallet2 me-2"></i> Caixa
                </a>
            </div>
        </div>

        <hr class="mb-4">

        <div class="row g-4">
            <!-- Coluna Esquerda: Seleção e Carrinho -->
            <div class="col-lg-7">
                <!-- Cliente/Tutor -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Cliente/Tutor:</label>
                    <div class="position-relative">
                        <input type="text" 
                               id="inputTutor" 
                               class="form-control" 
                               placeholder="Digite o nome do cliente..."
                               autocomplete="off"
                               value="{{ vendaPreCarregada is not null ? vendaPreCarregada.cliente_nome : '' }}">
                        <div id="autocompleteTutor" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>
                    <small class="text-muted">Opcional - deixe em branco para "Consumidor Final"</small>
                </div>

                <!-- Pet (opcional) -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Pet:</label>
                    <select id="petSelect" class="form-select" {% if vendaPreCarregada is null or vendaPreCarregada.pet_id is null %}disabled{% endif %}>
                        {% if vendaPreCarregada is not null and vendaPreCarregada.pet_id is not null %}
                            <option value="">Nenhum (venda avulsa)</option>
                            <option value="{{ vendaPreCarregada.pet_id }}" selected>{{ vendaPreCarregada.pet_nome }}</option>
                        {% else %}
                            <option value="">Selecione um cliente primeiro</option>
                        {% endif %}
                    </select>
                    <small class="text-muted">Opcional - selecione se a venda for para um pet</small>
                </div>

                <!-- Produtos/Serviços -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Adicionar Produto/Serviço:</label>
                    <div class="input-group position-relative">
                        <input type="text" 
                               id="inputProduto" 
                               class="form-control" 
                               placeholder="Digite o nome do produto ou serviço..."
                               autocomplete="off">
                        <button class="btn btn-primary" id="btnAddProduto" type="button">
                            <i class="bi bi-plus-lg"></i> Adicionar
                        </button>
                        <div id="autocompleteProduto" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>
                </div>

                <!-- Carrinho de Itens -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-cart3"></i> Itens da Venda</h5>
                    </div>
                    <div class="card-body" id="carrinhoItens">
                        <div class="empty-cart">
                            <i class="bi bi-cart-x"></i>
                            <p class="mt-3">Nenhum item adicionado</p>
                            <small>Pesquise e adicione produtos ou serviços acima</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Resumo e Pagamento -->
            <div class="col-lg-5">
                <div class="resumo-venda">
                    <h4 class="mb-3"><i class="bi bi-calculator"></i> Resumo da Venda</h4>

                    <!-- Subtotal -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-bold" id="subtotalValor">R$ 0,00</span>
                    </div>

                    <!-- Desconto -->
                    <div class="mb-3">
                        <label class="form-label">Desconto (R$):</label>
                        <input type="number" 
                               id="desconto" 
                               class="form-control" 
                               value="0" 
                               min="0" 
                               step="0.01">
                    </div>

                    <!-- Total -->
                    <div class="d-flex justify-content-between align-items-center mb-3 pt-3 border-top">
                        <span class="fs-5 fw-bold">Total:</span>
                        <span class="total-valor" id="totalValor">R$ 0,00</span>
                    </div>

                    <!-- Método de Pagamento -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Método de Pagamento:</label>
                        <select id="metodo" class="form-select">
                            <option value="dinheiro">Dinheiro</option>
                            <option value="debito">Débito</option>
                            <option value="credito">Crédito</option>
                            <option value="pix">PIX</option>
                            <option value="pendente">Pendente</option>
                        </select>
                    </div>

                    <!-- Opções de Cartão (oculto por padrão) -->
                    <div id="opcoesCartao" class="mb-3" style="display: none;">
                        <label class="form-label">Bandeira do Cartão:</label>
                        <select id="bandeiraCartao" class="form-select mb-2">
                            <option value="">Selecione...</option>
                            <option value="visa">Visa</option>
                            <option value="mastercard">Mastercard</option>
                            <option value="elo">Elo</option>
                            <option value="amex">American Express</option>
                        </select>

                        <label class="form-label">Parcelas:</label>
                        <select id="parcelas" class="form-select">
                            <option value="1">1x sem juros</option>
                            <option value="2">2x sem juros</option>
                            <option value="3">3x sem juros</option>
                            <option value="4">4x</option>
                            <option value="5">5x</option>
                            <option value="6">6x</option>
                        </select>
                    </div>

                    <!-- Valor Recebido (apenas para dinheiro) -->
                    <div id="opcoesDinheiro" class="mb-3">
                        <label class="form-label">Valor Recebido (R$):</label>
                        <input type="number" 
                               id="valorRecebido" 
                               class="form-control" 
                               value="0" 
                               min="0" 
                               step="0.01">
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="fw-bold">Troco:</span>
                            <span class="troco-valor" id="trocoValor">R$ 0,00</span>
                        </div>
                    </div>

                    <!-- Observação -->
                    <div class="mb-3">
                        <label class="form-label">Observação:</label>
                        <textarea id="observacao" 
                                  class="form-control" 
                                  rows="2" 
                                  placeholder="Informações adicionais..."></textarea>
                    </div>

                    <!-- Botão Finalizar -->
                    <button id="btnSalvarVenda" class="btn btn-success w-100 btn-sm">
                        <i class="bi bi-check-circle"></i> Salvar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container para Toast Notifications -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
    <div id="toastContainer"></div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==================== DADOS INICIAIS ====================
const produtos = {{ produtos|json_encode|raw }};
const clientes = {{ clientes|json_encode|raw }};

{# Dados da venda pré-carregada vinda da clínica (null se acesso normal) #}
{% if vendaPreCarregada is not null %}
const vendaPreCarregadaJS = {{ vendaPreCarregada|json_encode|raw }};
{% else %}
const vendaPreCarregadaJS = null;
{% endif %}

// Debug - você pode remover após confirmar que está funcionando
console.log('=== DEBUG PDV ===');
console.log('Total de produtos:', produtos.length);
console.log('Total de clientes:', clientes.length);
console.log('Exemplo de produto:', produtos[0]);
console.log('Exemplo de cliente:', clientes[0]);

// Estado da aplicação
let clienteSelecionado = null;
let petSelecionado = null;
let carrinhoItens = [];

// ==================== INICIALIZAÇÃO ====================
$(document).ready(function() {
    inicializarEventos();
    atualizarResumo();

    // Pré-carrega itens da clínica no carrinho (se houver)
    if (vendaPreCarregadaJS && vendaPreCarregadaJS.itens && vendaPreCarregadaJS.itens.length > 0) {
        vendaPreCarregadaJS.itens.forEach(function(item) {
            carrinhoItens.push({
                id:        item.id,
                nome:      item.nome,
                valor:     parseFloat(item.valor_unitario),
                quantidade: parseInt(item.quantidade, 10),
                tipo:      item.tipo,
                estoque:   null
            });
        });

        // Preenche o estado do cliente/pet para o JS
        clienteSelecionado = { id: null, nome: vendaPreCarregadaJS.cliente_nome };
        petSelecionado     = vendaPreCarregadaJS.pet_id || null;

        renderizarCarrinho();
        atualizarResumo();
        showToast('Venda #' + vendaPreCarregadaJS.venda_id + ' carregada da clínica!', 'success');
    }
});

// ==================== FUNÇÕES DE TOAST ====================
function showToast(mensagem, tipo = 'info') {
    const bgClass = {
        'success': 'bg-success',
        'danger': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[tipo] || 'bg-info';

    const toast = $(`
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${mensagem}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);

    $('#toastContainer').append(toast);
    const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
    bsToast.show();

    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// ==================== AUTOCOMPLETE TUTOR/CLIENTE ====================
let timeoutTutor = null;

function inicializarAutocompleteTutor() {
    const $input = $('#inputTutor');
    const $autocomplete = $('#autocompleteTutor');

    $input.on('input', function() {
        clearTimeout(timeoutTutor);
        const termo = $(this).val().trim();

        if (termo.length < 2) {
            $autocomplete.hide().empty();
            return;
        }

        timeoutTutor = setTimeout(function() {
            const termoLower = termo.toLowerCase();
            const resultados = clientes.filter(function(c) {
                return c.nome.toLowerCase().includes(termoLower);
            });

            $autocomplete.empty();

            if (resultados.length > 0) {
                resultados.forEach(function(cliente) {
                    const $item = $('<div>')
                        .addClass('autocomplete-suggestion')
                        .html(`
                            <strong>${cliente.nome}</strong>
                            ${cliente.telefone ? `<br><small class="text-muted">${cliente.telefone}</small>` : ''}
                        `)
                        .on('click', function() {
                            selecionarCliente(cliente);
                        });
                    $autocomplete.append($item);
                });
                $autocomplete.show();
            } else {
                $autocomplete.html('<div class="autocomplete-suggestion">Nenhum cliente encontrado</div>').show();
            }
        }, 300);
    });

    // Fechar ao clicar fora
    $(document).on('click', function(e) {
        if (!$input.is(e.target) && !$autocomplete.is(e.target)) {
            $autocomplete.hide();
        }
    });
}

function selecionarCliente(cliente) {
    clienteSelecionado = cliente;
    $('#inputTutor').val(cliente.nome);
    $('#autocompleteTutor').hide();

    // Buscar pets do cliente
    carregarPetsDoCliente(cliente.id);
}

function carregarPetsDoCliente(clienteId) {
    $.ajax({
        url: '{{ path("clinica_pets_by_tutor", {"id": "ID_PLACEHOLDER"}) }}'.replace('ID_PLACEHOLDER', clienteId),
        method: 'GET',
        success: function(pets) {
            const $petSelect = $('#petSelect');
            $petSelect.empty().append('<option value="">Nenhum (venda avulsa)</option>');

            pets.forEach(pet => {
                $petSelect.append($('<option>').val(pet.id).text(pet.nome));
            });

            $petSelect.prop('disabled', false);
        },
        error: function() {
            showToast('Erro ao carregar pets do cliente', 'danger');
        }
    });
}

$('#petSelect').on('change', function() {
    petSelecionado = $(this).val() || null;
});

// ==================== AUTOCOMPLETE PRODUTO ====================
let timeoutProduto = null;

function inicializarAutocompleteProduto() {
    const $input = $('#inputProduto');
    const $autocomplete = $('#autocompleteProduto');

    $input.on('input', function() {
        clearTimeout(timeoutProduto);
        const termo = $(this).val().trim();

        if (termo.length < 2) {
            $autocomplete.hide().empty();
            return;
        }

        timeoutProduto = setTimeout(function() {
            const termoLower = termo.toLowerCase();
            const resultados = produtos.filter(function(p) {
                return p.nome.toLowerCase().includes(termoLower);
            });

            $autocomplete.empty();

            if (resultados.length > 0) {
                resultados.forEach(function(produto) {
                    const badge = produto.tipo === 'Produto' 
                        ? '<span class="badge badge-produto">Produto</span>' 
                        : '<span class="badge badge-servico">Serviço</span>';
                    
                    const estoqueTexto = (produto.estoque !== null && produto.estoque !== undefined)
                        ? ` | Estoque: ${produto.estoque}` 
                        : '';

                    const $item = $('<div>')
                        .addClass('autocomplete-suggestion')
                        .html(`
                            ${badge} ${produto.nome} - <strong>R$ ${formatarMoeda(produto.valor)}</strong>${estoqueTexto}
                        `)
                        .on('click', function() {
                            adicionarItemCarrinho(produto);
                        });
                    $autocomplete.append($item);
                });
                $autocomplete.show();
            } else {
                $autocomplete.html('<div class="autocomplete-suggestion">Nenhum produto/serviço encontrado</div>').show();
            }
        }, 300);
    });

    $('#btnAddProduto').on('click', function() {
        const termo = $input.val().trim().toLowerCase();
        const produto = produtos.find(function(p) {
            return p.nome.toLowerCase() === termo;
        });

        if (produto) {
            adicionarItemCarrinho(produto);
        } else {
            showToast('Produto não encontrado', 'warning');
        }
    });

    // Fechar ao clicar fora
    $(document).on('click', function(e) {
        if (!$input.is(e.target) && !$autocomplete.is(e.target)) {
            $autocomplete.hide();
        }
    });
}

// ==================== GERENCIAMENTO DO CARRINHO ====================
function adicionarItemCarrinho(produto) {
    // Verifica se já existe no carrinho
    const itemExistente = carrinhoItens.find(item => item.id === produto.id);

    if (itemExistente) {
        // Se for produto, verifica estoque
        if (produto.tipo === 'Produto' && produto.estoque !== null && produto.estoque !== undefined) {
            if (itemExistente.quantidade >= produto.estoque) {
                showToast('Estoque insuficiente!', 'warning');
                return;
            }
        }
        itemExistente.quantidade++;
    } else {
        // Adiciona novo item
        carrinhoItens.push({
            id: produto.id,
            nome: produto.nome,
            valor: parseFloat(produto.valor),
            quantidade: 1,
            tipo: produto.tipo,
            estoque: produto.estoque
        });
    }

    $('#inputProduto').val('');
    $('#autocompleteProduto').hide();
    
    renderizarCarrinho();
    atualizarResumo();
    showToast('Item adicionado ao carrinho', 'success');
}

function removerItemCarrinho(itemId) {
    carrinhoItens = carrinhoItens.filter(item => item.id !== itemId);
    renderizarCarrinho();
    atualizarResumo();
    showToast('Item removido', 'info');
}

function alterarQuantidade(itemId, novaQuantidade) {
    const item = carrinhoItens.find(i => i.id === itemId);
    
    if (!item) return;

    if (novaQuantidade <= 0) {
        removerItemCarrinho(itemId);
        return;
    }

    // Verifica estoque se for produto
    if (item.tipo === 'Produto' && item.estoque !== null) {
        if (novaQuantidade > item.estoque) {
            showToast('Estoque insuficiente!', 'warning');
            return;
        }
    }

    item.quantidade = novaQuantidade;
    renderizarCarrinho();
    atualizarResumo();
}

function renderizarCarrinho() {
    const $container = $('#carrinhoItens');
    $container.empty();

    if (carrinhoItens.length === 0) {
        $container.html(`
            <div class="empty-cart">
                <i class="bi bi-cart-x"></i>
                <p class="mt-3">Nenhum item adicionado</p>
                <small>Pesquise e adicione produtos ou serviços acima</small>
            </div>
        `);
        return;
    }

    carrinhoItens.forEach(item => {
        const badge = item.tipo === 'Produto' 
            ? '<span class="badge badge-produto">Produto</span>' 
            : '<span class="badge badge-servico">Serviço</span>';

        const subtotal = item.quantidade * item.valor;

        const $itemDiv = $(`
            <div class="item-carrinho">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        ${badge}
                        <h6 class="mb-1 mt-1">${item.nome}</h6>
                        <small class="text-muted">R$ ${formatarMoeda(item.valor)} cada</small>
                    </div>
                    <button class="btn btn-sm btn-danger btn-remover-item" data-id="${item.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="quantidade-controls">
                        <button class="btn btn-sm btn-outline-secondary btn-decrementar" data-id="${item.id}">
                            <i class="bi bi-dash"></i>
                        </button>
                        <input type="number" 
                               class="form-control form-control-sm input-quantidade" 
                               data-id="${item.id}"
                               value="${item.quantidade}" 
                               min="1"
                               ${item.estoque !== null ? `max="${item.estoque}"` : ''}>
                        <button class="btn btn-sm btn-outline-secondary btn-incrementar" data-id="${item.id}">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <strong>R$ ${formatarMoeda(subtotal)}</strong>
                </div>
            </div>
        `);

        $container.append($itemDiv);
    });

    // Eventos dos botões
    $('.btn-remover-item').on('click', function() {
        const itemId = $(this).data('id');
        removerItemCarrinho(itemId);
    });

    $('.btn-incrementar').on('click', function() {
        const itemId = $(this).data('id');
        const item = carrinhoItens.find(i => i.id === itemId);
        alterarQuantidade(itemId, item.quantidade + 1);
    });

    $('.btn-decrementar').on('click', function() {
        const itemId = $(this).data('id');
        const item = carrinhoItens.find(i => i.id === itemId);
        alterarQuantidade(itemId, item.quantidade - 1);
    });

    $('.input-quantidade').on('change', function() {
        const itemId = $(this).data('id');
        const novaQuantidade = parseInt($(this).val());
        alterarQuantidade(itemId, novaQuantidade);
    });
}

// ==================== CÁLCULOS ====================
function calcularSubtotal() {
    return carrinhoItens.reduce((total, item) => {
        return total + (item.quantidade * item.valor);
    }, 0);
}

function atualizarResumo() {
    const subtotal = calcularSubtotal();
    const desconto = parseFloat($('#desconto').val()) || 0;
    const total = Math.max(0, subtotal - desconto);
    const valorRecebido = parseFloat($('#valorRecebido').val()) || 0;
    const troco = Math.max(0, valorRecebido - total);

    $('#subtotalValor').text('R$ ' + formatarMoeda(subtotal));
    $('#totalValor').text('R$ ' + formatarMoeda(total));
    $('#trocoValor').text('R$ ' + formatarMoeda(troco));
}

function formatarMoeda(valor) {
    return parseFloat(valor).toFixed(2).replace('.', ',');
}

// ==================== EVENTOS GERAIS ====================
function inicializarEventos() {
    inicializarAutocompleteTutor();
    inicializarAutocompleteProduto();

    // Atualizar cálculos
    $('#desconto, #valorRecebido').on('input', atualizarResumo);

    // Método de pagamento
    $('#metodo').on('change', function() {
        const metodo = $(this).val();

        if (metodo === 'credito' || metodo === 'debito') {
            $('#opcoesCartao').show();
            $('#opcoesDinheiro').hide();
        } else if (metodo === 'dinheiro') {
            $('#opcoesCartao').hide();
            $('#opcoesDinheiro').show();
        } else {
            $('#opcoesCartao').hide();
            $('#opcoesDinheiro').hide();
        }
    });

    // Salvar venda
    $('#btnSalvarVenda').on('click', salvarVenda);
}

// ==================== SALVAR VENDA ====================
async function salvarVenda() {
    // Validações
    if (carrinhoItens.length === 0) {
        showToast('Adicione pelo menos um item à venda!', 'warning');
        return;
    }

    const metodo = $('#metodo').val();
    const subtotal = calcularSubtotal();
    const desconto = parseFloat($('#desconto').val()) || 0;
    const total = Math.max(0, subtotal - desconto);

    if (total <= 0) {
        showToast('O total da venda deve ser maior que zero!', 'warning');
        return;
    }

    // Validar cartão
    if ((metodo === 'credito' || metodo === 'debito') && !$('#bandeiraCartao').val()) {
        showToast('Selecione a bandeira do cartão!', 'warning');
        return;
    }

    // Preparar dados
    const dados = {
        itens: carrinhoItens.map(item => ({
            id: item.id,
            nome: item.nome,
            quantidade: item.quantidade,
            valor: item.valor,
            tipo: item.tipo
        })),
        total: total,
        metodo: metodo,
        origem: 'PDV',
        cliente_id: clienteSelecionado ? clienteSelecionado.id : null,
        pet_id: petSelecionado,
        bandeira: $('#bandeiraCartao').val() || null,
        parcelas: parseInt($('#parcelas').val()) || null,
        troco: metodo === 'dinheiro' ? (parseFloat($('#valorRecebido').val()) - total) : null,
        observacao: $('#observacao').val().trim() || null
    };

    // Desabilitar botão
    const $btn = $('#btnSalvarVenda');
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Salvando...');

    try {
        const response = await $.ajax({
            url: '{{ path("clinica_pdv_registrar") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dados)
        });

        if (response.ok) {
            showToast('Venda registrada com sucesso!', 'success');
            
            // Limpar formulário
            setTimeout(function() {
                limparFormulario();
                location.reload();
            }, 1500);
        } else {
            showToast(response.msg || 'Erro ao salvar venda', 'danger');
            $btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> Salvar Venda');
        }
    } catch (error) {
        console.error('Erro:', error);
        const mensagem = error.responseJSON?.msg || 'Erro ao comunicar com o servidor';
        showToast(mensagem, 'danger');
        $btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> Salvar Venda');
    }
}

function limparFormulario() {
    carrinhoItens = [];
    clienteSelecionado = null;
    petSelecionado = null;
    
    $('#inputTutor').val('');
    $('#inputProduto').val('');
    $('#petSelect').empty().append('<option value="">Selecione um cliente primeiro</option>').prop('disabled', true);
    $('#desconto').val(0);
    $('#valorRecebido').val(0);
    $('#observacao').val('');
    $('#metodo').val('dinheiro').trigger('change');
    
    renderizarCarrinho();
    atualizarResumo();
}
</script>
{% endblock %}
