{% extends 'base.html.twig' %}
{% block title %}PDV - Ponto de Venda{% endblock %}
{% block page_title %}Ponto de Venda{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    
{% endblock %}

{% block body %}
    <style>
/* Container do autocomplete (opcional, mas recomendado) */
#autocomplete-tutor, #autocomplete-list {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-top: -2px;
    background-color: #fff;
    max-height: 220px;
    overflow-y: auto;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
    z-index: 1000;
}

/* Item da sugest√£o */
.autocomplete-suggestion {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid #f1f1f1;
    font-size: 14px;
    transition: background-color .2s ease;
}

/* Remove a borda do √∫ltimo item */
.autocomplete-suggestion:last-child {
    border-bottom: none;
}

/* Hover */
.autocomplete-suggestion:hover {
    background-color: #f8f9fa;
}
#petSelect:disabled {
    background-color: #f8f9fa;
    cursor: not-allowed;
    opacity: 0.8;
}
    </style>
    <div class="container-fluid ">
        <div class="pagetitle">
            <h1>Ponto de Venda</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url('home') }}">Home</a></li>
                    <li class="breadcrumb-item">Atendimento</li>
                    <li class="breadcrumb-item active">PDF - Venda</li>
                </ol>
            </nav>
        </div>
        <div class="bg-white p-4 mt-4 rounded shadow-sm pdv">
            <!-- üîπ Cabe√ßalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0"><i class="bi bi-cash me-2"></i> Ponto de Venda</h3>
                <div class="d-flex gap-2">
                    <a href="{{ path('clinica_estoque_index') }}" class="btn btn-outline-dark">
                        <i class="bi bi-box-seam"></i> Estoque
                    </a>
                    <a href="{{ path('clinica_pdv_listar') }}" class="btn btn-outline-primary">
                        <i class="bi bi-card-checklist"></i> Listagem
                    </a>
                    <button class="btn btn-outline-danger" id="btnSaidaHeader">
                        <i class="bi bi-upload"></i> Registrar Sa√≠da
                    </button>
                    <a href="{{ path('clinica_pdv_caixa') }}" class="btn btn-outline-success">
                        <i class="bi bi-wallet2"></i> Caixa
                    </a>
                </div>
            </div>
            <hr>

            <!-- üîπ Tutor/Cliente -->
            <div class="mb-3 position-relative">
                <label class="fw-bold mb-2">Tutor/Cliente:</label>
                <input type="text" id="inputTutor" class="form-control" autocomplete="false" placeholder="Comece a digitar o nome...">
                <div id="autocomplete-tutor" class="autocomplete-suggestions"></div>
            </div>

            <!-- üêï Pet (opcional) -->
            <div class="mb-3">
                <label class="fw-bold mb-2">Pet <small class="text-muted">(opcional - para aparecer na
                        ficha)</small>:</label>
                <select id="petSelect" class="form-select" disabled>
                    <option value="">Selecione um cliente primeiro</option>
                </select>
            </div>

            <div class="row">
                <!-- Coluna esquerda -->
                <div class="col-md-8 position-relative">

                    <!-- üîç Campo de produto com autocomplete -->
                    <div class="d-flex mb-3">
                        <input type="text" id="inputProduto" class="form-control me-2"
                               placeholder="Digite o nome do produto ou servi√ßo...">
                        <button class="btn btn-primary" id="btnAddProduto"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div id="autocomplete-list" class="autocomplete-suggestions"></div>

                    <table class="table table-sm table-striped align-middle" id="tabelaItens">
                        <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th width="90">Qtd</th>
                            <th width="100">Pre√ßo</th>
                            <th width="100">Subtotal</th>
                            <th width="50"></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Coluna direita -->
                <div class="col-md-4 border-start">
                    <h5>Resumo</h5>
                    <p>Itens: <span id="totalItens">0</span></p>
                    <p>Total: <strong id="totalVenda">R$ 0,00</strong></p>

                    <div class="mb-3">
                        <label>Forma de Pagamento:</label>
                        <select id="metodo" class="form-select">
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="credito">Cart√£o Cr√©dito</option>
                            <option value="debito">Cart√£o D√©bito</option>
                            <option value="pendente">Fiado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Desconto (%):</label>
                        <input type="number" id="desconto" min="0" max="100" value="0" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label>Valor Recebido:</label>
                        <input type="number" step="0.01" id="valorRecebido" class="form-control">
                    </div>

                    <div class="border-top pt-2">
                        <p><strong>Total com desconto:</strong> R$ <span id="totalComDesconto">0,00</span></p>
                        <p class="fw-bold text-success">Troco: R$ <span id="valorTroco">0,00</span></p>
                    </div>

                    <div class="mb-3">
                        <label>Origem da Venda:</label>
                        <select name="origem" id="origem" class="form-select">
                            <option value="clinica">Cl√≠nica Veterin√°ria</option>
                            <option value="banho_tosa">Banho e Tosa</option>
                            <option value="hospedagem">Hospedagem</option>
                        </select>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-success w-100" id="btnFinalizar">
                            <i class="bi bi-check-lg"></i> Finalizar Venda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Modal Sa√≠da -->
    <div class="modal fade" id="modalSaida" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Sa√≠da</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>Descri√ß√£o:</label>
                    <input type="text" id="saidaDescricao" class="form-control mb-3" placeholder="Ex: Compra de caf√©">
                    <label>Valor (R$):</label>
                    <input type="number" step="0.01" id="saidaValor" class="form-control mb-3">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-danger" id="confirmarSaida">Registrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>

        $('.search-bar').addClass('d-none');


        const produtos = {{ produtos|json_encode|raw }};
        let itens = [];
        let tutorSelecionado = null;

        // ==================== TOAST ====================
        function showToast(msg, tipo = 'info') {
            Notify.toast(msg, tipo, 5000);
            // const cor = tipo === 'success' ? 'alert-success' : tipo === 'error' ? 'alert-danger' : 'alert-warning';
            // const toast = document.createElement('div');
            // toast.className = `alert ${cor} position-fixed top-0 end-0 m-3 shadow`;
            // toast.innerHTML = msg;
            // document.body.appendChild(toast);
            // setTimeout(() => toast.remove(), 3000);
        }

        // ==================== TABELA ====================
        function atualizarTabela() {
            const tbody = document.querySelector('#tabelaItens tbody');
            tbody.innerHTML = '';
            let total = 0;
            itens.forEach((item, i) => {
                const subtotal = item.quantidade * item.valor;
                total += subtotal;
                tbody.innerHTML += `
            <tr>
                <td>${item.nome}</td>
                <td><input type="number" min="1" value="${item.quantidade}" class="form-control form-control-sm" onchange="alterarQtd(${i}, this.value)"></td>
                <td>R$ ${item.valor.toFixed(2)}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="remover(${i})"><i class="bi bi-x-circle"></i></button></td>
            </tr>`;
            });
            document.getElementById('totalVenda').innerText = 'R$ ' + total.toFixed(2);
            document.getElementById('totalItens').innerText = itens.length;
        }

        function alterarQtd(i, qtd) {
            itens[i].quantidade = parseInt(qtd);
            atualizarTabela();
        }

        function remover(i) {
            itens.splice(i, 1);
            atualizarTabela();
        }
    const $inputProduto = $('#inputProduto');
    const $list         = $('#autocomplete-list');
    const $btnAdd       = $('#btnAddProduto');

    // Autocomplete
    $inputProduto.on('input', function () {
        const termo = $.trim($(this).val()).toLowerCase();

        $list.empty();

        if (!termo || termo.length < 1) {
            return;
        }

        const filtrados = produtos.filter(function (p) {
            return p.nome.toLowerCase().includes(termo);
        });

        $.each(filtrados, function (_, p) {
            $('<div>', {
                class: 'autocomplete-suggestion',
                text: `${p.nome} ‚Äî R$ ${p.valor.toFixed(2)}`
            })
            .on('click', function () {
                adicionarProduto(p);
                $inputProduto.val('');
                $list.empty();
            })
            .appendTo($list);
        });
    });

    // Bot√£o adicionar produto
    $btnAdd.on('click', function () {
        const termo = $.trim($inputProduto.val()).toLowerCase();

        if (!termo) {
            showToast('Informe um produto', 'warning');
            return;
        }

        const produto = produtos.find(function (p) {
            return p.nome.toLowerCase() === termo;
        });

        if (produto) {
            adicionarProduto(produto);
            $inputProduto.val('');
            $list.empty();
        } else {
            showToast('Produto n√£o encontrado!', 'danger');
        }
    });

// ==================== ADICIONAR PRODUTO ====================
function adicionarProduto(p) {
    const existente = itens.find(function (i) {
        return i.id === p.id;
    });

    if (existente) {
        existente.quantidade++;
    } else {
        itens.push({
            id: p.id,
            nome: p.nome,
            valor: p.valor,
            quantidade: 1,
            tipo: p.tipo
        });
    }

    atualizarTabela();
}

        const $inputTutor  = $('#inputTutor');
    const $listaTutor  = $('#autocomplete-tutor');
    const $petSelect   = $('#petSelect');

    $inputTutor.on('input', function () {
        const termo = $.trim($(this).val()).toLowerCase();

        // Reset estado
        $listaTutor.empty();
        tutorSelecionado = null;

        // Limpar pets quando mudar cliente
        $petSelect
            .html('<option value="">Selecione um cliente primeiro</option>')
            .prop('disabled', true);

        if (termo.length < 2) {
            return;
        }

        $.ajax({
            url: '{{ path("clinica_pdv_clientes_listar") }}',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                const clientes   = data.results || [];
                const filtrados  = clientes.filter(function (c) {
                    return c.text.toLowerCase().includes(termo);
                });

                $.each(filtrados, function (_, c) {
                    $('<div>', {
                        class: 'autocomplete-suggestion',
                        text: c.text
                    })
                    .on('click', function () {
                        $inputTutor.val(c.text);
                        tutorSelecionado = c.id;
                        $listaTutor.empty();
                        carregarPetsDoCliente(c.id);
                    })
                    .appendTo($listaTutor);
                });
            },
            error: function (xhr, status, error) {
                console.error('Erro ao carregar tutores:', error);
            }
        });
    });

       // ==================== CARREGAR PETS DO CLIENTE (jQuery) ====================
    function carregarPetsDoCliente(clienteId) {
        const $petSelect = $('#petSelect');
        const baseUrl = $('meta[name="base"]').attr('content');

        // Nenhum cliente selecionado
        if (!clienteId) {
            $petSelect
                .html('<option value="">Selecione um cliente primeiro</option>')
                .prop('disabled', true);
            return;
        }

        // Loading
        $petSelect
            .html('<option value="">Carregando pets...</option>')
            .prop('disabled', true);

        $.ajax({
            url: `${baseUrl}/orcamento/api/cliente/${clienteId}/pets`,
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                // Nenhum pet
                if (!data.success || !data.pets || data.pets.length === 0) {
                    $petSelect.html('<option value="">Nenhum pet cadastrado</option>');
                    return;
                }

                // Op√ß√£o padr√£o
                $petSelect.html('<option value="">Nenhum (venda geral)</option>');

                $.each(data.pets, function (_, pet) {
                    const info = (pet.especie || pet.raca)
                        ? ` (${pet.especie || ''}${pet.especie && pet.raca ? ' - ' : ''}${pet.raca || ''})`
                        : '';

                    $('<option>', {
                        value: pet.id,
                        text: `${pet.nome}${info}`
                    }).appendTo($petSelect);
                });

                $petSelect.prop('disabled', false);
            },
            error: function (xhr, status, error) {
                console.error('Erro ao carregar pets:', error);
                $petSelect.html('<option value="">Erro ao carregar pets</option>');
            }
        });
    }


        // document.addEventListener('click', e => {
        //     if (!listaTutor.contains(e.target) && e.target !== inputTutor) listaTutor.innerHTML = '';
        // });

        // ==================== CALCULAR TROCO ====================
        function atualizarResumo() {
            const total = itens.reduce((s, i) => s + i.valor * i.quantidade, 0);
            const desconto = parseFloat(document.getElementById('desconto').value || 0);
            const totalDesc = total - (total * desconto / 100);
            const recebido = parseFloat(document.getElementById('valorRecebido').value || 0);
            const troco = recebido - totalDesc;
            document.getElementById('totalComDesconto').innerText = totalDesc.toFixed(2);
            document.getElementById('valorTroco').innerText = troco.toFixed(2);
        }

        document.getElementById('desconto').addEventListener('input', atualizarResumo);
        document.getElementById('valorRecebido').addEventListener('input', atualizarResumo);

        // ==================== FINALIZAR VENDA (jQuery) ====================
$(function () {
    $('#btnFinalizar').on('click', function () {

        // 1Ô∏è‚É£ Valida√ß√£o b√°sica
        if (!itens || itens.length === 0) {
            showToast('Nenhum item na venda.', 'warning');
            return;
        }

        const metodo      = $('#metodo').val();
        const cliente_id  = tutorSelecionado || null;
        const pet_id      = $('#petSelect').val() || null;
        const desconto    = parseFloat($('#desconto').val()) || 0;
        const recebido    = parseFloat($('#valorRecebido').val()) || 0;
        const origem      = $('#origem').val() || 'clinica';

        // 2Ô∏è‚É£ C√°lculo de totais (seguro)
        const total = itens.reduce(function (s, i) {
            return s + (parseFloat(i.valor) * parseInt(i.quantidade));
        }, 0);

        const totalDesc = Math.max(total - (total * desconto / 100), 0);
        const troco     = Math.max(recebido - totalDesc, 0);

        // 3Ô∏è‚É£ Valida√ß√µes cr√≠ticas de PDV
        if (!metodo) {
            showToast('Selecione a forma de pagamento.', 'warning');
            return;
        }

        if (recebido < totalDesc && metodo !== 'credito') {
            showToast('Valor recebido insuficiente.', 'danger');
            return;
        }

        // 4Ô∏è‚É£ Payload
        const payload = {
            metodo: metodo,
            cliente_id: cliente_id,
            pet_id: pet_id,
            total: totalDesc,
            desconto: desconto,
            itens: itens,
            troco: troco,
            origem: origem
        };

        // 5Ô∏è‚É£ Envio
        $.ajax({
            url: '{{ path("clinica_pdv_registrar") }}',
            method: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(payload),
            success: function (json) {
                showToast(json.msg, json.ok ? 'success' : 'danger');

                if (json.ok) {
                    setTimeout(function () {
                        location.reload();
                    }, 2000);
                }
            },
            error: function () {
                showToast('Erro ao comunicar com o servidor.', 'danger');
            }
        });
    });
});


        // ==================== SA√çDA DE DINHEIRO ====================
        document.getElementById('btnSaidaHeader').addEventListener('click', () => {
            new bootstrap.Modal(document.getElementById('modalSaida')).show();
        });
        document.getElementById('confirmarSaida').addEventListener('click', async () => {
            const descricao = document.getElementById('saidaDescricao').value.trim();
            const valor = parseFloat(document.getElementById('saidaValor').value);
            if (!descricao || isNaN(valor) || valor <= 0) return showToast('Preencha os campos.', 'warning');
            try {
                const res = await fetch('{{ path("clinica_pdv_saida") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({descricao, valor})
                });
                const json = await res.json();
                showToast(json.msg, json.ok ? 'success' : 'danger');
                if (json.ok) setTimeout(() => location.reload(), 1000);
            } catch {
                showToast('Erro ao registrar sa√≠da.', 'danger');
            }
        });
    </script>
{% endblock %}
