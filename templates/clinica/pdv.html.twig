{% extends 'base.html.twig' %}
{% block title %}PDV - Ponto de Venda{% endblock %}
{% block page_title %}Ponto de Venda{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
{% endblock %}

{% block body %}
    <style>
        /* Estilos personalizados para o autocomplete */
        .autocomplete-suggestions {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            background-color: #fff;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .autocomplete-suggestion {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.active {
            background-color: #e2e6ea;
        }

        #petSelect:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Ajustes para o layout geral */
        .pdv {
            background-color: #fff;
            padding: 2rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .pagetitle {
            padding-bottom: 1rem;
        }

        .pagetitle h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #343a40;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 0;
        }

        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: #6c757d;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .btn-outline-dark {
            color: #343a40;
            border-color: #343a40;
        }

        .btn-outline-dark:hover {
            background-color: #343a40;
            color: #fff;
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .summary-section {
            padding-left: 1.5rem;
            border-left: 1px solid #dee2e6;
        }

        .summary-section h5 {
            margin-bottom: 1rem;
            color: #343a40;
        }

        .summary-section p {
            margin-bottom: 0.5rem;
        }

        .summary-section strong {
            color: #212529;
        }

        .total-display {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0d6efd;
        }

        .troco-display {
            font-size: 1.35rem;
            font-weight: bold;
            color: #198754;
        }

        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
        }
    </style>
 <div class="container-fluid">
        <div class="pagetitle">
            <h1>Ponto de Venda</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url('home') }}">Home</a></li>
                    <li class="breadcrumb-item">Atendimento</li>
                    <li class="breadcrumb-item active">PDV - Venda</li>
                </ol>
            </nav>
        </div>

        <div class="pdv">
            <!-- üîπ Cabe√ßalho da Se√ß√£o -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0 text-primary"><i class="bi bi-cash-coin me-2"></i> Ponto de Venda</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ path('clinica_estoque_index') }}" class="btn btn-outline-secondary d-flex align-items-center">
                        <i class="bi bi-box-seam me-2"></i> Estoque
                    </a>
                    <a href="{{ path('clinica_pdv_listar') }}" class="btn btn-outline-info d-flex align-items-center">
                        <i class="bi bi-card-checklist me-2"></i> Listagem
                    </a>
                    <button class="btn btn-outline-danger d-flex align-items-center" id="btnSaidaHeader">
                        <i class="bi bi-box-arrow-up me-2"></i> Registrar Sa√≠da
                    </button>
                    <a href="{{ path('clinica_pdv_caixa') }}" class="btn btn-outline-success d-flex align-items-center">
                        <i class="bi bi-wallet2 me-2"></i> Caixa
                    </a>
                </div>
            </div>
            <hr class="mb-4">

            <!-- üîπ Tutor/Cliente -->
            <div class="mb-4 position-relative">
                <label for="inputTutor" class="form-label">Tutor/Cliente:</label>
                <input type="text" id="inputTutor" class="form-control" autocomplete="off" placeholder="Comece a digitar o nome...">
                <div id="autocomplete-tutor" class="autocomplete-suggestions"></div>
            </div>

            <!-- üêï Pet (opcional) -->
            <div class="mb-4">
                <label for="petSelect" class="form-label">Pet <small class="text-muted">(opcional - para aparecer na ficha)</small>:</label>
                <select id="petSelect" class="form-select" disabled>
                    <option value="">Selecione um cliente primeiro</option>
                </select>
            </div>

            <div class="row g-4">
                <!-- Coluna esquerda: Produtos e Tabela -->
                <div class="col-md-8">
                    <!-- üîç Campo de produto com autocomplete -->
                    <div class="mb-3">
                        <label for="inputProduto" class="form-label">Adicionar Produto/Servi√ßo:</label>
                        <div class="input-group">
                            <input type="text" id="inputProduto" class="form-control" autocomplete="off" placeholder="Digite o nome do produto ou servi√ßo...">
                            <button class="btn btn-primary" id="btnAddProduto" type="button"><i class="bi bi-plus-lg"></i></button>
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalSelecionarProduto">
                                <i class="bi bi-search"></i> Selecionar
                            </button>
                        </div>
                        <div id="autocomplete-list" class="autocomplete-suggestions"></div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle" id="tabelaItens">
                            <thead class="table-light">
                                <tr>
                                    <th>Produto</th>
                                    <th style="width: 100px;">Qtd</th>
                                    <th style="width: 120px;">Pre√ßo Unit.</th>
                                    <th style="width: 120px;">Subtotal</th>
                                    <th style="width: 60px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Itens da venda ser√£o adicionados aqui via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Coluna direita: Resumo e Pagamento -->
                <div class="col-md-4 summary-section">
                    <h5 class="mb-3">Resumo da Venda</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Itens:</span>
                        <span id="totalItens" class="fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Total Bruto:</span>
                        <span id="totalVenda" class="total-display">R$ 0,00</span>
                    </div>

                    <div class="mb-3">
                        <label for="metodo" class="form-label">Forma de Pagamento:</label>
                        <select id="metodo" class="form-select">
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="credito">Cart√£o Cr√©dito</option>
                            <option value="debito">Cart√£o D√©bito</option>
                            <option value="pendente">Fiado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="desconto" class="form-label">Desconto (%):</label>
                        <input type="number" id="desconto" min="0" max="100" value="0" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="valorRecebido" class="form-label">Valor Recebido:</label>
                        <input type="number" step="0.01" id="valorRecebido" class="form-control">
                    </div>

                    <hr class="my-3">

                    <div class="d-flex justify-content-between mb-2">
                        <span>Total com Desconto:</span>
                        <span id="totalComDesconto" class="total-display">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4">
                        <span>Troco:</span>
                        <span id="valorTroco" class="troco-display">R$ 0,00</span>
                    </div>

                    <div class="mb-4">
                        <label for="origem" class="form-label">Origem da Venda:</label>
                        <select name="origem" id="origem" class="form-select">
                            <option value="clinica">Cl√≠nica Veterin√°ria</option>
                            <option value="banho_tosa">Banho e Tosa</option>
                            <option value="hospedagem">Hospedagem</option>
                        </select>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-success btn-lg" id="btnFinalizar">
                            <i class="bi bi-check-circle-fill me-2"></i> Finalizar Venda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Modal Sa√≠da -->
    <div class="modal fade" id="modalSaida" tabindex="-1" aria-labelledby="modalSaidaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalSaidaLabel"><i class="bi bi-box-arrow-up me-2"></i> Registrar Sa√≠da</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saidaDescricao" class="form-label">Descri√ß√£o:</label>
                        <input type="text" id="saidaDescricao" class="form-control" placeholder="Ex: Compra de caf√©">
                    </div>
                    <div class="mb-3">
                        <label for="saidaValor" class="form-label">Valor (R$):</label>
                        <input type="number" step="0.01" id="saidaValor" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarSaida">Registrar Sa√≠da</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Novo Modal para Sele√ß√£o de Produtos/Servi√ßos -->
    <div class="modal fade" id="modalSelecionarProduto" tabindex="-1" aria-labelledby="modalSelecionarProdutoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalSelecionarProdutoLabel"><i class="bi bi-box-seam me-2"></i> Selecionar Produto/Servi√ßo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="inputSearchProdutoModal" class="form-control" placeholder="Buscar produto ou servi√ßo...">
                    </div>
                    <div class="list-group" id="listProdutosModal">
                        <!-- Produtos ser√£o carregados aqui via JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Quantidade e Adicionar -->
    <div class="modal fade" id="modalConfirmarAdicao" tabindex="-1" aria-labelledby="modalConfirmarAdicaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalConfirmarAdicaoLabel"><i class="bi bi-cart-plus me-2"></i> Adicionar Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Produto/Servi√ßo: <strong id="produtoNomeConfirmacao"></strong></p>
                    <p>Pre√ßo Unit√°rio: <strong id="produtoPrecoConfirmacao"></strong></p>
                    <div class="mb-3">
                        <label for="inputQuantidadeConfirmacao" class="form-label">Quantidade:</label>
                        <input type="number" id="inputQuantidadeConfirmacao" class="form-control" value="1" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnAdicionarItemConfirmado">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script>

        $('.search-bar').addClass('d-none');


        const produtos = {{ produtos|json_encode|raw }};
        let itens = [];
        let tutorSelecionado = null;
        let produtoSelecionadoModal = null; // Vari√°vel para armazenar o produto selecionado no modal

        // ==================== TOAST ====================
        function showToast(msg, tipo = 'info') {
            Notify.toast(msg, tipo, 5000);
        }

        // ==================== FUN√á√ïES DE C√ÅLCULO ====================
        function formatarMoeda(valor) {
            return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
        }

        function calcularTotais() {
            let totalVenda = 0;
            itens.forEach(item => {
                totalVenda += item.quantidade * item.preco;
            });
            document.getElementById('totalItens').innerText = itens.length;
            document.getElementById('totalVenda').innerText = formatarMoeda(totalVenda);

            let desconto = parseFloat(document.getElementById('desconto').value) || 0;
            let valorRecebido = parseFloat(document.getElementById('valorRecebido').value) || 0;

            let totalComDesconto = totalVenda * (1 - (desconto / 100));
            document.getElementById('totalComDesconto').innerText = formatarMoeda(totalComDesconto);

            let troco = valorRecebido - totalComDesconto;
            document.getElementById('valorTroco').innerText = formatarMoeda(troco);
        }

        // ==================== ADICIONAR/REMOVER ITENS ====================
        function adicionarItem(produto, quantidade = 1) {
            const itemExistente = itens.find(item => item.id === produto.id);
            if (itemExistente) {
                itemExistente.quantidade += quantidade;
            } else {
                itens.push({ ...produto, quantidade: quantidade });
            }
            renderizarItens();
            calcularTotais();
            showToast('Item adicionado!', 'success');
        }

        function removerItem(id) {
            itens = itens.filter(item => item.id !== id);
            renderizarItens();
            calcularTotais();
            showToast('Item removido!', 'info');
        }

        function atualizarQuantidade(id, novaQuantidade) {
            const item = itens.find(item => item.id === id);
            if (item) {
                item.quantidade = parseInt(novaQuantidade);
                if (item.quantidade <= 0) {
                    removerItem(id);
                } else {
                    renderizarItens();
                    calcularTotais();
                }
            }
        }

        function renderizarItens() {
            const tabelaItensBody = document.querySelector('#tabelaItens tbody');
            tabelaItensBody.innerHTML = '';
            itens.forEach(item => {
                const subtotal = item.quantidade * item.preco;
                const row = `
                    <tr>
                        <td>${item.nome}</td>
                        <td><input type="number" class="form-control form-control-sm" value="${item.quantidade}" min="1" data-id="${item.id}" onchange="atualizarQuantidade(${item.id}, this.value)"></td>
                        <td>${formatarMoeda(item.preco)}</td>
                        <td>${formatarMoeda(subtotal)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="removerItem(${item.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tabelaItensBody.innerHTML += row;
            });
        }

        // ==================== AUTOCOMPLETE TUTOR ====================
        let timeoutTutor = null;
        document.getElementById('inputTutor').addEventListener('input', function () {
            clearTimeout(timeoutTutor);
            const input = this.value;
            const autocompleteDiv = document.getElementById('autocomplete-tutor');
            autocompleteDiv.innerHTML = '';
            autocompleteDiv.style.display = 'none';

            if (input.length < 3) return;

            timeoutTutor = setTimeout(async () => {
                try {
                    const response = await fetch(`{{ path('clinica_autocomplete_tutor') }}?query=${input}`);
                    const data = await response.json();

                    if (data.length > 0) {
                        data.forEach(tutor => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.classList.add('autocomplete-suggestion');
                            suggestionDiv.innerText = tutor.nome;
                            suggestionDiv.addEventListener('click', () => {
                                document.getElementById('inputTutor').value = tutor.nome;
                                tutorSelecionado = tutor;
                                autocompleteDiv.innerHTML = '';
                                autocompleteDiv.style.display = 'none';
                                carregarPetsDoTutor(tutor.id);
                            });
                            autocompleteDiv.appendChild(suggestionDiv);
                        });
                        autocompleteDiv.style.display = 'block';
                    } else {
                        autocompleteDiv.innerHTML = '<div class="autocomplete-suggestion">Nenhum tutor encontrado</div>';
                        autocompleteDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erro ao buscar tutores:', error);
                    showToast('Erro ao buscar tutores.', 'danger');
                }
            }, 300);
        });

        document.addEventListener('click', function (e) {
            if (!document.getElementById('inputTutor').contains(e.target) && !document.getElementById('autocomplete-tutor').contains(e.target)) {
                document.getElementById('autocomplete-tutor').style.display = 'none';
            }
        });

        // ==================== CARREGAR PETS ====================
        async function carregarPetsDoTutor(tutorId) {
            const petSelect = document.getElementById('petSelect');
            petSelect.innerHTML = '<option value="">Carregando pets...</option>';
            petSelect.disabled = true;
            try {
                const response = await fetch(`{{ path('clinica_pets_by_tutor', {'id': 'TUTOR_ID'}) }}`.replace('TUTOR_ID', tutorId));
                const pets = await response.json();

                petSelect.innerHTML = '<option value="">Selecione um pet (opcional)</option>';
                if (pets.length > 0) {
                    pets.forEach(pet => {
                        const option = document.createElement('option');
                        option.value = pet.id;
                        option.innerText = pet.nome;
                        petSelect.appendChild(option);
                    });
                    petSelect.disabled = false;
                } else {
                    petSelect.innerHTML = '<option value="">Nenhum pet encontrado para este tutor</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar pets:', error);
                showToast('Erro ao carregar pets.', 'danger');
                petSelect.innerHTML = '<option value="">Erro ao carregar pets</option>';
            }
        }

        // ==================== AUTOCOMPLETE PRODUTO (EXISTENTE) ====================
        let timeoutProduto = null;
        document.getElementById('inputProduto').addEventListener('input', function () {
            clearTimeout(timeoutProduto);
            const input = this.value.toLowerCase();
            const autocompleteDiv = document.getElementById('autocomplete-list');
            autocompleteDiv.innerHTML = '';
            autocompleteDiv.style.display = 'none';

            if (input.length < 2) return;

            timeoutProduto = setTimeout(() => {
                const resultados = produtos.filter(p => p.nome.toLowerCase().includes(input));

                if (resultados.length > 0) {
                    resultados.forEach(produto => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.classList.add('autocomplete-suggestion');
                        suggestionDiv.innerText = `${produto.nome} (R$ ${produto.preco.toFixed(2).replace('.', ',')})`;
                        suggestionDiv.addEventListener('click', () => {
                            adicionarItem(produto);
                            document.getElementById('inputProduto').value = '';
                            autocompleteDiv.innerHTML = '';
                            autocompleteDiv.style.display = 'none';
                        });
                        autocompleteDiv.appendChild(suggestionDiv);
                    });
                    autocompleteDiv.style.display = 'block';
                } else {
                    autocompleteDiv.innerHTML = '<div class="autocomplete-suggestion">Nenhum produto/servi√ßo encontrado</div>';
                    autocompleteDiv.style.display = 'block';
                }
            }, 300);
        });

        document.getElementById('btnAddProduto').addEventListener('click', () => {
            const input = document.getElementById('inputProduto').value;
            const produtoEncontrado = produtos.find(p => p.nome.toLowerCase() === input.toLowerCase());
            if (produtoEncontrado) {
                adicionarItem(produtoEncontrado);
                document.getElementById('inputProduto').value = '';
                document.getElementById('autocomplete-list').style.display = 'none';
            } else {
                showToast('Produto n√£o encontrado ou inv√°lido.', 'warning');
            }
        });

        document.addEventListener('click', function (e) {
            if (!document.getElementById('inputProduto').contains(e.target) && !document.getElementById('autocomplete-list').contains(e.target)) {
                document.getElementById('autocomplete-list').style.display = 'none';
            }
        });

        // ==================== L√ìGICA DO NOVO MODAL DE SELE√á√ÉO DE PRODUTOS ====================
        const modalSelecionarProduto = new bootstrap.Modal(document.getElementById('modalSelecionarProduto'));
        const modalConfirmarAdicao = new bootstrap.Modal(document.getElementById('modalConfirmarAdicao'));

        document.getElementById('inputSearchProdutoModal').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const listProdutosModal = document.getElementById('listProdutosModal');
            listProdutosModal.innerHTML = '';

            const filteredProdutos = produtos.filter(p => p.nome.toLowerCase().includes(searchTerm));

            if (filteredProdutos.length > 0) {
                filteredProdutos.forEach(produto => {
                    const itemDiv = document.createElement('a');
                    itemDiv.href = '#';
                    itemDiv.classList.add('list-group-item', 'list-group-item-action');
                    itemDiv.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${produto.nome}</h6>
                            <small class="text-muted">${formatarMoeda(produto.preco)}</small>
                        </div>
                        <p class="mb-1 text-muted">${produto.descricao || 'Sem descri√ß√£o.'}</p>
                    `;
                    itemDiv.addEventListener('click', (e) => {
                        e.preventDefault();
                        produtoSelecionadoModal = produto;
                        document.getElementById('produtoNomeConfirmacao').innerText = produto.nome;
                        document.getElementById('produtoPrecoConfirmacao').innerText = formatarMoeda(produto.preco);
                        document.getElementById('inputQuantidadeConfirmacao').value = 1;
                        modalSelecionarProduto.hide();
                        modalConfirmarAdicao.show();
                    });
                    listProdutosModal.appendChild(itemDiv);
                });
            } else {
                listProdutosModal.innerHTML = '<div class="list-group-item">Nenhum produto ou servi√ßo encontrado.</div>';
            }
        });

        // Carregar todos os produtos no modal ao abrir (ou quando o input de busca estiver vazio)
        document.getElementById('modalSelecionarProduto').addEventListener('shown.bs.modal', () => {
            document.getElementById('inputSearchProdutoModal').value = '';
            document.getElementById('inputSearchProdutoModal').dispatchEvent(new Event('input')); // Dispara o evento para carregar a lista completa
            document.getElementById('inputSearchProdutoModal').focus();
        });

        document.getElementById('btnAdicionarItemConfirmado').addEventListener('click', () => {
            const quantidade = parseInt(document.getElementById('inputQuantidadeConfirmacao').value);
            if (produtoSelecionadoModal && quantidade > 0) {
                adicionarItem(produtoSelecionadoModal, quantidade);
                modalConfirmarAdicao.hide();
            } else {
                showToast('Quantidade inv√°lida.', 'warning');
            }
        });

        // ==================== EVENTOS GERAIS ====================
        document.getElementById('desconto').addEventListener('input', calcularTotais);
        document.getElementById('valorRecebido').addEventListener('input', calcularTotais);

        // ==================== FINALIZAR VENDA ====================
        document.getElementById('btnFinalizar').addEventListener('click', function () {
            if (itens.length === 0) {
                return showToast('Adicione pelo menos um item √† venda.', 'warning');
            }
            if (!tutorSelecionado) {
                return showToast('Selecione um tutor/cliente.', 'warning');
            }

            const metodo = document.getElementById('metodo').value;
            const cliente_id = tutorSelecionado.id;
            const pet_id = document.getElementById('petSelect').value || null;
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const valorRecebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
            const origem = document.getElementById('origem').value;

            let totalVenda = 0;
            itens.forEach(item => {
                totalVenda += item.quantidade * item.preco;
            });
            const totalDesc = totalVenda * (1 - (desconto / 100));
            const troco = valorRecebido - totalDesc;

            const payload = {
                metodo: metodo,
                cliente_id: cliente_id,
                pet_id: pet_id,
                total: totalDesc,
                desconto: desconto,
                itens: itens,
                troco: troco,
                origem: origem
            };

            // 5Ô∏è‚É£ Envio
            $.ajax({
                url: '{{ path("clinica_pdv_registrar") }}',
                method: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(payload),
                success: function (json) {
                    showToast(json.msg, json.ok ? 'success' : 'danger');

                    if (json.ok) {
                        setTimeout(function () {
                            location.reload();
                        }, 2000);
                    }
                },
                error: function () {
                    showToast('Erro ao comunicar com o servidor.', 'danger');
                }
            });
        });


        // ==================== SA√çDA DE DINHEIRO ====================
        document.getElementById('btnSaidaHeader').addEventListener('click', () => {
            new bootstrap.Modal(document.getElementById('modalSaida')).show();
        });
        document.getElementById('confirmarSaida').addEventListener('click', async () => {
            const descricao = document.getElementById('saidaDescricao').value.trim();
            const valor = parseFloat(document.getElementById('saidaValor').value);
            if (!descricao || isNaN(valor) || valor <= 0) return showToast('Preencha os campos.', 'warning');
            try {
                const res = await fetch('{{ path("clinica_pdv_saida") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({descricao, valor})
                });
                const json = await res.json();
                showToast(json.msg, json.ok ? 'success' : 'danger');
                if (json.ok) setTimeout(() => location.reload(), 1000);
            } catch {
                showToast('Erro ao registrar sa√≠da.', 'danger');
            }
        });
    </script>
{% endblock %}
