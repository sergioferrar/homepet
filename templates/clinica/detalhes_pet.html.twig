{% extends 'base.html.twig' %}

{% block title %}Ficha do Pet - {{ pet.nome }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .main-card, .info-card {
            background: #fff; border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e9ecef; height: 100%;
        }
        .info-card { padding: 30px; }
        .pet-avatar {
            width: 80px; height: 80px; object-fit: cover;
            border-radius: 50%; border: 4px solid #e9ecef;
        }
        
        .history-nav {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 1.5rem;
            border-right: 1px solid #e9ecef;
        }

        .history-event {
            padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.75rem;
            cursor: pointer; border: 1px solid #e9ecef; border-left-width: 5px;
            transition: all 0.2s ease; position: relative;
        }
        .history-event:hover { background-color: #f0f3f5; transform: translateX(4px); }
        .history-event.active { background-color: #e9f2ff; }
        .history-event .event-date { font-size: 0.85rem; font-weight: 500; color: #6c757d; }
        .history-event .event-title { font-size: 1.1rem; color: #343a40; font-weight: 600; }
        .event-avatar {
            position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
            width: 36px; height: 36px; background-color: #dee2e6;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #495057;
        }

        .history-event.consulta { border-left-color: #0d6efd; }
        .history-event.documento, .history-event.documentos { border-left-color: #198754; }
        .history-event.receita { border-left-color: #6610f2; }
        .history-event.internacao { border-left-color: #dc3545; }
        .history-event.peso { border-left-color: #e85d6c; }
        .history-event.exame { border-left-color: #e83e8c; }
        .history-event.vacina { border-left-color: #ffc107; }
        .history-event.foto { border-left-color: #17a2b8; }
        .history-event.outro { border-left-color: #6c757d; }

        .content-panel { display: none; }
        .content-panel.active { display: block; }
        .anamnese-view, .quill-editor {
            background-color: #f8f9fa; padding: 1rem; border-radius: 8px;
            border: 1px solid #dee2e6; min-height: 150px;
        }
        .action-grid .btn {
            height: 110px; font-size: 1rem; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .action-grid .btn i { font-size: 2.5rem; margin-bottom: 0.5rem; }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid my-4">
    <!-- INFO CARDS -->
    <div class="row mb-4">
        <div class="col-lg-8"><div class="info-card d-flex align-items-center"><img src="{{ asset('images/pet.png') }}" alt="Avatar do Pet" class="pet-avatar me-4"><div><h4 class="mb-1">{{ pet.nome }} <small class="text-muted fw-normal">({{ pet.id }})</small></h4><p class="text-muted mb-2 fs-5">{{ pet.raca }} - {{ pet.sexo }} - {{ pet.idade }} anos</p><p class="mb-0"><strong>Tutor:</strong> {{ pet.dono_nome|default('Não vinculado') }}</p></div></div></div>
        <div class="col-lg-4"><div class="info-card"><h5>Financeiro</h5><p class="text-muted">Nenhum débito pendente.</p></div></div>
    </div>

    <!-- Layout Principal -->
    <div class="main-card">
        <div class="row">
            <!-- Coluna da Esquerda: Timeline -->
            <div class="col-md-5 history-nav">
                <h4 class="mb-3">Histórico</h4>
                {% for item in timeline_items %}
                    <div class="history-event {{ item.tipo|lower|replace({' ': '-'}) }}" data-target="#evento-{{ loop.index }}">
                        <div class="event-date">{{ item.data|date('d/m/Y \\à\\s H:i') }}</div>
                        <div class="event-title">{{ item.tipo }}</div>
                        <div class="event-avatar">{{ item.autor|default('VV') }}</div>
                    </div>
                {% else %}
                    <p>Nenhum evento no histórico.</p>
                {% endfor %}
            </div>

            <!-- Coluna da Direita: Conteúdo Dinâmico -->
            <div class="col-md-7">
                <!-- PAINEL 1: Grelha de botões -->
                <div id="action-grid-view" class="content-panel">
                    <h5 class="mb-3">Adicionar</h5>
                    <div class="row g-3 action-grid">
                        <div class="col-4"><button class="btn btn-primary w-100" data-target="#atendimento-form-view"><i class="bx bxs-briefcase-alt-2"></i> Atendimento</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #e85d6c;" data-target="#peso-form-view"><i class="ri-dashboard-2-line"></i> Peso</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #884dff;" data-target="#patologia-form-view"><i class="fas fa-notes-medical"></i> Patologia</button></div>
                        <div class="col-4"><button class="btn btn-success w-100" data-target="#documento-form-view"><i class="fas fa-file-invoice"></i> Documento</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #e83e8c;" data-target="#exame-form-view"><i class="fas fa-vial"></i> Exame</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #17a2b8;" data-target="#fotos-form-view"><i class="fas fa-camera"></i> Fotos</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #ffc107; color: #343a40 !important;" data-target="#vacina-form-view"><i class="fas fa-syringe"></i> Vacina</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #6610f2;" data-target="#receita-form-view"><i class="bx bxs-pencil"></i> Receita</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #6c757d;" data-target="#observacoes-form-view"><i class="fas fa-comment-dots"></i> Observações</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #0dcaf0;" data-target="#video-form-view"><i class="fas fa-video"></i> Vídeo</button></div>
                        <div class="col-4"><button class="btn text-white w-100" style="background-color: #dc3545;" data-target="#internacao-form-view"><i class="bx bxs-hotel"></i> Internação</button></div>
                    </div>
                </div>

                <!-- Detalhes do histórico -->
                {% for item in timeline_items %}
                    <div class="content-panel" id="evento-{{ loop.index }}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>{{ item.tipo }} em {{ item.data|date('d/m/Y') }}</h4>
                            <button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button>
                        </div>
                        <hr>
                        {% if item.tipo == 'Consulta' %}
                            <p><strong>Queixa Principal:</strong> {{ item.dados.observacoes|default('Nenhuma') }}</p>
                            <h5>Anamnese e Exame Clínico</h5>
                            <div class="anamnese-view">{{ item.dados.anamnese|raw }}</div>
                        {% else %}
                            <p>{{ item.resumo }}</p>
                        {% endif %}
                    </div>
                {% endfor %}

                <!-- Formulário de Atendimento -->
                <div id="atendimento-form-view" class="content-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Novo Atendimento</h4>
                        <button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button>
                    </div>
                    <hr>
                    {% if pet.dono_id %}
                        <form method="post" action="{{ path('clinica_novo_atendimento', {'petId': pet.id}) }}">
                             <input type="hidden" name="pet_id" value="{{ pet.id }}">
                             <input type="hidden" name="cliente_id" value="{{ pet.dono_id }}">
                             <input type="hidden" name="anamnese" id="anamnese-input">
                             <div class="mb-3">
                                <label class="form-label">Queixa Principal</label>
                                <input type="text" name="observacoes" class="form-control">
                             </div>
                             <div class="mb-3">
                                <label class="form-label">Anamnese / Exame Clínico</label>
                                <div id="atendimento-editor" style="min-height: 250px;"></div>
                             </div>
                             <button type="submit" class="btn btn-primary">Salvar Atendimento</button>
                        </form>
                    {% else %}
                        <div class="alert alert-danger"><strong>Erro:</strong> Pet sem tutor associado.</div>
                    {% endif %}
                </div>

                <!-- Formulário de Documento -->
                <div id="documento-form-view" class="content-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Gerar Documento</h4>
                        <button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="flex-grow-1 me-2">
                            <label for="select-doc-template" class="form-label">Usar modelo</label>
                            <select id="select-doc-template" class="form-select">
                                <option value="">Novo Documento</option>
                                {% for doc in documentos %}
                                    <option value="{{ doc.id }}" data-titulo="{{ doc.titulo }}" data-cabecalho="{{ doc.cabecalho|e('html_attr') }}" data-conteudo="{{ doc.conteudo|e('html_attr') }}" data-rodape="{{ doc.rodape|e('html_attr') }}">{{ doc.titulo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                             <label for="doc-actions" class="form-label">Ações</label>
                            <select id="doc-actions" class="form-select">
                                <option selected disabled>Ação...</option>
                                <option value="pdf">Gerar PDF</option>
                                <option value="save">Salvar como novo modelo</option>
                                <option value="delete">Excluir modelo selecionado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="doc-titulo" class="form-label">Título</label>
                        <input type="text" id="doc-titulo" class="form-control" placeholder="Título do documento">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cabeçalho</label>
                        <div id="doc-editor-cabecalho" class="quill-editor" style="min-height: 100px;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conteúdo</label>
                        <div id="doc-editor-conteudo" class="quill-editor" style="min-height: 200px;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rodapé</label>
                        <div id="doc-editor-rodape" class="quill-editor" style="min-height: 100px;"></div>
                    </div>
                    
                    <!-- Formulários ocultos para as ações -->
                    <form id="form-pdf-doc" method="POST" action="{{ path('clinica_receita_pdf') }}" target="_blank" class="d-none">
                        <input type="hidden" name="cabecalho">
                        <input type="hidden" name="conteudo">
                        <input type="hidden" name="rodape">
                    </form>
                    <form id="form-salvar-doc" method="POST" action="{{ path('clinica_documentos') }}" class="d-none">
                        <input type="hidden" name="titulo">
                        <input type="hidden" name="cabecalho">
                        <input type="hidden" name="conteudo">
                        <input type="hidden" name="rodape">
                    </form>
                    <form id="form-excluir-doc" method="POST" action="{{ path('clinica_documento_excluir', {'id': 0}) }}" class="d-none">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_doc') }}">
                    </form>
                </div>

                <!-- Painéis vazios para os outros botões -->
                <div id="peso-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Registrar Peso</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Peso...</p></div>
                <div id="patologia-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Registrar Patologia</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Patologia...</p></div>
                <div id="exame-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Registrar Exame</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Exame...</p></div>
                <div id="fotos-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Adicionar Fotos</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Fotos...</p></div>
                <div id="vacina-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Registrar Vacina</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Vacina...</p></div>
                <div id="receita-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Nova Receita</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Receita...</p></div>
                <div id="observacoes-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Adicionar Observação</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Observação...</p></div>
                <div id="video-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Adicionar Vídeo</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Vídeo...</p></div>
                <div id="internacao-form-view" class="content-panel"><div class="d-flex justify-content-between"><h4>Nova Internação</h4><button class="btn btn-sm btn-outline-secondary btn-back-to-grid"><i class="fas fa-arrow-left me-1"></i> Voltar</button></div><hr><p>Formulário de Internação...</p></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        const docTemplatesData = {{ documentos|default([])|json_encode|raw }};

        document.addEventListener('DOMContentLoaded', function() {
            const contentPanels = document.querySelectorAll('.content-panel');
            const historyEvents = document.querySelectorAll('.history-event');
            const actionButtons = document.querySelectorAll('#action-grid-view button');
            const backButtons = document.querySelectorAll('.btn-back-to-grid');
            
            let quillInstances = {};

            function showPanel(targetId) {
                contentPanels.forEach(panel => panel.style.display = 'none');
                const targetPanel = document.querySelector(targetId);
                if (targetPanel) {
                    targetPanel.style.display = 'block';

                    if (targetId === '#atendimento-form-view' && !quillInstances.atendimento) {
                        quillInstances.atendimento = new Quill('#atendimento-editor', { theme: 'snow' });
                    }
                    if (targetId === '#documento-form-view' && !quillInstances.docCabecalho) {
                        quillInstances.docCabecalho = new Quill('#doc-editor-cabecalho', { theme: 'snow' });
                        quillInstances.docConteudo = new Quill('#doc-editor-conteudo', { theme: 'snow' });
                        quillInstances.docRodape = new Quill('#doc-editor-rodape', { theme: 'snow' });
                    }
                }
            }

            historyEvents.forEach(event => {
                event.addEventListener('click', function() {
                    historyEvents.forEach(el => el.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('data-target');
                    showPanel(targetId);
                });
            });

            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    showPanel(targetId);
                });
            });

            backButtons.forEach(button => {
                button.addEventListener('click', function() {
                    historyEvents.forEach(el => el.classList.remove('active'));
                    showPanel('#action-grid-view');
                });
            });

            const atendimentoForm = document.querySelector('#atendimento-form-view form');
            if(atendimentoForm) {
                atendimentoForm.addEventListener('submit', function() {
                    if(quillInstances.atendimento) {
                        document.getElementById('anamnese-input').value = quillInstances.atendimento.root.innerHTML;
                    }
                });
            }

            const docTemplateSelect = document.getElementById('select-doc-template');
            if(docTemplateSelect) {
                docTemplateSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const tituloInput = document.getElementById('doc-titulo');
                    if (selectedOption.value && quillInstances.docCabecalho) {
                        tituloInput.value = selectedOption.dataset.titulo || '';
                        quillInstances.docCabecalho.root.innerHTML = selectedOption.dataset.cabecalho || '';
                        quillInstances.docConteudo.root.innerHTML = selectedOption.dataset.conteudo || '';
                        quillInstances.docRodape.root.innerHTML = selectedOption.dataset.rodape || '';
                    } else if (quillInstances.docCabecalho) {
                        tituloInput.value = '';
                        quillInstances.docCabecalho.root.innerHTML = '';
                        quillInstances.docConteudo.root.innerHTML = '';
                        quillInstances.docRodape.root.innerHTML = '';
                    }
                });
            }

            const docActionsSelect = document.getElementById('doc-actions');
            if(docActionsSelect){
                docActionsSelect.addEventListener('change', function(){
                    const action = this.value;
                    const formPDF = document.getElementById('form-pdf-doc');
                    const formSave = document.getElementById('form-salvar-doc');
                    const formDelete = document.getElementById('form-excluir-doc');
                    const selectedDocOption = docTemplateSelect.options[docTemplateSelect.selectedIndex];

                    const titulo = document.getElementById('doc-titulo').value.trim();
                    const cabecalho = quillInstances.docCabecalho.root.innerHTML;
                    const conteudo = quillInstances.docConteudo.root.innerHTML;
                    const rodape = quillInstances.docRodape.root.innerHTML;

                    if(action === 'pdf'){
                        formPDF.querySelector('[name="cabecalho"]').value = cabecalho;
                        formPDF.querySelector('[name="conteudo"]').value = conteudo;
                        formPDF.querySelector('[name="rodape"]').value = rodape;
                        formPDF.submit();
                    } else if (action === 'save') {
                        if(!titulo){
                            alert('Por favor, dê um título ao modelo antes de salvar.');
                        } else {
                            formSave.querySelector('[name="titulo"]').value = titulo;
                            formSave.querySelector('[name="cabecalho"]').value = cabecalho;
                            formSave.querySelector('[name="conteudo"]').value = conteudo;
                            formSave.querySelector('[name="rodape"]').value = rodape;
                            formSave.submit();
                        }
                    } else if (action === 'delete') {
                        if (!selectedDocOption.value) {
                            alert("Selecione um documento para excluir.");
                        } else if (confirm("Tem certeza que deseja excluir o modelo '" + selectedDocOption.text + "'?")) {
                            let deleteActionUrl = formDelete.getAttribute("action").replace('/0', '/' + selectedDocOption.value);
                            formDelete.setAttribute("action", deleteActionUrl);
                            formDelete.submit();
                        }
                    }
                    this.selectedIndex = 0;
                });
            }

            showPanel('#action-grid-view');
        });
    </script>
{% endblock %}
