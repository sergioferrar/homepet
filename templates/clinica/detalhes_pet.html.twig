{% extends 'baseClinica.html.twig' %}
{% block title %}
    Ficha de Interna√ß√£o - {{ pet.nome }}
{% endblock %}
{% block body %}
    {% set total_debitos = total_debitos|default(0) %}
    <div class="container-fluid bg-white p-3 my-4">
        <div class="row">
            <div class="col-2">
                <a href="{{ path('clinica_dashboard') }}" class="btn btn-outline-secondary voltar-dash">
                    <i class="bi bi-arrow-left me-1"></i>Voltar para o Dashboard
                </a>
            </div>
            <div class="col-10"></div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3 d-none">
        </div>
        <hr>
        <div class="row mb-4">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="info-card">
                    <h5>
                    {{ pet.dono_nome|default('Tutor n√£o vinculado') }}
                    {% if pet.dono_nome %}
                        <small class="text-muted fw-normal">({{ pet.dono_id }})</small>
                    {% endif %}
                    </h5>
                    <table class="table table-sm mb-2">
                        <tbody>
                            <tr>
                                <th>Telefone:</th>
                                <td>{{ pet.dono_telefone|default('-') }}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ pet.dono_email|default('-') }}</td>
                            </tr>
                            <tr>
                                <th>Endere√ßo:</th>
                                <td>{{ pet.dono_endereco|default('-') }}</td>
                            </tr>
                        </tbody>
                    </table>
                    {% if total_debitos > 0 %}
                        <span class="badge text-bg-danger">
                            Saldo devedor de R$ {{ total_debitos|number_format(2, ',', '.') }}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-6">
                <div class="info-card d-flex justify-content-between align-items-center">
                    <div class="col-3">
                        <img width="" src="{{ asset('images/pet.jpeg') }}" alt="Avatar do Pet"
                        class="pet-avatar img-responsive border float-start me-4" onerror="this.style.display='none'">
                    </div>
                    <div class="col-9">
                        <table class="table table-sm" width="100%">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Ra√ßa</th>
                                    <th>Sexo</th>
                                    <th>Idade</th>
                                    <th>Peso</th>
                                    <th>Castra√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ pet.nome }}
                                    <small class="text-muted fw-normal">({{ pet.id }})</small></td>
                                    <td>{{ pet.raca }}</td>
                                    <td>{{ pet.sexo }}</td>
                                    <td>{{ pet.dataNascimento ? pet.dataNascimento|idadeFormatada : 'N√£o informada' }}</td>
                                    <td>{{ pet.peso }} KG</td>
                                    <td>
                                        <span class="p-2 badge {% if pet.castrado == 1 %} text-bg-success {% else %} text-bg-danger {% endif %}">
                                        {% if pet.castrado == 1 %} Castrado {% else %} N√£o √© Castrado {% endif %}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="row g-3">
        <div class="col-lg-12 col-sm-12">
            <div class="main-card">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="historico-tab" data-bs-toggle="tab"
                        data-bs-target="#historico" type="button" role="tab" aria-controls="historico"
                        aria-selected="true">
                        <i class="fas fa-history me-1"></i> Hist√≥rico
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline"
                        type="button" role="tab" aria-controls="timeline" aria-selected="false">
                        <i class="fas fa-stream me-1"></i> Linha do Tempo
                        </button>
                    </li>
                    {# Decide destino principal: ativa > √∫ltima > nova #}
                    {% set href_internacao = internacao_ativa_id
                    ? path('clinica_ficha_internacao', {'id': internacao_ativa_id})
                    : (ultima_internacao_id
                    ? path('clinica_ficha_internacao', {'id': ultima_internacao_id})
                    : path('clinica_nova_internacao', {'petId': pet.id})
                    ) %}
                    {% set texto_internacao = internacao_ativa_id
                    ? 'Ficha de Interna√ß√£o (ativa)'
                    : (ultima_internacao_id ? 'Ver √∫ltima Ficha de Interna√ß√£o' : 'Nova Interna√ß√£o') %}
                    <li class="nav-item" role="presentation">
                        <a href="{{ href_internacao }}" id="btn-internacao-aba"
                            class="nav-link d-flex align-items-center" title="{{ texto_internacao }}">
                            <i class="bi bi-hospital me-1"></i>
                            <span>{{ texto_internacao }}</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" role="presentation">
                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                            aria-expanded="false" title="Todas as interna√ß√µes">
                            Hist√≥rico de interna√ß√µes
                            {% if internacoes_pet is defined and internacoes_pet|length %}
                                <span class="badge bg-secondary ms-1">{{ internacoes_pet|length }}</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu">
                            {% if internacoes_pet is defined and internacoes_pet|length %}
                                {% for i in internacoes_pet %}
                                    <li>
                                        <a class="dropdown-item d-flex justify-content-between align-items-center"
                                            href="{{ path('clinica_ficha_internacao', {'id': i.id}) }}">
                                            <span>#{{ i.id }} ‚Äî {{ i.status|capitalize }}</span>
                                            <small class="text-muted">{{ i.data_inicio|date('d/m/Y H:i') }}</small>
                                        </a>
                                    </li>
                                {% endfor %}
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                            {% else %}
                                <li><span class="dropdown-item-text text-muted">Nenhuma interna√ß√£o anterior</span>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                        {% endif %}
                        <li>
                            <a class="dropdown-item"
                                href="{{ path('clinica_nova_internacao', {'petId': pet.id}) }}">
                                <i class="bi bi-plus-circle me-1"></i> Nova Interna√ß√£o
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="venda-tab" data-bs-toggle="tab" data-bs-target="#venda"
                    type="button" role="tab" aria-controls="venda" aria-selected="false">
                    <i class="fas fa-dollar-sign me-1"></i> Venda
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vacinas-tab" data-bs-toggle="tab"
                    data-bs-target="#vacinas"
                    type="button" role="tab" aria-controls="vacinas"
                    aria-selected="false">
                    <i class="fas fa-syringe me-1 "></i> Vacinas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="orcamentos-tab" data-bs-toggle="tab"
                    data-bs-target="#orcamentos"
                    type="button" role="tab" aria-controls="orcamentos" aria-selected="false">
                    <i class="fas fa-file-invoice-dollar me-1"></i> Or√ßamentos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda"
                    type="button" role="tab" aria-controls="agenda" aria-selected="false">
                    <i class="bi bi-calendar me-1"></i> Agenda
                    </button>
                </li>
            </ul>
            <div class="tab-content pt-4" id="consolidatedTabsContent">
                {# HIST√ìRICO + A√á√ïES #}
                <div class="tab-pane fade show active" id="historico" role="tabpanel"
                    aria-labelledby="historico-tab">
                    <div id="action-buttons-view" class=" p-4">
                        <h5 class="card-title mb-3">Adicionar Novo Registro</h5>
                        <div class="row action-grid g-3">
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-novo-atendimento"
                                    class="btn btn-primary btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white p-3">
                                    <i class="bi bi-heart-pulse fs-2 mb-2"></i>
                                    <span>Atendimento</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-nova-receita"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                    style="background-color: #6f42c1;">
                                    <i class="bi bi-file-earmark-text fs-2 mb-2"></i>
                                    <span>Receita</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="{{ path('clinica_nova_internacao', {'petId': pet.id}) }}"
                                    id="btn-nova-internacao"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                    style="background-color: #20c997;">
                                    <i class="bi bi-hospital fs-2 mb-2"></i>
                                    <span>Interna√ß√£o</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-novo-peso"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                    style="background-color: #e85d6c;">
                                    <i class="bi bi-rulers fs-2 mb-2"></i>
                                    <span>Peso</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-novo-exame"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                    style="background-color: #e83e8c;">
                                    <i class="bi bi-eyedropper fs-2 mb-2"></i>
                                    <span>Exame</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="{{ path('clinica_documentos', {'petId': pet.id}) }}"
                                    class="btn btn-success btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white">
                                    <i class="bi bi-file-earmark-text fs-2 mb-2"></i>
                                    <span>Documento</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-novas-fotos"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                    style="background-color: #17a2b8;">
                                    <i class="bi bi-camera fs-2 mb-2"></i>
                                    <span>Fotos</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="#" id="btn-nova-vacina"
                                    class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center"
                                    style="background-color: #ffc107; color: #212529 !important;">
                                    <i class="bi bi-capsule fs-2 mb-2"></i>
                                    <span>Vacina</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    {# FORM ATENDIMENTO #}
                    <div id="atendimento-view" style="display: none;">
                        <form id="form-atendimento" method="POST"
                            action="{{ path('clinica_novo_atendimento', {'petId': pet.id}) }}">
                            <div class="form-view-container">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="form-view-header">Novo Atendimento</h5>
                                    <button type="button" class="btn-close" id="btn-fechar-atendimento"
                                    aria-label="Fechar"></button>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3"><label class="form-label">Tipo*</label><select
                                    class="form-select" name="tipo">
                                    <option value="Consulta" selected>Consulta</option>
                                    <option value="Retorno">Retorno</option>
                                </select></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Resumo
                                (Observa√ß√µes)</label><input type="text" class="form-control"
                            name="observacoes"></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Anamnese / Exame Cl√≠nico</label>
                        <div id="atendimento-editor"></div>
                        <input type="hidden" name="anamnese_delta" id="anamnese-input"></div>
                        <input type="hidden" name="pet_id" value="{{ pet.id }}">
                        <input type="hidden" name="cliente_id" value="{{ pet.dono_id }}">
                        <input type="hidden" name="data" value="{{ "now"|date("Y-m-d") }}">
                        <input type="hidden" name="hora" value="{{ "now"|date("H:i:s") }}">
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success"><i
                            class="fas fa-save me-1"></i>
                            Salvar Atendimento
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {# FORM RECEITA #}
            <div id="receita-view" style="display: none;">
                <form id="form-receita" method="POST"
                    action="{{ path('clinica_nova_receita', {'petId': pet.id}) }}">
                    <div class="form-view-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="form-view-header">Emitir Receita</h5>
                            <button type="button" class="btn-close" id="btn-fechar-receita"
                            aria-label="Fechar"></button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Conte√∫do da Receita</label>
                            <div id="editor-conteudo"></div>
                            <input type="hidden" name="conteudo" id="conteudo-input">
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary"><i
                            class="fas fa-print me-1"></i>
                            Gerar PDF e Salvar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {# FORM VACINA #}
            <div id="vacina-view" style="display: none;">
                <form id="formNovaVacina" method="POST"
                    action="{{ path('clinica_vacina_nova', {'petId': pet.id}) }}">
                    <div class="form-view-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="form-view-header">Registrar Vacina</h5>
                            <button type="button" class="btn-close" id="btn-fechar-vacina"
                            aria-label="Fechar"></button>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo da Vacina*</label>
                                <input type="text" class="form-control" name="tipo" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Data de Aplica√ß√£o*</label>
                                <input type="date" class="form-control" name="data_aplicacao"
                                value="{{ "now"|date("Y-m-d") }}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Validade*</label>
                                <input type="date" class="form-control" name="data_validade" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Lote</label>
                                <input type="text" class="form-control" name="lote">
                            </div>
                        </div>
                        <input type="hidden" name="pet_id" value="{{ pet.id }}">
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-warning">
                            <i class="bi bi-capsule me-1"></i> Salvar Vacina
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {# VISUALIZA√á√ÉO DETALHES #}
            <div id="service-display-container"
                class="card border border-dark bg-white rounded-4  mt-4" style="display: none;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0 d-none" id="service-display-title">Detalhes do
                        Registro</h5>
                        <button type="button" class="btn-close d-none" id="btn-fechar-service-display"
                        aria-label="Fechar"></button>
                    </div>
                    <div id="service-details-content"></div>
                </div>
            </div>
        </div>
        {# LINHA DO TEMPO #}
        {# LINHA DO TEMPO #}
        <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab"
            style="max-height: 440px; overflow-y: auto;">
            <ul class="timeline">
                {% for item in timeline_items %}
                    {% set borderClass =
                    'Consulta' in item.tipo ? 'border-start border-5 border-primary ps-3' :
                    'Retorno' in item.tipo ? 'border-start border-5 border-success ps-3' :
                    'Vacina' in item.tipo  ? 'border-start border-5 border-warning ps-3' :
                    'Receita' in item.tipo ? 'border-start border-5 ps-3' :
                    'border-start border-5 border-dark ps-3'
                    %}
                    {% set borderStyle =
                    'Receita' in item.tipo ? 'border-left: 5px solid #6f42c1 !important;' : ''
                    %}
                    {% set dataFormatada = item.data|date('d/m/Y \\√†\\s H:i') %}
                    <li>
                        <div class="timeline-badge ">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="timeline-panel border {{ borderClass }}"
                            {% if borderStyle %}style="{{ borderStyle }}"{% endif %}>
                            <div class="timeline-heading">
                                <h4 class="timeline-title">
                                <a href="#"
                                    class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                    data-tipo="{{ item.tipo }}"
                                    data-observacoes="{{ item.observacoes|default('') }}"
                                    data-data="{{ dataFormatada }}"
                                    data-resumo="{{ item.resumo|raw }}"
                                    {% if item.anamnese is defined %}
                                        data-atendimento-delta="{{ item.anamnese|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_cabecalho is defined %}
                                        data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_conteudo is defined %}
                                        data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_rodape is defined %}
                                        data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}"
                                    {% endif %}>
                                    <span>{{ item.tipo }}</span>
                                </a>
                                </h4>
                                <p>
                                    <small class="text-muted">
                                    {{ dataFormatada }}
                                    </small>
                                </p>
                            </div>
                            <div class="timeline-body">
                                <a href="#"
                                    class="timeline-link timeline-text btn btn-sm btn-primary"
                                    data-tipo="{{ item.tipo }}"
                                    data-observacoes="{{ item.observacoes|default('') }}"
                                    data-data="{{ dataFormatada }}"
                                    data-resumo="{{ item.resumo|raw }}"
                                    {% if item.anamnese is defined %}
                                        data-atendimento-delta="{{ item.anamnese|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_cabecalho is defined %}
                                        data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_conteudo is defined %}
                                        data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}"
                                    {% endif %}
                                    {% if item.receita_rodape is defined %}
                                        data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}"
                                    {% endif %}>
                                    <span>Ver detalhes</span>
                                </a>
                                <p class="text-muted d-none">
                                    {{ item.resumo|raw }}
                                </p>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            
        </div>
        {# VENDAS #}
        <div class="tab-pane fade" id="venda" role="tabpanel" aria-labelledby="venda-tab">
            <div class="d-flex justify-content-end my-2">
                <button class="btn btn-success btn-sm" id="btn-adicionar-servico">
                <i class="bi bi-plus-lg me-1"></i> Adicionar
                </button>
            </div>
            <div class="vendas-lista-scroll" style="max-height: 480px; overflow-y: auto;">
                {# Junta vendas pagas + pendentes e ordena por data #}
                {% set todas_vendas = (vendas_pagas|merge(vendas_pendentes)) %}
                {% for v in todas_vendas %}
                    {% set status = v.status %}
                    <div class="card shadow-sm mb-2 rounded-4 border-start border-5
                        {% if status == 'paga' %}
                            border-success
                        {% elseif status == 'pendente' %}
                            border-warning
                        {% else %}
                            border-secondary
                        {% endif %}">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                {# COLUNA ESQUERDA ‚Äî ITENS DA VENDA #}
                                <div class="flex-grow-1 pe-3">
                                    <p class="mb-2 fw-bold">
                                        Venda #{{ v.id }}
                                        <small class="ms-3 fw-normal">
                                        Pagamento via:
                                        {% if v.metodoPagamento %}
                                            {{ v.metodoPagamento|metodoPagamento|raw }}
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Pendente</span>
                                        {% endif %}
                                        </small>
                                    </p>
                                    {# M√âTODO DE PAGAMENTO #}
                                    <p class="mt-2 mb-0">
                                        
                                    </p>
                                    {# LISTA DE ITENS #}
                                    <div class="border rounded-3 p-2 bg-light">
                                        {% if vendas_items[v.id] is defined %}
                                            {% for vitem in vendas_items[v.id] %}
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <div class="text-truncate">
                                                        <span class="fw-semibold">
                                                            {{ vitem.item }}
                                                        </span>
                                                        <small class="text-muted d-block">
                                                        {{ vitem.quantidade }} √ó
                                                        R$ {{ vitem.valor|number_format(2, ',', '.') }}
                                                        </small>
                                                    </div>
                                                    <div class="text-end fw-semibold">
                                                        R$ {{ vitem.subtotal|number_format(2, ',', '.') }}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <p class="text-muted mb-0">Nenhum item na venda.</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                {# COLUNA DIREITA ‚Äî TOTAL E A√á√ïES #}
                                <div class="text-end" style="min-width: 140px;">
                                    <p class="mb-1 text-muted small">Total</p>
                                    <p class="mb-2 fw-bold fs-6 text-success">
                                        R$ {{ v.total|number_format(2, ',', '.') }}
                                    </p>
                                    <div class="d-flex justify-content-end gap-1">
                                        {# Editar venda #}
                                        <button type="button"
                                        class="btn btn-sm btn-primary btn-editar-venda"
                                        data-id="{{ v.id }}"
                                        data-valor="{{ v.total }}"
                                        data-metodo="{{ v.metodoPagamento|default('') }}"
                                        data-status="{{ v.status }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalEditarVenda">
                                        <i class="fas fa-edit"></i>
                                        </button>
                                        {# Inativar venda #}
                                        <form method="POST"
                                            action="{{ path('clinica_inativar_venda', { petId: pet.id, id: v.id }) }}">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-slash-circle"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted text-center mt-3">Nenhuma venda registrada.</p>
                {% endfor %}
            </div>
           {# TOTAL DAS VENDAS (pagas + pendentes) #}
{% set total_vendas = 0 %}

{% for v in todas_vendas %}
    {% set total_vendas = total_vendas + (v.total ?? v.valorFinal ?? 0) %}
{% endfor %}

<div class="d-flex justify-content-between mt-3">
    <h5 class="mb-0">Total</h5>
    <h5 class="mb-0 text-success fw-bold">
        R$ {{ total_vendas|number_format(2, ',', '.') }}
    </h5>
</div>

            {# üß¨ VACINAS #}
            <div class="tab-pane fade" id="vacinas" role="tabpanel" aria-labelledby="vacinas-tab">
                <div class="d-flex justify-content-between align-items-center my-3">
                    <h5 class="mb-0"><i class="fas fa-syringe text-warning me-1"></i> Vacinas Aplicadas</h5>
                    {#                             <a href="#" id="btn-nova-vacina" class="btn btn-warning btn-sm text-dark">
                        <i class="bi bi-capsule me-1"></i> Registrar Nova Vacina
                    </a> #}
                </div>
                {% if vacinas is defined and vacinas|length > 0 %}
                    <div class="table-responsive">
                        <table id="tabelaVacinas" class="table table-striped table-bordered align-middle">
                            <thead class="table-warning text-center">
                                <tr>
                                    <th>#</th>
                                    <th>Tipo</th>
                                    <th>Data Aplica√ß√£o</th>
                                    <th>Validade</th>
                                    <th>Lote</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in vacinas %}
                                    <tr>
                                        <td class="text-center">{{ loop.index }}</td>
                                        <td>{{ v.tipo }}</td>
                                        <td class="text-center">{{ v.data_aplicacao ? v.data_aplicacao|date('d/m/Y') : '‚Äî' }}</td>
                                        <td class="text-center">{{ v.data_validade ? v.data_validade|date('d/m/Y') : '‚Äî' }}</td>
                                        <td class="text-center">{{ v.lote ?: '‚Äî' }}</td>
                                        <td class="text-center">
                                            <form method="POST"
                                                action="{{ path('clinica_vacina_remover', {petId: pet.id, id: v.id}) }}"
                                                onsubmit="return confirm('Remover esta vacina?');">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-secondary text-center mt-3">
                        Nenhuma vacina registrada para este pet.
                    </div>
                {% endif %}
            </div>
            {# üîπ MODAL √öNICO DE EDI√á√ÉO DE VENDA #}
            <div class="modal fade" id="modalEditarVenda" tabindex="-1" aria-hidden="false">
                <div class="modal-dialog">
                    <form id="form-editar-venda" method="POST" class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Editar Venda</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editar-id" name="id">
                            <div class="mb-2">
                                <label class="form-label">Descri√ß√£o</label>
                                <input type="text" id="editar-descricao" name="descricao"
                                class="form-control">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Valor</label>
                                <input type="number" step="0.01" id="editar-valor" name="valor"
                                class="form-control">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Data</label>
                                <input type="date" id="editar-data" name="data" class="form-control">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">M√©todo de Pagamento</label>
                                <input type="text" id="editar-metodo" name="metodo_pagamento"
                                class="form-control">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Observa√ß√£o</label>
                                <textarea id="editar-observacao" name="observacao"
                                class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-editar">
                            Cancelar
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary add-servico">
                        <i class="bi bi-plus-lg"></i> Adicionar novo servi√ßo
                        </button>
                    </form>
                </div>
            </div>
            {# OR√áAMENTOS #}
            <div class="tab-pane fade" id="orcamentos" role="tabpanel" aria-labelledby="orcamentos-tab">
                <p class="text-muted text-center mt-4">Nenhum or√ßamento registrado.</p>
            </div>
            {# AGENDA #}
            <div class="tab-pane fade" id="agenda" role="tabpanel" aria-labelledby="agenda-tab">
                <p class="text-muted text-center mt-4">Conte√∫do da Agenda.</p>
            </div>
        </div>
    </div>
</div>
</div>
</div>
{# MODAL ADICIONAR SERVI√áO #}
<div class="modal fade" id="modalAdicionarServico" tabindex="-1" aria-labelledby="modalAdicionarServicoLabel"
aria-hidden="false">
<div class="modal-dialog modal-lg modal-dialog-centered">
<form class="modal-content" id="form-novo-servico" method="post"
    action="{{ path('clinica_concluir_venda', {'petId': pet.id}) }}">
    <div class="modal-header bg-primary text-white">
        <div class="d-flex flex-column w-100">
            <h5 class="modal-title mb-2" id="modalAdicionarServicoLabel">Adicionar Servi√ßo / Lan√ßamento</h5>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark fs-6 px-3 py-2">
                    <i class="fas fa-calculator me-2"></i>Total: R$ <span id="total-servicos">0,00</span>
                </span>
            </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
        aria-label="Fechar"></button>
    </div>
    <div class="modal-body">
        <div class="mb-3">
            <label for="servico-descricao" class="form-label">Descri√ß√£o do Servi√ßo*</label>
            <select class="form-select" id="servico-descricao-1" name="descricao[]" required>
                <option value="">Selecione um servi√ßo...</option>
                {% for servico in servicos_clinica %}
                    <option value="{{ servico.id }}" data-valor="{{ servico.valor }}">
                        {{ servico.nome }} - R$ {{ servico.valor|number_format(2, ',', '.') }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="servico-desconto" class="form-label">Desconto (R$)</label>
            <input type="number" step="0.01" class="form-control" id="servico-desconto" name="desconto[]"
            value="0">
        </div>
        <div id="servicos-container"></div>
        <div class="mb-3">
            <label for="servico-metodo" class="form-label">M√©todo de Pagamento*</label>
            <select name="metodo_pagamento" id="servico-metodo" class="form-select" required>
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">Pix</option>
                <option value="credito">Cart√£o de Cr√©dito</option>
                <option value="debito">Cart√£o de D√©bito</option>
                <option value="pendente">Pagamento Pendente</option>
            </select>
        </div>
        <div id="cartao-opcoes" class="row d-none">
            <div class="col-md-6 mb-3">
                <label class="form-label">Bandeira do Cart√£o</label>
                <select name="bandeira_cartao" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="Visa">Visa</option>
                    <option value="Mastercard">Mastercard</option>
                    <option value="Elo">Elo</option>
                    <option value="American Express">American Express</option>
                    <option value="Hipercard">Hipercard</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Quantidade de Parcelas</label>
                <input type="number" name="parcelas" class="form-control" min="1" max="12" value="1">
            </div>
        </div>
        <div class="mb-3">
            <label for="servico-data" class="form-label">Data</label>
            <input type="date" class="form-control" id="servico-data" name="data"
            value="{{ "now"|date("Y-m-d") }}">
        </div>
        <div class="mb-3">
            <label for="servico-observacao" class="form-label">Observa√ß√£o</label>
            <textarea class="form-control" id="servico-observacao" name="observacao" rows="2"></textarea>
        </div>
        <input type="hidden" name="origem" value="clinica">
        <input type="hidden" name="pet_id" value="{{ pet.id }}">
    </div>
    <div class="modal-footer d-flex justify-content-between align-items-center flex-wrap">
        <button type="button" class="btn btn-secondary" id="btn-cancelar-servico">
        Cancelar
        </button>
        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-primary add-servico">
            <i class="bi bi-plus-lg"></i> Adicionar novo servi√ßo
            </button>
            <button type="submit" class="btn btn-success">
            <i class="bi bi-check-lg"></i> Concluir / Salvar
            </button>
        </div>
    </div>
</form>
</div>
</div>
{# MODAL DE CONFIRMA√á√ÉO #}
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content border-0 shadow-lg">
    <div class="modal-header bg-warning text-dark border-0">
        <h5 class="modal-title">
        <i class="fas fa-exclamation-triangle me-2"></i>Aten√ß√£o
        </h5>
    </div>
    <div class="modal-body text-center py-4">
        <p class="mb-0" id="mensagem-confirmacao">
            Voc√™ tem dados n√£o salvos. Deseja realmente cancelar e perder as informa√ß√µes?
        </p>
    </div>
    <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-secondary" id="btn-nao-confirmar">
        <i class="fas fa-times me-1"></i>N√£o
        </button>
        <button type="button" class="btn btn-danger" id="btn-sim-confirmar">
        <i class="bi bi-check-lg me-1"></i>Sim, fechar
        </button>
    </div>
</div>
</div>
</div>
{% endblock %}
{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
<script>
$(document).ready(function () {
// === PEGAR ELEMENTOS ===
const $actionButtonsView = $('#action-buttons-view');
const $atendimentoView = $('#atendimento-view');
const $receitaView = $('#receita-view');
const serviceDisplayContainer = $('#service-display-container');
const serviceDetailsContent = document.getElementById('service-details-content');
const $vacinaView = $('#vacina-view');
const $btnNovaVacina = $('#btn-nova-vacina');
const $btnFecharVacina = $('#btn-fechar-vacina');
const $btnNovoAtendimento = $('#btn-novo-atendimento');
const $btnNovaReceita = $('#btn-nova-receita');
const $btnFecharAtendimento = $('#btn-fechar-atendimento');
const $btnFecharReceita = $('#btn-fechar-receita');
const $btnFecharServiceDisplay = $('#btn-fechar-service-display');
const $btnAdicionarServico = $('#btn-adicionar-servico');
const historicoTabElement = $('button[data-bs-target="#historico"]')[0];
let historicoTab = historicoTabElement ? new bootstrap.Tab(historicoTabElement) : null;
// Torna as vari√°veis globais para acesso em outros handlers
// backdrop: 'static' impede fechar ao clicar fora
// keyboard: false impede fechar com ESC
window.modalAdicionarServico = new bootstrap.Modal($('#modalAdicionarServico')[0], {
backdrop: 'static',
keyboard: false
});
window.modalEditarVenda = new bootstrap.Modal($('#modalEditarVenda')[0], {
backdrop: 'static',
keyboard: false
});
window.currentQuillDisplayEditors = [];
const showView = (viewToShow) => {
$actionButtonsView.hide();
$atendimentoView.hide();
$receitaView.hide();
serviceDisplayContainer.hide();
if (viewToShow) $(viewToShow).show();
};
const returnToActionGrid = (e) => {
if (e) e.preventDefault();
window.currentQuillDisplayEditors.forEach(editor => {
if (editor.container && editor.container.parentNode) {
editor.container.parentNode.removeChild(editor.container);
}
});
window.currentQuillDisplayEditors = [];
showView($actionButtonsView);
};
// fechar janela
$('.voltar-dash').on('click', function () {
window.close();
return false;
});
// === LISTENERS B√ÅSICOS ===
$btnNovoAtendimento.on('click', function (e) {
e.preventDefault();
showView($atendimentoView);
});
$btnNovaReceita.on('click', function (e) {
e.preventDefault();
showView($receitaView);
});
const notImplementedButtons = ['btn-novo-peso', 'btn-novo-exame', 'btn-novas-fotos'];
notImplementedButtons.forEach(id => {
$(`#${id}`).on('click', function (e) {
e.preventDefault();
var modal = Notify.modal(`A funcionalidade de "${$(this).text().trim()}" n√£o est√° implementada ainda.`, 'md', 'mensagem do sistema')
$(`#${modal.id}`).find('.modal-header').addClass('text-bg-warning')
// alert();
});
});
$btnFecharAtendimento.on('click', returnToActionGrid);
$btnFecharReceita.on('click', returnToActionGrid);
$btnFecharServiceDisplay.on('click', returnToActionGrid);
// === QUILL EDITORS ===
const toolbarOptions = [
[{'header': [1, 2, 3, false]}],
['bold', 'italic', 'underline', 'strike'],
[{'list': 'ordered'}, {'list': 'bullet'}],
['link'],
['clean']
];
const createQuillEditor = (selector, options = {}) => {
const el = $(selector)[0];
return el ? new Quill(selector, {theme: 'snow', modules: {toolbar: toolbarOptions}, ...options}) : null;
};
const quillAtendimento = createQuillEditor('#atendimento-editor');
const quillConteudo = createQuillEditor('#editor-conteudo');
// === TIMELINE (abre visualiza√ß√£o) ===
const timelineLinks = document.querySelectorAll('.timeline-link');
timelineLinks.forEach(link => {
link.addEventListener('click', function (e) {
e.preventDefault();
const tipo = this.dataset.tipo;
const data = this.dataset.data;
const resumo = this.dataset.resumo;
const observacoes = this.dataset.observacoes;
serviceDetailsContent.innerHTML = '';
window.currentQuillDisplayEditors.forEach(editor => {
if (editor.container && editor.container.parentNode) {
editor.container.parentNode.removeChild(editor.container);
}
});
window.currentQuillDisplayEditors = [];
document.getElementById('service-display-title').textContent = `Detalhes do Registro: ${tipo}`;
const appendServiceDetailCard = (cardTitle, contentData, typeClass, isHtml = false) => {
const cardDiv = document.createElement('div');
cardDiv.className = ` ${typeClass}`;
const cardHeader = document.createElement('h6');
cardHeader.className = 'mb-2';
cardHeader.textContent = cardTitle;
cardDiv.appendChild(cardHeader);
const cardDate = document.createElement('p');
cardDate.className = 'text-muted mb-3';
cardDate.innerHTML = ``;//`<small>Registrado em: ${data}</small>`;
cardDiv.appendChild(cardDate);
const contentDiv = document.createElement('div');
contentDiv.className = 'service-detail-content';
cardDiv.appendChild(contentDiv);
serviceDetailsContent.appendChild(cardDiv);
if (contentData) {
if (isHtml) {
contentDiv.innerHTML = contentData;
} else {
const quillDisplay = new Quill(contentDiv, {
theme: 'bubble',
readOnly: true,
modules: {toolbar: false}
});
window.currentQuillDisplayEditors.push(quillDisplay);
try {
quillDisplay.setContents(contentData.ops[0].insert);
$('.service-detail-content .ql-editor p').html(contentData.ops[0].insert)
// $('.service-detail-content').removeClass('ql-disabled');
} catch {
quillDisplay.setText('Conte√∫do n√£o dispon√≠vel ou formato inv√°lido.');
}
}
} else {
contentDiv.innerHTML = '<p>Nenhum detalhe dispon√≠vel.</p>';
}
};
if (tipo === 'Consulta' || tipo === 'Retorno') {
const anamneseDeltaString = this.dataset.atendimentoDelta;
const borderColorClass = (tipo === 'Consulta') ? 'border-primary' : 'border-success';

// Monta o card com t√≠tulo e observa√ß√µes
const cardDiv = document.createElement('div');
cardDiv.className = `service-detail-card p-3 rounded ${borderColorClass} border-start border-4`;

// T√≠tulo com tipo e observa√ß√µes
const cardHeader = document.createElement('h5');
cardHeader.className = 'mb-2 text-primary';
cardHeader.innerHTML = `<i class="fas fa-stethoscope me-2"></i>${tipo}`;
cardDiv.appendChild(cardHeader);

// Observa√ß√µes/Assunto
if (observacoes) {
const obsDiv = document.createElement('div');
obsDiv.className = 'mb-3 p-2 bg-light rounded';
obsDiv.innerHTML = `<strong>Assunto:</strong> ${observacoes}`;
cardDiv.appendChild(obsDiv);
}

// Data
const cardDate = document.createElement('p');
cardDate.className = 'text-muted mb-3';
cardDate.innerHTML = `<small><i class="fas fa-calendar me-1"></i>Registrado em: ${data}</small>`;
cardDiv.appendChild(cardDate);

// Conte√∫do da anamnese
const contentDiv = document.createElement('div');
contentDiv.className = 'service-detail-content';
cardDiv.appendChild(contentDiv);
serviceDetailsContent.appendChild(cardDiv);

if (anamneseDeltaString) {
try {
const anamneseData = JSON.parse(anamneseDeltaString);
const quillDisplay = new Quill(contentDiv, {
theme: 'bubble',
readOnly: true,
modules: {toolbar: false}
});
window.currentQuillDisplayEditors.push(quillDisplay);
quillDisplay.setContents(anamneseData);
} catch (e) {
contentDiv.innerHTML = '<p class="text-muted">Conte√∫do n√£o dispon√≠vel ou formato inv√°lido.</p>';
}
} else {
contentDiv.innerHTML = '<p class="text-muted">Nenhum detalhe de anamnese dispon√≠vel.</p>';
}
} else if (tipo === 'Receita') {
const cabecalhoHtmlString = this.dataset.receitaCabecalhoHtml;
let conteudoDeltaString = null;
try {
conteudoDeltaString = JSON.parse(this.dataset.receitaConteudoDelta);
} catch(e) {
console.log('Erro ao parsear conte√∫do da receita:', e);
}
const rodapeHtmlString = this.dataset.receitaRodapeHtml;

// Cria container da receita para impress√£o
const receitaContainer = document.createElement('div');
receitaContainer.id = 'receita-para-impressao';
receitaContainer.className = 'receita-container p-4';
receitaContainer.style.cssText = 'border: 1px solid #ddd; border-radius: 12px; background: #fff;';

// Cabe√ßalho
if (cabecalhoHtmlString) {
const cabecalhoDiv = document.createElement('div');
cabecalhoDiv.className = 'receita-cabecalho text-center mb-4 pb-3 border-bottom';
cabecalhoDiv.innerHTML = cabecalhoHtmlString;
receitaContainer.appendChild(cabecalhoDiv);
}

// Conte√∫do
const conteudoDiv = document.createElement('div');
conteudoDiv.className = 'receita-conteudo my-4';
conteudoDiv.style.minHeight = '200px';
receitaContainer.appendChild(conteudoDiv);

if (conteudoDeltaString) {
const quillDisplay = new Quill(conteudoDiv, {
theme: 'bubble',
readOnly: true,
modules: {toolbar: false}
});
window.currentQuillDisplayEditors.push(quillDisplay);
try {
quillDisplay.setContents(conteudoDeltaString);
} catch(e) {
conteudoDiv.innerHTML = '<p>Conte√∫do n√£o dispon√≠vel.</p>';
}
} else {
conteudoDiv.innerHTML = '<p class="text-muted">Nenhum conte√∫do na receita.</p>';
}

// Rodap√©
if (rodapeHtmlString) {
const rodapeDiv = document.createElement('div');
rodapeDiv.className = 'receita-rodape text-center mt-4 pt-3 border-top';
rodapeDiv.innerHTML = rodapeHtmlString;
receitaContainer.appendChild(rodapeDiv);
}

serviceDetailsContent.appendChild(receitaContainer);
if (!cabecalhoHtmlString && !conteudoDeltaString && !rodapeHtmlString) {
receitaContainer.innerHTML = `<div class="text-center p-4"><h6 class="mb-2">Receita M√©dica</h6><p class="text-muted mb-3"><small>Emitida em: ${data}</small></p><p>Nenhum detalhe de receita dispon√≠vel.</p></div>`;
}
} else {
const borderColorClass = 'border-secondary';
const cardDiv = document.createElement('div');
cardDiv.className = `service-detail-card ${borderColorClass}`;
cardDiv.innerHTML = `<h6 class="mb-2">${tipo} - ${resumo}</h6><p class="text-muted mb-3"><small>Data: ${data}</small></p><p>Nenhum detalhe espec√≠fico dispon√≠vel para este tipo de registro no momento.</p>`;
serviceDetailsContent.appendChild(cardDiv);
}
if (tipo === 'Receita') {
Utils.modal(serviceDisplayContainer.html(), 'secondary', null, 'lg', $('#service-display-title').html(), 'Imprimir Receita', 'Fechar', 'imprimir-receita');
$(document).off('click', '.imprimir-receita').on('click', '.imprimir-receita', function () {
// Encontra o container da receita
var elementoParaImprimir = $(this).closest('.modal-content').find('#receita-para-impressao');
if (!elementoParaImprimir.length) {
elementoParaImprimir = $(this).closest('.modal-content').find('#service-details-content');
}
if (!elementoParaImprimir.length) {
alert('N√£o foi poss√≠vel encontrar o conte√∫do da receita.');
return;
}
// Remove qualquer iframe de impress√£o anterior, se existir
$('#iframe-impressao-receita').remove();
// Cria um novo iframe oculto
var iframe = document.createElement('iframe');
iframe.id = 'iframe-impressao-receita';
iframe.style.position = 'fixed';
iframe.style.right = '0';
iframe.style.bottom = '0';
iframe.style.width = '0';
iframe.style.height = '0';
iframe.style.border = '0';
document.body.appendChild(iframe);
var doc = iframe.contentWindow.document;
// Escreve o conte√∫do no iframe com estilos adequados para impress√£o
doc.open();
doc.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Receita M√©dica Veterin√°ria</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Times New Roman', Times, serif;
font-size: 14pt;
line-height: 1.6;
padding: 20mm;
color: #000;
}
.receita-container {
max-width: 100%;
border: none !important;
padding: 0 !important;
}
.receita-cabecalho {
text-align: center;
margin-bottom: 30px;
padding-bottom: 15px;
border-bottom: 2px solid #333;
}
.receita-cabecalho h1,
.receita-cabecalho h2,
.receita-cabecalho h3 {
margin-bottom: 5px;
}
.receita-conteudo {
min-height: 300px;
margin: 30px 0;
padding: 20px 0;
}
.receita-conteudo .ql-editor {
padding: 0 !important;
}
.receita-conteudo p {
margin-bottom: 10px;
}
.receita-rodape {
text-align: center;
margin-top: 50px;
padding-top: 20px;
border-top: 1px solid #333;
}
/* Remove elementos desnecess√°rios */
.border, .border-bottom, .border-top {
border: none !important;
}
.p-4, .p-3, .my-4, .mb-4, .mt-4, .pb-3, .pt-3 {
padding: 0 !important;
margin: 0 !important;
}
@media print {
body {
-webkit-print-color-adjust: exact;
print-color-adjust: exact;
}
@page {
margin: 15mm;
}
}
</style>
</head>
<body>
${elementoParaImprimir.html()}
</body>
</html>
`);
doc.close();
// Fun√ß√£o para remover o iframe com seguran√ßa
const removerIframe = () => {
if (iframe && iframe.parentNode) {
document.body.removeChild(iframe);
}
};
// Quando carregar, imprime
iframe.onload = function () {
setTimeout(() => {
iframe.contentWindow.focus();
iframe.contentWindow.print();
// Detecta fechamento da caixa de impress√£o
iframe.contentWindow.onafterprint = removerIframe;
// Caso a impress√£o n√£o seja conclu√≠da, remove depois de 10s por seguran√ßa
setTimeout(removerIframe, 10000);
}, 300);
};
});
} else {
Utils.modal(serviceDisplayContainer.html(), 'secondary', null, 'lg', $('#service-display-title').html());
}
// if (historicoTab) historicoTab.show();
// showView(serviceDisplayContainer);
});
});
// Mostrar formul√°rio vacina
$btnNovaVacina.on('click', function (e) {
e.preventDefault();
showView($vacinaView);
});
// Fechar formul√°rio vacina
$btnFecharVacina.on('click', returnToActionGrid);
// Submeter vacina
const formVac = document.querySelector('#formNovaVacina');
if (formVac) {
formVac.addEventListener('submit', async e => {
e.preventDefault();
try {
const resp = await fetch(formVac.action, {method: 'POST', body: new FormData(formVac)});
const data = await resp.json();
if (data.ok) {
if (window.Notify && Notify.toast) {
Notify.toast(data.msg || "Vacina registrada!", "success");
} else {
alert(data.msg || "Vacina registrada!");
}
location.reload();
} else {
alert(data.msg || "Erro ao registrar vacina.");
}
} catch (err) {
alert('Erro ao registrar vacina.');
}
});
}
// === SUBMIT DOS FORMUL√ÅRIOS (captura Deltas Quill) ===
const setupFormSubmission = (formId, editorsMap) => {
$(`#${formId}`).on('submit', function () {
$.each(editorsMap, (inputId, quillInstance) => {
const $input = $(`#${inputId}`);
if ($input.length && quillInstance) {
$input.val(JSON.stringify(quillInstance.getContents()));
}
});
});
};
setupFormSubmission('form-atendimento', {'anamnese-input': quillAtendimento});
setupFormSubmission('form-receita', {'conteudo-input': quillConteudo});
// === MODAL ADICIONAR SERVI√áO ===
const $formNovoServico = $('#form-novo-servico');
const $selectServico = $('#servico-descricao-1');
const $inputValor = $('#servico-valor');
const servicosMap = {};
{% for servico in servicos_clinica %}
servicosMap["{{ servico.nome|e('js') }}"] = {{ servico.valor|number_format(2, '.', '') }};
{% endfor %}
$formNovoServico.on('submit', function (e) {
e.preventDefault();
fetch(this.action, {
method: "POST",
body: new FormData(this)
})
.then(r => r.json())
.then(data => {
if (data.status === 'success') {
if (window.Notify && Notify.toast) {
Notify.toast(data.mensagem, "success");
}
// Limpa os dados antes de fechar
$('#servico-descricao-1').val('').trigger('change');
$('#servicos-container').empty();
modalAdicionarServico.hide();
setTimeout(() => location.reload(), 800);
} else {
if (window.Notify && Notify.toast) {
Notify.toast(data.mensagem || "Erro ao registrar servi√ßo.", "danger");
} else {
alert(data.mensagem || "Erro ao registrar servi√ßo.");
}
}
})
.catch(err => {
const errorMessage = (err.message.indexOf('<') === 0) ? "Erro no servidor (verifique logs do backend)." : err.message;
if (window.Notify && Notify.toast) {
Notify.toast(`Erro ao registrar servi√ßo: ${errorMessage}`, "danger");
} else {
alert(`Erro ao registrar servi√ßo: ${errorMessage}`);
}
});
});
$btnAdicionarServico.on('click', function () {
// Limpa o formul√°rio sem fechar o modal
$('#servico-descricao-1').val('').trigger('change');
$('#servicos-container').empty();
$('#cartao-opcoes').addClass('d-none');
$('#total-servicos').text('0,00');
// Se o modal n√£o estiver aberto, abre
if (!$('#modalAdicionarServico').hasClass('show')) {
modalAdicionarServico.show();
}
});
$(document).on('change', '#servico-descricao', function () {
const nomeServico = $(this).val();
$(document).next('input[name="valor[]"]').val($(this).find('option:selected').data('valor'));
// $inputValor.val(servicosMap.hasOwnProperty(nomeServico) ? servicosMap[nomeServico] : '').prop('readonly', false);
});
// === SELECT2 para servi√ßo ===
$('#servico-descricao-1').select2({
dropdownParent: $('#modalAdicionarServico .modal-content'),
placeholder: "Selecione ou pesquise um servi√ßo...",
allowClear: true,
width: '100%',
language: {
noResults: function () {
return "Nenhum servi√ßo encontrado";
}
}
});
// aplica tamb√©m aos selects adicionados dinamicamente
$(document).on('focus', '.servico-item select', function () {
if (!$(this).data('select2')) {
$(this).select2({
placeholder: "Selecione ou pesquise um servi√ßo...",
allowClear: true,
width: '100%',
dropdownParent: $('#modalAdicionarServico'),
});
}
});
// === CAMPO DE DI√ÅRIAS PARA INTERNA√á√ÉO ===
$(document).on('change', 'select[name="descricao[]"]', function () {
const $select = $(this);
const servicoSelecionado = $select.find('option:selected').text().toLowerCase();
const valorBase = parseFloat($select.find('option:selected').data('valor')) || 0;
// remove campo de di√°rias anterior desse servi√ßo
$select.closest('.servico-item, .modal-body').find('.diarias-container').remove();
$select.closest('.servico-item, .modal-body').find('.preview-total').remove();
// cria um id √∫nico baseado no select
const index = $select.attr('id').replace(/\D/g, '') || '1';
if (servicoSelecionado.includes('interna√ß√£o')) {
const htmlDiarias = `
<div class="diarias-container mb-3">
<label for="quantidade-diarias-${index}" class="form-label">Quantidade de Di√°rias</label>
<input type="number" class="form-control quantidade-diarias" id="quantidade-diarias-${index}"
name="quantidade_diarias[]" min="1" value="1" data-valor-base="${valorBase}">
<small class="text-muted">O valor total ser√° calculado automaticamente (valor √ó di√°rias).</small>
<input type="hidden" id="valor-total-${index}" name="valor_calculado[]" value="${valorBase.toFixed(2)}">
<div id="preview-total-${index}" class="preview-total mt-2 fw-bold text-primary"></div>
</div>
`;
$select.closest('.mb-3').after(htmlDiarias);
atualizarTotal($(`#quantidade-diarias-${index}`)); // j√° calcula
}
});
// fun√ß√£o para recalcular automaticamente
function atualizarTotal($input) {
const qtd = parseInt($input.val()) || 1;
const valorBase = parseFloat($input.data('valor-base')) || 0;
const total = valorBase * qtd;
const id = $input.attr('id').replace('quantidade-diarias-', '');
$(`#valor-total-${id}`).val(total.toFixed(2));
$(`#preview-total-${id}`).text(`üí∞ Total: R$ ${total.toFixed(2).replace('.', ',')}`);
}
// escuta mudan√ßas na quantidade de di√°rias
$(document).on('input', '.quantidade-diarias', function () {
atualizarTotal($(this));
});
// === MODAL EDITAR VENDA ===
$(".btn-editar-venda").on("click", function () {
$("#editar-id").val($(this).data("id"));
$("#editar-descricao").val($(this).data("descricao"));
$("#editar-valor").val($(this).data("valor"));
$("#editar-metodo").val($(this).data("metodo"));
$("#editar-data").val($(this).data("data"));
$("#editar-observacao").val($(this).data("observacao"));
$("#form-editar-venda").attr("action",
"{{ path('clinica_editar_venda', {petId: pet.id, id: 'PLACEHOLDER'}) }}".replace('PLACEHOLDER', $(this).data("id"))
);
modalEditarVenda.show();
});
// === INATIVAR VENDA ===
$(".btn-inativar-venda").on("click", function () {
if (!confirm("Tem certeza que deseja inativar esta venda?")) return;
fetch(`/clinica/pet/{{ pet.id }}/venda/${$(this).data("id")}/inativar`, {
method: "POST"
})
.then(r => r.json())
.then(d => {
if (d.status === "success") {
location.reload();
} else {
alert(d.mensagem || "Erro ao inativar venda.");
}
})
.catch(() => alert("Erro ao inativar venda."));
});
$("#form-editar-venda").on("submit", function (e) {
e.preventDefault();
fetch(this.action, {
method: "POST",
body: new FormData(this)
})
.then(r => r.json())
.then(d => {
if (d.status === "success") {
// Limpa os dados antes de fechar
$('#editar-descricao').val('');
$('#editar-valor').val('');
modalEditarVenda.hide();
location.reload();
} else {
alert(d.mensagem);
}
})
.catch(() => alert("Erro ao editar venda."));
});
// Adicionar servi√ßo ao pet correspondente
});
$(document).on("click", ".add-servico", function () {
let index = $(".servico-item").length + 1;
let servicoHtml = `
<div class="mb-3 servico-item border rounded-3 p-3 bg-light">
<div class="mb-3">
<label class="form-label">Descri√ß√£o do Servi√ßo*</label>
<select class="form-select select-servico" name="descricao[]" required id="servico-descricao-${index}">
    <option value="">Selecione um servi√ßo...</option>
    {% for servico in servicos_clinica %}
        <option value="{{ servico.id }}" data-valor="{{ servico.valor }}">
            {{ servico.nome }} - R$ {{ servico.valor|number_format(2, ',', '.') }}
        </option>
    {% endfor %}
</select>
</div>
<div class="mb-3">
<label class="form-label">Desconto (R$)</label>
<input type="number" step="0.01" class="form-control" name="desconto[]" value="0">
</div>
<button type="button" class="btn btn-danger remove-servico">
<i class="bx bx-trash"></i> Remover Servi√ßo
</button>
</div>
`;
$('#servicos-container').append(servicoHtml);
// destr√≥i qualquer inst√¢ncia antiga antes de recriar
const $novoSelect = $(`#servico-descricao-${index}`);
if ($novoSelect.data('select2')) {
$novoSelect.select2('destroy');
}
// ativa o Select2 corretamente dentro do modal
$novoSelect.select2({
dropdownParent: $('#modalAdicionarServico .modal-content'),
placeholder: "Selecione ou pesquise um servi√ßo...",
allowClear: true,
width: '100%'
});
});
// Remover servi√ßo
$(document).on("click", ".remove-servico", function () {
$(this).closest(".servico-item").remove();
calcularTotal();
});
// Fun√ß√£o para calcular o total
function calcularTotal() {
let total = 0;
// Servi√ßo principal
const servicoPrincipal = $('#servico-descricao-1');
if (servicoPrincipal.length && servicoPrincipal.val()) {
let valorPrincipal = parseFloat(servicoPrincipal.find('option:selected').data('valor')) || 0;
const descontoPrincipal = parseFloat($('#servico-desconto').val()) || 0;
// Verifica se tem di√°rias para o servi√ßo principal
const diarias1 = $('#quantidade-diarias-1');
if (diarias1.length && diarias1.val()) {
const qtdDiarias = parseInt(diarias1.val()) || 1;
valorPrincipal = valorPrincipal * qtdDiarias;
}
total += (valorPrincipal - descontoPrincipal);
}
// Servi√ßos adicionais
$('.servico-item').each(function () {
const select = $(this).find('.select-servico');
const desconto = parseFloat($(this).find('input[name="desconto[]"]').val()) || 0;
if (select.val()) {
let valor = parseFloat(select.find('option:selected').data('valor')) || 0;
// Verifica se tem di√°rias para este servi√ßo
const diariasInput = $(this).find('.quantidade-diarias');
if (diariasInput.length && diariasInput.val()) {
const qtdDiarias = parseInt(diariasInput.val()) || 1;
valor = valor * qtdDiarias;
}
total += (valor - desconto);
}
});
// Atualiza o display
$('#total-servicos').text(total.toFixed(2).replace('.', ','));
}
// Atualizar total quando mudar servi√ßo, desconto ou di√°rias
$(document).on('change input', '#servico-descricao-1, #servico-desconto, .select-servico, input[name="desconto[]"], .quantidade-diarias', function () {
calcularTotal();
});
// Calcular total ao abrir o modal
$('#modalAdicionarServico').on('shown.bs.modal', function () {
calcularTotal();
});
$('.modal').on('hidden.modal.bs', function () {
$('.modal-backdrop').remove()
})
$(document).ready(function () {
// Verifica se DataTable est√° dispon√≠vel antes de inicializar
if ($.fn.DataTable && $('#tabelaVacinas').length) {
$('#tabelaVacinas').DataTable({
language: {url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json'},
order: [[2, 'desc']]
});
}
});
$(document).on('change', '#servico-metodo', function () {
const metodo = $(this).val();
if (metodo === 'credito' || metodo === 'debito') {
$('#cartao-opcoes').removeClass('d-none');
} else {
$('#cartao-opcoes').addClass('d-none');
}
});
// === REMOVER VACINA DIRETO DO DASHBOARD ===
$(document).on('submit', 'form[action*="vacina"][action*="remover"]', async function (e) {
e.preventDefault();
if (!confirm("Deseja remover esta vacina?")) return;
const form = this;
try {
const resp = await fetch(form.action, {method: "POST"});
const data = await resp.json();
if (data.ok) {
const row = form.closest("tr");
if (row) {
$(row).fadeOut(300, () => $(row).remove());
}
if (window.Notify && Notify.toast) {
Notify.toast(data.msg || "Vacina removida com sucesso!", "success");
} else {
alert(data.msg || "Vacina removida com sucesso!");
}
} else {
alert(data.msg || "Erro ao remover vacina.");
}
} catch (err) {
alert("Erro ao remover vacina: " + err.message);
}
});
// === CONFIRMA√á√ÉO ANTES DE FECHAR MODAL ===
// Remove o bot√£o X (fechar) do modal para for√ßar uso do Cancelar
$('#modalAdicionarServico .btn-close').remove();
// Cria inst√¢ncia do modal de confirma√ß√£o
const modalConfirmacao = new bootstrap.Modal($('#modalConfirmacao')[0]);
let acaoConfirmacao = null;
// Handler APENAS para o bot√£o Cancelar
$('#btn-cancelar-servico').on('click', function (e) {
e.preventDefault();
const temDados = $('#servico-descricao-1').val() || $('.servico-item').length > 0;
if (temDados) {
// Define a a√ß√£o a ser executada ap√≥s confirma√ß√£o
acaoConfirmacao = function () {
window.modalAdicionarServico.hide();
};
$('#mensagem-confirmacao').text('Voc√™ tem dados n√£o salvos. Deseja realmente cancelar e perder as informa√ß√µes?');
modalConfirmacao.show();
} else {
window.modalAdicionarServico.hide();
}
});
// Handler para o bot√£o "Sim, fechar" do modal de confirma√ß√£o
$('#btn-sim-confirmar').on('click', function () {
modalConfirmacao.hide();
if (acaoConfirmacao) {
acaoConfirmacao();
acaoConfirmacao = null;
}
});
// Handler para o bot√£o "N√£o" do modal de confirma√ß√£o
$('#btn-nao-confirmar').on('click', function () {
modalConfirmacao.hide();
acaoConfirmacao = null;
});
// === CONFIRMA√á√ÉO PARA MODAL EDITAR VENDA ===
// Remove o bot√£o X do modal editar
$('#modalEditarVenda .btn-close').remove();
// Handler APENAS para o bot√£o Cancelar
$('#btn-cancelar-editar').on('click', function (e) {
e.preventDefault();
const temDados = $('#editar-descricao').val() || $('#editar-valor').val();
if (temDados) {
// Define a a√ß√£o a ser executada ap√≥s confirma√ß√£o
acaoConfirmacao = function () {
window.modalEditarVenda.hide();
};
$('#mensagem-confirmacao').text('Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente cancelar?');
modalConfirmacao.show();
} else {
window.modalEditarVenda.hide();
}
});
</script>
{% endblock %}