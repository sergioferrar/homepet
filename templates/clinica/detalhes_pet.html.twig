{% extends 'baseClinica.html.twig' %}

{% block title %}Ficha de Interna√ß√£o - { { internacao.pet_nome }}{% endblock %}


{% block body %}
    {% set total_debitos = total_debitos|default(0) %}

    <div class="container-fluid bg-white p-3 my-4">
        <div class="row">
            <div class="col-8">
                <a href="{{ path('clinica_dashboard') }}" class="btn btn-outline-secondary voltar-dash">
                    <i class="fas fa-arrow-left"></i> Voltar para o Dashboard
                </a>
            </div>
            <div class="col-4">
                <div class="row">
                    <img width="" src="{{ asset('images/pet.jpeg') }}" alt="Avatar do Pet"
                         class="pet-avatar img-responsive border float-start me-4" onerror="this.style.display='none'">
                    <span class="lead-5 float-end">Ficha do Pet: {{ pet.nome }}</span>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3 d-none">


        </div>
        <hr>
        <div class="row mb-4">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="info-card">
                    <h5>
                        {{ pet.dono_nome|default('Tutor n√£o vinculado') }}
                        {% if pet.dono_nome %}
                            <small class="text-muted fw-normal">({{ pet.dono_id }})</small>
                        {% endif %}
                    </h5>

                    <table class="table table-sm mb-2">
                        <tbody>
                        <tr>
                            <th>Telefone:</th>
                            <td>{{ pet.dono_telefone|default('-') }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ pet.dono_email|default('-') }}</td>
                        </tr>
                        <tr>
                            <th>Endere√ßo:</th>
                            <td>{{ pet.dono_endereco|default('-') }}</td>
                        </tr>
                        </tbody>
                    </table>

                    {% if total_debitos > 0 %}
                        <span class="badge text-bg-danger">
                            Saldo devedor de R$ {{ total_debitos|number_format(2, ',', '.') }}
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-6">
                <div class="info-card d-flex justify-content-between align-items-center">
                    <table class="table table-sm" width="100%">
                        <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Ra√ßa</th>
                            <th>Sexo</th>
                            <th>Idade</th>
                            <th>Peso</th>
                            <th>Castra√ß√£o</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>{{ pet.nome }}
                                <small class="text-muted fw-normal">({{ pet.id }})</small></td>
                            <td>{{ pet.raca }}</td>
                            <td>{{ pet.sexo }}</td>
                            <td>{{ pet.idade }} anos</td>
                            <td>{{ pet.peso }} KG</td>
                            <td>
                            <span class="p-2 badge {% if pet.castrado == 1 %} text-bg-success {% else %} text-bg-danger {% endif %}">
                                {% if pet.castrado == 1 %} Castrado {% else %} N√£o √© Castrado {% endif %}
                            </span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <hr>

        <div class="row g-3">
            <div class="col-lg-12">
                <div class="main-card">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="historico-tab" data-bs-toggle="tab"
                                    data-bs-target="#historico" type="button" role="tab" aria-controls="historico"
                                    aria-selected="true">
                                <i class="fas fa-history me-1"></i> Hist√≥rico
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline"
                                    type="button" role="tab" aria-controls="timeline" aria-selected="false">
                                <i class="fas fa-stream me-1"></i> Linha do Tempo
                            </button>
                        </li>
                        {# Decide destino principal: ativa > √∫ltima > nova #}
                        {% set href_internacao = internacao_ativa_id
                            ? path('clinica_ficha_internacao', {'id': internacao_ativa_id})
                            : (ultima_internacao_id
                            ? path('clinica_ficha_internacao', {'id': ultima_internacao_id})
                            : path('clinica_nova_internacao', {'petId': pet.id})
                            ) %}
                        {% set texto_internacao = internacao_ativa_id
                            ? 'Ficha de Interna√ß√£o (ativa)'
                            : (ultima_internacao_id ? 'Ver √∫ltima Ficha de Interna√ß√£o' : 'Nova Interna√ß√£o') %}
                        <li class="nav-item" role="presentation">
                            <a href="{{ href_internacao }}" id="btn-internacao-aba"
                               class="nav-link d-flex align-items-center" title="{{ texto_internacao }}">
                                <i class="bi bi-hospital me-1"></i>
                                <span>{{ texto_internacao }}</span>
                            </a>
                        </li>
                        <li class="nav-item dropdown" role="presentation">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                               aria-expanded="false" title="Todas as interna√ß√µes">
                                Hist√≥rico de interna√ß√µes
                                {% if internacoes_pet is defined and internacoes_pet|length %}
                                    <span class="badge bg-secondary ms-1">{{ internacoes_pet|length }}</span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu">
                                {% if internacoes_pet is defined and internacoes_pet|length %}
                                    {% for i in internacoes_pet %}
                                        <li>
                                            <a class="dropdown-item d-flex justify-content-between align-items-center"
                                               href="{{ path('clinica_ficha_internacao', {'id': i.id}) }}">
                                                <span>#{{ i.id }} ‚Äî {{ i.status|capitalize }}</span>
                                                <small class="text-muted">{{ i.data_inicio|date('d/m/Y H:i') }}</small>
                                            </a>
                                        </li>
                                    {% endfor %}
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                {% else %}
                                    <li><span class="dropdown-item-text text-muted">Nenhuma interna√ß√£o anterior</span>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item"
                                       href="{{ path('clinica_nova_internacao', {'petId': pet.id}) }}">
                                        <i class="bi bi-plus-circle me-1"></i> Nova Interna√ß√£o
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="venda-tab" data-bs-toggle="tab" data-bs-target="#venda"
                                    type="button" role="tab" aria-controls="venda" aria-selected="false">
                                <i class="fas fa-dollar-sign me-1"></i> Venda
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="vacinas-tab" data-bs-toggle="tab"
                                    data-bs-target="#vacinas"
                                    type="button" role="tab" aria-controls="vacinas"
                                    aria-selected="false">
                                <i class="fas fa-syringe me-1 text-warning"></i> Vacinas
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="orcamentos-tab" data-bs-toggle="tab"
                                    data-bs-target="#orcamentos"
                                    type="button" role="tab" aria-controls="orcamentos" aria-selected="false">
                                <i class="fas fa-file-invoice-dollar me-1"></i> Or√ßamentos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda"
                                    type="button" role="tab" aria-controls="agenda" aria-selected="false">
                                <i class="fas fa-calendar-alt me-1"></i> Agenda
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content pt-4" id="consolidatedTabsContent">
                        {# HIST√ìRICO + A√á√ïES #}
                        <div class="tab-pane fade show active" id="historico" role="tabpanel"
                             aria-labelledby="historico-tab">
                            <div id="action-buttons-view" class=" p-4">
                                <h5 class="card-title mb-3">Adicionar Novo Registro</h5>
                                <div class="row action-grid g-3">
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-novo-atendimento"
                                           class="btn btn-primary btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white p-3">
                                            <i class="bi bi-heart-pulse fs-2 mb-2"></i>
                                            <span>Atendimento</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-nova-receita"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                           style="background-color: #6f42c1;">
                                            <i class="bi bi-file-earmark-text fs-2 mb-2"></i>
                                            <span>Receita</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="{{ path('clinica_nova_internacao', {'petId': pet.id}) }}"
                                           id="btn-nova-internacao"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                           style="background-color: #20c997;">
                                            <i class="bi bi-hospital fs-2 mb-2"></i>
                                            <span>Interna√ß√£o</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-novo-peso"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                           style="background-color: #e85d6c;">
                                            <i class="bi bi-rulers fs-2 mb-2"></i>
                                            <span>Peso</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-novo-exame"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                           style="background-color: #e83e8c;">
                                            <i class="bi bi-eyedropper fs-2 mb-2"></i>
                                            <span>Exame</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-novo-documento"
                                           class="btn btn-success btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white">
                                            <i class="bi bi-file-earmark-text fs-2 mb-2"></i>
                                            <span>Documento</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-novas-fotos"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center text-white"
                                           style="background-color: #17a2b8;">
                                            <i class="bi bi-camera fs-2 mb-2"></i>
                                            <span>Fotos</span>
                                        </a>
                                    </div>
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <a href="#" id="btn-nova-vacina"
                                           class="btn btn-block h-100 d-flex flex-column justify-content-center align-items-center"
                                           style="background-color: #ffc107; color: #212529 !important;">
                                            <i class="bi bi-capsule fs-2 mb-2"></i>
                                            <span>Vacina</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            {# FORM ATENDIMENTO #}
                            <div id="atendimento-view" style="display: none;">
                                <form id="form-atendimento" method="POST"
                                      action="{{ path('clinica_novo_atendimento', {'petId': pet.id}) }}">
                                    <div class="form-view-container">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="form-view-header">Novo Atendimento</h5>
                                            <button type="button" class="btn-close" id="btn-fechar-atendimento"
                                                    aria-label="Fechar"></button>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3"><label class="form-label">Tipo*</label><select
                                                        class="form-select" name="tipo">
                                                    <option value="Consulta" selected>Consulta</option>
                                                    <option value="Retorno">Retorno</option>
                                                </select></div>
                                            <div class="col-md-6 mb-3"><label class="form-label">Resumo
                                                    (Observa√ß√µes)</label><input type="text" class="form-control"
                                                                                name="observacoes"></div>
                                        </div>
                                        <div class="mb-3"><label class="form-label">Anamnese / Exame Cl√≠nico</label>
                                            <div id="atendimento-editor"></div>
                                            <input type="hidden" name="anamnese_delta" id="anamnese-input"></div>
                                        <input type="hidden" name="pet_id" value="{{ pet.id }}">
                                        <input type="hidden" name="cliente_id" value="{{ pet.dono_id }}">
                                        <input type="hidden" name="data" value="{{ "now"|date("Y-m-d") }}">
                                        <input type="hidden" name="hora" value="{{ "now"|date("H:i:s") }}">
                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-success"><i
                                                        class="fas fa-save me-1"></i>
                                                Salvar Atendimento
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            {# FORM RECEITA #}
                            <div id="receita-view" style="display: none;">
                                <form id="form-receita" method="POST"
                                      action="{{ path('clinica_nova_receita', {'petId': pet.id}) }}">
                                    <div class="form-view-container">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="form-view-header">Emitir Receita</h5>
                                            <button type="button" class="btn-close" id="btn-fechar-receita"
                                                    aria-label="Fechar"></button>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Conte√∫do da Receita</label>
                                            <div id="editor-conteudo"></div>
                                            <input type="hidden" name="conteudo" id="conteudo-input">
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-primary"><i
                                                        class="fas fa-print me-1"></i>
                                                Gerar PDF e Salvar
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            {# FORM VACINA #}
                            <div id="vacina-view" style="display: none;">
                                <form id="formNovaVacina" method="POST" 
                                      action="{{ path('clinica_vacina_nova', {'petId': pet.id}) }}">
                                    <div class="form-view-container">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="form-view-header">Registrar Vacina</h5>
                                            <button type="button" class="btn-close" id="btn-fechar-vacina" aria-label="Fechar"></button>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Tipo da Vacina*</label>
                                                <input type="text" class="form-control" name="tipo" required>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Data de Aplica√ß√£o*</label>
                                                <input type="date" class="form-control" name="data_aplicacao" 
                                                       value="{{ "now"|date("Y-m-d") }}" required>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Validade*</label>
                                                <input type="date" class="form-control" name="data_validade" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Lote</label>
                                                <input type="text" class="form-control" name="lote">
                                            </div>
                                        </div>

                                        <input type="hidden" name="pet_id" value="{{ pet.id }}">

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="bi bi-capsule me-1"></i> Salvar Vacina
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>




                            {# VISUALIZA√á√ÉO DETALHES #}
                            <div id="service-display-container"
                                 class="card border border-dark bg-white rounded-4  mt-4" style="display: none;">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="card-title mb-0 d-none" id="service-display-title">Detalhes do Registro</h5>
                                        <button type="button" class="btn-close d-none" id="btn-fechar-service-display"
                                                aria-label="Fechar"></button>
                                    </div>
                                    <div id="service-details-content"></div>
                                </div>
                            </div>
                        </div>

                        {# LINHA DO TEMPO #}
                        <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab"
                             style="max-height: 440px; overflow-y: auto;">
                            <ul class="timeline">
                                {% set linha = '' %}
                                {% for item in timeline_items %}

                                <li>
                                    <div class="timeline-badge "><i class="fas fa-calendar"></i></div>
                                    <div class="timeline-panel border  {{ 'Consulta' in item.tipo ? 'border-start border-5 border-primary ps-3' :
                                    'Retorno' in item.tipo ? 'border-start border-5 border-success ps-3' :
                                    'Vacina' in item.tipo ? 'border-start border-5 border-warning ps-3' :
                                    'Receita' in item.tipo ? 'border-start border-5 ps-3' :
                                    'border-start border-5 border-dark ps-3' }}"
                                         {% if 'Receita' in item.tipo %}style="border-left: 5px solid #6f42c1 !important;"{% endif %}>
                                        <div class="timeline-heading">
                                            <h4 class="timeline-title">
                                                <a href="#"
                                                   class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                                   data-tipo="{{ item.tipo }}"
                                                   data-data="{{ item.data|date('d/m/Y \\√†\\s H:i') }}"
                                                   data-resumo="{{ item.resumo|default('Ver detalhes')|e('html_attr') }}"
                                                        {% if item.anamnese is defined %} data-atendimento-delta="{{ item.anamnese|e('html_attr') }}" {% endif %}
                                                        {% if item.receita_cabecalho is defined %} data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}" {% endif %}
                                                        {% if item.receita_conteudo is defined %} data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}" {% endif %}
                                                        {% if item.receita_rodape is defined %} data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}" {% endif %}>
                                                    <span>{{ item.tipo }}</span>
                                                </a>
                                            </h4>
                                            <p>
                                                <small class="text-muted">
                                                    {{ item.data|date('d/m/Y \\√†\\s H:i') }}
                                                </small>
                                            </p>

                                        </div>
                                        <div class="timeline-body">
                                            <a href="#"
                                               class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                               data-tipo="{{ item.tipo }}"
                                               data-data="{{ item.data|date('d/m/Y \\√†\\s H:i') }}"
                                               data-resumo="{{ item.resumo|default('Ver detalhes')|e('html_attr') }}"
                                                    {% if item.anamnese is defined %} data-atendimento-delta="{{ item.anamnese|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_cabecalho is defined %} data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_conteudo is defined %} data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_rodape is defined %} data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}" {% endif %}>
                                                <span>{{ item.tipo }}</span>
                                            </a>
                                            <p class="text-muted">{{ item.resumo|default('Ver detalhes') }}</p>
                                        </div>
                                    </div>
                                </li>
                                <li class="{{ linha }} d-none ">
                                    <div class="timeline-badge"><i class="bi calendar2-check"></i></div>
                                    <div class="timeline-panel border
                                                {{ 'Consulta' in item.tipo ? 'border-start border-5 border-primary ps-3' :
                                    'Retorno' in item.tipo ? 'border-start border-5 border-success ps-3' :
                                    'Vacina' in item.tipo ? 'border-start border-5 border-warning ps-3' :
                                    'Receita' in item.tipo ? 'border-start border-5 ps-3' :
                                    'border-start border-5 border-dark ps-3' }}"
                                         {% if 'Receita' in item.tipo %}style="border-left: 5px solid #6f42c1 !important;"{% endif %}
                                    ">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">
                                            <a href="#"
                                               class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                               data-tipo="{{ item.tipo }}"
                                               data-data="{{ item.data|date('d/m/Y \\√†\\s H:i') }}"
                                               data-resumo="{{ item.resumo|default('Ver detalhes')|e('html_attr') }}"
                                                    {% if item.anamnese is defined %} data-atendimento-delta="{{ item.anamnese|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_cabecalho is defined %} data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_conteudo is defined %} data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_rodape is defined %} data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}" {% endif %}>
                                                <span>{{ item.tipo }}</span>
                                            </a>
                                        </h4>
                                        <p><small class="text-muted"><i
                                                        class="bi smartwatch"></i> {{ item.data|date('d/m/Y \\√†\\s H:i') }}
                                            </small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <a href="#"
                                           class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                           data-tipo="{{ item.tipo }}"
                                           data-data="{{ item.data|date('d/m/Y \\√†\\s H:i') }}"
                                           data-resumo="{{ item.resumo|default('Ver detalhes')|e('html_attr') }}"
                                                {% if item.anamnese is defined %} data-atendimento-delta="{{ item.anamnese|e('html_attr') }}" {% endif %}
                                                {% if item.receita_cabecalho is defined %} data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}" {% endif %}
                                                {% if item.receita_conteudo is defined %} data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}" {% endif %}
                                                {% if item.receita_rodape is defined %} data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}" {% endif %}>
                                            <span>{{ item.tipo }}</span>
                                        </a>
                                        <small class="text-muted float-end fst-italic me-2">{{ item.resumo|default('Ver detalhes') }}</small>
                                    </div>
                        </div>
                        </li>
                        {% endfor %}
                        </ul>
                        <ul class="timelines d-none" style="max-height: 440px; overflow-y: auto;">
                            {% set linha = '' %}
                            {% for key,item in timeline_items %}
                                {% set linha = key%2? '': 'timeline-inverted' %}
                                <li class="timeline-item" style="list-style: none;">

                                    <div class="card shadow-sm mb-3 rounded-4 bg-light border"
                                         style="border-width: 1.5px; border-radius: 15px !important;">
                                        <div class="border
                                                {{ 'Consulta' in item.tipo ? 'border-start border-5 border-primary ps-3' :
                                        'Retorno' in item.tipo ? 'border-start border-5 border-success ps-3' :
                                        'Vacina' in item.tipo ? 'border-start border-5 border-warning ps-3' :
                                        'Receita' in item.tipo ? 'border-start border-5 ps-3' :
                                        'border-start border-5 border-dark ps-3' }}"
                                             {% if 'Receita' in item.tipo %}style="border-left: 5px solid #6f42c1 !important;"{% endif %}>
                                            <p class="timeline-date">{{ item.data|date('d/m/Y \\√†\\s H:i') }}</p>
                                            <a href="#"
                                               class="timeline-link timeline-text d-flex justify-content-between align-items-center"
                                               data-tipo="{{ item.tipo }}"
                                               data-data="{{ item.data|date('d/m/Y \\√†\\s H:i') }}"
                                               data-resumo="{{ item.resumo|default('Ver detalhes')|e('html_attr') }}"
                                                    {% if item.anamnese is defined %} data-atendimento-delta="{{ item.anamnese|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_cabecalho is defined %} data-receita-cabecalho-html="{{ item.receita_cabecalho|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_conteudo is defined %} data-receita-conteudo-delta="{{ item.receita_conteudo|e('html_attr') }}" {% endif %}
                                                    {% if item.receita_rodape is defined %} data-receita-rodape-html="{{ item.receita_rodape|e('html_attr') }}" {% endif %}>
                                                <span>{{ item.tipo }}</span>
                                                <small class="text-muted fst-italic me-2">{{ item.resumo|default('Ver detalhes') }}</small>
                                            </a>
                                        </div>
                                    </div>
                                </li>
                            {% else %}
                                <li class="ms-2">Nenhum evento na linha do tempo.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {# VENDAS #}
                    <div class="tab-pane fade" id="venda" role="tabpanel" aria-labelledby="venda-tab">
                        <div class="d-flex justify-content-end my-2">
                            <button class="btn btn-success btn-sm" id="btn-adicionar-servico">
                                <i class="fas fa-plus me-1"></i> Adicionar
                            </button>
                        </div>

                        <div class="vendas-lista-scroll" style="max-height: 480px; overflow-y: auto;">
                            {% set todos_financeiros = (financeiro|merge(financeiroPendente is defined ? financeiroPendente : []))|sort((a, b) => b.data|date('U') <=> a.data|date('U')) %}
                            {% for f in todos_financeiros %}
                                {% set status = f.status is defined ? f.status : (f.metodo_pagamento is defined and f.metodo_pagamento == 'pendente' ? 'pendente' : 'concluido') %}
                                <div class="card shadow-sm mb-2 rounded-4 border-start border-5
                                {% if status == 'concluido' %}
                                  border-success
                                {% elseif status == 'pendente' %}
                                  border-warning
                                {% else %}
                                  border-success
                                {% endif %}">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <p class="mb-0 fw-bold">{{ f.descricao }}</p>
                                                <small class="text-muted">{{ f.data|date('d/m/Y') }}</small>
                                            </div>
                                            <div class="text-end">
                                                <p class="mb-0 fw-bold">R$ {{ f.valor|number_format(2, ',', '.') }}</p>

                                                <div class="d-flex justify-content-end mt-1">
                                                    {# Bot√£o Editar abre modal √∫nico #}
                                                    <button type="button"
                                                            class="btn btn-sm btn-primary btn-editar-venda me-1"
                                                            data-id="{{ f.id }}"
                                                            data-descricao="{{ f.descricao }}"
                                                            data-valor="{{ f.valor }}"
                                                            data-data="{{ f.data|date('Y-m-d') }}"
                                                            data-metodo="{{ f.metodo_pagamento|default('') }}"
                                                            data-observacao="{{ f.observacoes|default('') }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalEditarVenda">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </button>

                                                    {# Bot√£o Inativar #}
                                                    <form method="POST"
                                                          action="{{ path('clinica_inativar_venda', {petId: pet.id, id: f.id}) }}">
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-ban"></i> Inativar
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-muted text-center mt-3">Nenhum item na venda.</p>
                            {% endfor %}
                        </div>

                        {% set total_vendas = 0 %}
                        {% for f in todos_financeiros %}
                            {% set total_vendas = total_vendas + (f.valor ?? 0) %}
                        {% endfor %}

                        <div class="d-flex justify-content-between mt-3">
                            <h5 class="mb-0">Total</h5>
                            <h5 class="mb-0 text-success fw-bold">R$ {{ total_vendas|number_format(2, ',', '.') }}</h5>
                        </div>
                    </div>

                    {# üß¨ VACINAS #}
                    <div class="tab-pane fade" id="vacinas" role="tabpanel" aria-labelledby="vacinas-tab">
                        <div class="d-flex justify-content-between align-items-center my-3">
                            <h5 class="mb-0"><i class="fas fa-syringe text-warning me-1"></i> Vacinas Aplicadas</h5>
{#                             <a href="#" id="btn-nova-vacina" class="btn btn-warning btn-sm text-dark">
                                <i class="bi bi-capsule me-1"></i> Registrar Nova Vacina
                            </a> #}
                        </div>

                        {% if vacinas is defined and vacinas|length > 0 %}
                            <div class="table-responsive">
                                <table id="tabelaVacinas" class="table table-striped table-bordered align-middle">
                                    <thead class="table-warning text-center">
                                        <tr>
                                            <th>#</th>
                                            <th>Tipo</th>
                                            <th>Data Aplica√ß√£o</th>
                                            <th>Validade</th>
                                            <th>Lote</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for v in vacinas %}
                                            <tr>
                                                <td class="text-center">{{ loop.index }}</td>
                                                <td>{{ v.tipo }}</td>
                                                <td class="text-center">{{ v.data_aplicacao ? v.data_aplicacao|date('d/m/Y') : '‚Äî' }}</td>
                                                <td class="text-center">{{ v.data_validade ? v.data_validade|date('d/m/Y') : '‚Äî' }}</td>
                                                <td class="text-center">{{ v.lote ?: '‚Äî' }}</td>
                                                <td class="text-center">
                                                    <form method="POST"
                                                          action="{{ path('clinica_vacina_remover', {petId: pet.id, id: v.id}) }}"
                                                          onsubmit="return confirm('Remover esta vacina?');">
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-secondary text-center mt-3">
                                Nenhuma vacina registrada para este pet.
                            </div>
                        {% endif %}
                    </div>


                    {# üîπ MODAL √öNICO DE EDI√á√ÉO DE VENDA #}
                    <div class="modal fade" id="modalEditarVenda" tabindex="-1" aria-hidden="false">
                        <div class="modal-dialog">
                            <form id="form-editar-venda" method="POST" class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Editar Venda</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="editar-id" name="id">
                                    <div class="mb-2">
                                        <label class="form-label">Descri√ß√£o</label>
                                        <input type="text" id="editar-descricao" name="descricao" class="form-control">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Valor</label>
                                        <input type="number" step="0.01" id="editar-valor" name="valor"
                                               class="form-control">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Data</label>
                                        <input type="date" id="editar-data" name="data" class="form-control">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">M√©todo de Pagamento</label>
                                        <input type="text" id="editar-metodo" name="metodo_pagamento"
                                               class="form-control">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Observa√ß√£o</label>
                                        <textarea id="editar-observacao" name="observacao"
                                                  class="form-control"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Salvar</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar
                                    </button>
                                </div>
                                <button type="button" class="btn btn-primary add-servico">
                                    <i class="fas fa-plus"></i> Adicionar novo servi√ßo
                                </button>

                            </form>
                        </div>
                    </div>


                    {# OR√áAMENTOS #}
                    <div class="tab-pane fade" id="orcamentos" role="tabpanel" aria-labelledby="orcamentos-tab">
                        <p class="text-muted text-center mt-4">Nenhum or√ßamento registrado.</p>
                    </div>

                    {# AGENDA #}
                    <div class="tab-pane fade" id="agenda" role="tabpanel" aria-labelledby="agenda-tab">
                        <p class="text-muted text-center mt-4">Conte√∫do da Agenda.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    {# MODAL ADICIONAR SERVI√áO #}
    <div class="modal fade" id="modalAdicionarServico" tabindex="-1" aria-labelledby="modalAdicionarServicoLabel"
         aria-hidden="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <form class="modal-content" id="form-novo-servico" method="post"
                  action="{{ path('clinica_concluir_venda', {'petId': pet.id}) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAdicionarServicoLabel">Adicionar Servi√ßo / Lan√ßamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="servico-descricao" class="form-label">Descri√ß√£o do Servi√ßo*</label>
                        <select class="form-select" id="servico-descricao-1" name="descricao[]" required>
                            <option value="">Selecione um servi√ßo...</option>
                            {% for servico in servicos_clinica %}
                                <option value="{{ servico.id }}" data-valor="{{ servico.valor }}">
                                    {{ servico.nome }} - R$ {{ servico.valor|number_format(2, ',', '.') }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="servico-desconto" class="form-label">Desconto (R$)</label>
                        <input type="number" step="0.01" class="form-control" id="servico-desconto" name="desconto[]"
                               value="0">
                    </div>

                    <div id="servicos-container"></div>

                    <div class="mb-3">
                        <label for="servico-metodo" class="form-label">M√©todo de Pagamento*</label>
                        <select name="metodo_pagamento" id="servico-metodo" class="form-select" required>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">Pix</option>
                            <option value="credito">Cart√£o de Cr√©dito</option>
                            <option value="debito">Cart√£o de D√©bito</option>
                            <option value="pendente">Pagamento Pendente</option>
                        </select>
                    </div>
                    <div id="cartao-opcoes" class="row d-none">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Bandeira do Cart√£o</label>
                            <select name="bandeira_cartao" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Visa">Visa</option>
                                <option value="Mastercard">Mastercard</option>
                                <option value="Elo">Elo</option>
                                <option value="American Express">American Express</option>
                                <option value="Hipercard">Hipercard</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantidade de Parcelas</label>
                            <input type="number" name="parcelas" class="form-control" min="1" max="12" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="servico-data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="servico-data" name="data"
                               value="{{ "now"|date("Y-m-d") }}">
                    </div>
                    <div class="mb-3">
                        <label for="servico-observacao" class="form-label">Observa√ß√£o</label>
                        <textarea class="form-control" id="servico-observacao" name="observacao" rows="2"></textarea>
                    </div>
                    <input type="hidden" name="origem" value="clinica">
                    <input type="hidden" name="pet_id" value="{{ pet.id }}">
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center flex-wrap">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-primary add-servico">
                            <i class="fas fa-plus"></i> Adicionar novo servi√ßo
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Concluir / Salvar
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>

{% endblock %}
{% block javascripts %}
    <script>
        $(document).ready(function () {
            // === PEGAR ELEMENTOS ===
            const $actionButtonsView = $('#action-buttons-view');
            const $atendimentoView = $('#atendimento-view');
            const $receitaView = $('#receita-view');
            const serviceDisplayContainer = $('#service-display-container');
            const serviceDetailsContent = document.getElementById('service-details-content');

            const $vacinaView = $('#vacina-view');
            const $btnNovaVacina = $('#btn-nova-vacina');
            const $btnFecharVacina = $('#btn-fechar-vacina');

            const $btnNovoAtendimento = $('#btn-novo-atendimento');
            const $btnNovaReceita = $('#btn-nova-receita');
            const $btnFecharAtendimento = $('#btn-fechar-atendimento');
            const $btnFecharReceita = $('#btn-fechar-receita');
            const $btnFecharServiceDisplay = $('#btn-fechar-service-display');
            const $btnAdicionarServico = $('#btn-adicionar-servico');

            const historicoTabElement = $('button[data-bs-target="#historico"]')[0];
            let historicoTab = historicoTabElement ? new bootstrap.Tab(historicoTabElement) : null;

            const modalAdicionarServico = new bootstrap.Modal($('#modalAdicionarServico')[0]);
            const modalEditarVenda = new bootstrap.Modal($('#modalEditarVenda')[0]);

            window.currentQuillDisplayEditors = [];

            const showView = (viewToShow) => {
                $actionButtonsView.hide();
                $atendimentoView.hide();
                $receitaView.hide();
                serviceDisplayContainer.hide();
                if (viewToShow) $(viewToShow).show();
            };

            const returnToActionGrid = (e) => {
                if (e) e.preventDefault();
                window.currentQuillDisplayEditors.forEach(editor => {
                    if (editor.container && editor.container.parentNode) {
                        editor.container.parentNode.removeChild(editor.container);
                    }
                });
                window.currentQuillDisplayEditors = [];
                showView($actionButtonsView);
            };

            // fechar janela
            $('.voltar-dash').on('click', function () {
                window.close();
                return false;
            });

            // === LISTENERS B√ÅSICOS ===
            $btnNovoAtendimento.on('click', function (e) {
                e.preventDefault();
                showView($atendimentoView);
            });
            $btnNovaReceita.on('click', function (e) {
                e.preventDefault();
                showView($receitaView);
            });

            const notImplementedButtons = ['btn-novo-peso', 'btn-novo-exame', 'btn-novo-documento', 'btn-novas-fotos'];
            notImplementedButtons.forEach(id => {
                $(`#${id}`).on('click', function (e) {
                    e.preventDefault();
                    var modal = Notify.modal(`A funcionalidade de "${$(this).text().trim()}" n√£o est√° implementada ainda.`, 'md', 'mensagem do sistema')
                    $(`#${modal.id}`).find('.modal-header').addClass('text-bg-warning')
                    // alert();
                });
            });

            $btnFecharAtendimento.on('click', returnToActionGrid);
            $btnFecharReceita.on('click', returnToActionGrid);
            $btnFecharServiceDisplay.on('click', returnToActionGrid);

            // === QUILL EDITORS ===
            const toolbarOptions = [
                [{'header': [1, 2, 3, false]}],
                ['bold', 'italic', 'underline', 'strike'],
                [{'list': 'ordered'}, {'list': 'bullet'}],
                ['link'],
                ['clean']
            ];
            const createQuillEditor = (selector, options = {}) => {
                const el = $(selector)[0];
                return el ? new Quill(selector, {theme: 'snow', modules: {toolbar: toolbarOptions}, ...options}) : null;
            };
            const quillAtendimento = createQuillEditor('#atendimento-editor');
            const quillConteudo = createQuillEditor('#editor-conteudo');

           // === TIMELINE (abre visualiza√ß√£o) ===
            const timelineLinks = document.querySelectorAll('.timeline-link');
            timelineLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tipo = this.dataset.tipo;
                    const data = this.dataset.data;
                    const resumo = this.dataset.resumo;
                    serviceDetailsContent.innerHTML = '';
                    window.currentQuillDisplayEditors.forEach(editor => {
                        if (editor.container && editor.container.parentNode) {
                            editor.container.parentNode.removeChild(editor.container);
                        }
                    });
                    window.currentQuillDisplayEditors = [];
                    document.getElementById('service-display-title').textContent = `Detalhes do Registro: ${tipo}`;

                    const appendServiceDetailCard = (cardTitle, contentData, typeClass, isHtml = false) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `service-detail-card ${typeClass}`;
                        const cardHeader = document.createElement('h6');
                        cardHeader.className = 'mb-2';
                        cardHeader.textContent = cardTitle;
                        cardDiv.appendChild(cardHeader);
                        const cardDate = document.createElement('p');
                        cardDate.className = 'text-muted mb-3';
                        cardDate.innerHTML = `<small>Registrado em: ${data}</small>`;
                        cardDiv.appendChild(cardDate);
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'service-detail-content';
                        cardDiv.appendChild(contentDiv);
                        serviceDetailsContent.appendChild(cardDiv);

                        if (contentData) {
                            if (isHtml) {
                                contentDiv.innerHTML = contentData;
                            } else {
                                const quillDisplay = new Quill(contentDiv, { theme: 'bubble', readOnly: true, modules: { toolbar: false } });
                                window.currentQuillDisplayEditors.push(quillDisplay);
                                try { quillDisplay.setContents(JSON.parse(contentData)); }
                                catch { quillDisplay.setText('Conte√∫do n√£o dispon√≠vel ou formato inv√°lido.'); }
                            }
                        } else {
                            contentDiv.innerHTML = '<p>Nenhum detalhe dispon√≠vel.</p>';
                        }
                    };

                    if (tipo === 'Consulta' || tipo === 'Retorno') {
                        const anamneseDeltaString = this.dataset.atendimentoDelta;
                        const borderColorClass = (tipo === 'Consulta') ? 'border-primary' : 'border-success';
                        appendServiceDetailCard(`Atendimento: ${resumo}`, anamneseDeltaString, borderColorClass);
                    } else if (tipo === 'Receita') {
                        const cabecalhoHtmlString = this.dataset.receitaCabecalhoHtml;
                        const conteudoDeltaString = this.dataset.receitaConteudoDelta;
                        const rodapeHtmlString = this.dataset.receitaRodapeHtml;
                        const borderColorClass = 'border-purple';
                        
                        if (cabecalhoHtmlString) appendServiceDetailCard('ü©∫', cabecalhoHtmlString, borderColorClass, true);
                        if (conteudoDeltaString) appendServiceDetailCard('üìÑ ', conteudoDeltaString, borderColorClass);
                        if (rodapeHtmlString) appendServiceDetailCard('üìÖ ', rodapeHtmlString, borderColorClass, true);

                        var receita = '';
                        receita += cabecalhoHtmlString;
                        receita += conteudoDeltaString;
                        receita += rodapeHtmlString;

                        if (!cabecalhoHtmlString && !conteudoDeltaString && !rodapeHtmlString) {
                            const cardDiv = document.createElement('div');
                            cardDiv.className = `service-detail-card ${borderColorClass}`;
                            cardDiv.innerHTML = `<h6 class="mb-2">Receita M√©dica - ${resumo}</h6><p class="text-muted mb-3"><small>Emitida em: ${data}</small></p><p>Nenhum detalhe de receita dispon√≠vel.</p>`;
                            serviceDetailsContent.appendChild(cardDiv);
                        } else {
                            const printButtonDiv = document.createElement('div');
                            printButtonDiv.className = 'text-end mt-3';
                            printButtonDiv.innerHTML = `<button class="btn btn-primary"><i class="fas fa-print me-1"></i> Imprimir Receita</button>`;
                            serviceDetailsContent.appendChild(printButtonDiv);
                        }
                    } else {
                        const borderColorClass = 'border-secondary';
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `service-detail-card ${borderColorClass}`;
                        cardDiv.innerHTML = `<h6 class="mb-2">${tipo} - ${resumo}</h6><p class="text-muted mb-3"><small>Data: ${data}</small></p><p>Nenhum detalhe espec√≠fico dispon√≠vel para este tipo de registro no momento.</p>`;
                        serviceDetailsContent.appendChild(cardDiv);
                    }

                    Utils.modal(serviceDisplayContainer.html(), 'secondary', null, 'lg', $('#service-display-title').html());
                    // if (historicoTab) historicoTab.show();
                    // showView(serviceDisplayContainer);
                });
            });

            // Mostrar formul√°rio vacina
            $btnNovaVacina.on('click', function (e) {
                e.preventDefault();
                showView($vacinaView);
            });

            // Fechar formul√°rio vacina
            $btnFecharVacina.on('click', returnToActionGrid);

            // Submeter vacina
            const formVac = document.querySelector('#formNovaVacina');
            if (formVac) {
                formVac.addEventListener('submit', async e => {
                    e.preventDefault();
                    try {
                        const resp = await fetch(formVac.action, {method: 'POST', body: new FormData(formVac)});
                        const data = await resp.json();
                        if (data.ok) {
                            if (window.Notify && Notify.toast) {
                                Notify.toast(data.msg || "Vacina registrada!", "success");
                            } else {
                                alert(data.msg || "Vacina registrada!");
                            }
                            location.reload();
                        } else {
                            alert(data.msg || "Erro ao registrar vacina.");
                        }
                    } catch (err) {
                        alert('Erro ao registrar vacina.');
                    }
                });
            }


            // === SUBMIT DOS FORMUL√ÅRIOS (captura Deltas Quill) ===
            const setupFormSubmission = (formId, editorsMap) => {
                $(`#${formId}`).on('submit', function () {
                    $.each(editorsMap, (inputId, quillInstance) => {
                        const $input = $(`#${inputId}`);
                        if ($input.length && quillInstance) {
                            $input.val(JSON.stringify(quillInstance.getContents()));
                        }
                    });
                });
            };
            setupFormSubmission('form-atendimento', {'anamnese-input': quillAtendimento});
            setupFormSubmission('form-receita', {'conteudo-input': quillConteudo});

            // === MODAL ADICIONAR SERVI√áO ===
            const $formNovoServico = $('#form-novo-servico');
            const $selectServico = $('#servico-descricao-1');
            const $inputValor = $('#servico-valor');
            const servicosMap = {};
            {% for servico in servicos_clinica %}
            servicosMap["{{ servico.nome|e('js') }}"] = {{ servico.valor|number_format(2, '.', '') }};
            {% endfor %}

            $formNovoServico.on('submit', function (e) {
                e.preventDefault();
                fetch(this.action, {
                    method: "POST",
                    body: new FormData(this)
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (window.Notify && Notify.toast) {
                                Notify.toast(data.mensagem, "success");
                            }
                            modalAdicionarServico.hide();
                            setTimeout(() => location.reload(), 800);
                        } else {
                            if (window.Notify && Notify.toast) {
                                Notify.toast(data.mensagem || "Erro ao registrar servi√ßo.", "danger");
                            } else {
                                alert(data.mensagem || "Erro ao registrar servi√ßo.");
                            }
                        }
                    })
                    .catch(err => {
                        const errorMessage = (err.message.indexOf('<') === 0) ? "Erro no servidor (verifique logs do backend)." : err.message;
                        if (window.Notify && Notify.toast) {
                            Notify.toast(`Erro ao registrar servi√ßo: ${errorMessage}`, "danger");
                        } else {
                            alert(`Erro ao registrar servi√ßo: ${errorMessage}`);
                        }
                    });
            });

            $btnAdicionarServico.on('click', function () {
                $('.modal').modal('hide'); 
                $('#servico-descricao-1').val('').trigger('change');
                $('#servicos-container').empty();
                $('#cartao-opcoes').addClass('d-none');
                modalAdicionarServico.show();
            });

            $(document).on('change', '#servico-descricao', function () {
                console.log($(this))
                // console.log($(this).find('option:selected').data('valor'))
                const nomeServico = $(this).val();

                $(document).next('input[name="valor[]"]').val($(this).find('option:selected').data('valor'));
                // $inputValor.val(servicosMap.hasOwnProperty(nomeServico) ? servicosMap[nomeServico] : '').prop('readonly', false);
            });

            // === SELECT2 para servi√ßo ===
            $('#servico-descricao-1').select2({
                dropdownParent: $('#modalAdicionarServico .modal-content'),
                placeholder: "Selecione ou pesquise um servi√ßo...",
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function () {
                        return "Nenhum servi√ßo encontrado";
                    }
                }
            });


            // aplica tamb√©m aos selects adicionados dinamicamente
            $(document).on('focus', '.servico-item select', function () {
                if (!$(this).data('select2')) {
                    $(this).select2({
                        placeholder: "Selecione ou pesquise um servi√ßo...",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#modalAdicionarServico'),
                    });
                }
         });

        // === CAMPO DE DI√ÅRIAS PARA INTERNA√á√ÉO ===
        $(document).on('change', 'select[name="descricao[]"]', function () {
            const $select = $(this);
            const servicoSelecionado = $select.find('option:selected').text().toLowerCase();
            const valorBase = parseFloat($select.find('option:selected').data('valor')) || 0;

            // remove campo de di√°rias anterior desse servi√ßo
            $select.closest('.servico-item, .modal-body').find('.diarias-container').remove();
            $select.closest('.servico-item, .modal-body').find('.preview-total').remove();

            // cria um id √∫nico baseado no select
            const index = $select.attr('id').replace(/\D/g, '') || '1';

            if (servicoSelecionado.includes('interna√ß√£o')) {
                const htmlDiarias = `
                    <div class="diarias-container mb-3">
                        <label for="quantidade-diarias-${index}" class="form-label">Quantidade de Di√°rias</label>
                        <input type="number" class="form-control quantidade-diarias" id="quantidade-diarias-${index}"
                               name="quantidade_diarias[]" min="1" value="1" data-valor-base="${valorBase}">
                        <small class="text-muted">O valor total ser√° calculado automaticamente (valor √ó di√°rias).</small>
                        <input type="hidden" id="valor-total-${index}" name="valor_calculado[]" value="${valorBase.toFixed(2)}">
                        <div id="preview-total-${index}" class="preview-total mt-2 fw-bold text-primary"></div>
                    </div>
                `;
                $select.closest('.mb-3').after(htmlDiarias);
                atualizarTotal($(`#quantidade-diarias-${index}`)); // j√° calcula
            }
        });

        // fun√ß√£o para recalcular automaticamente
        function atualizarTotal($input) {
            const qtd = parseInt($input.val()) || 1;
            const valorBase = parseFloat($input.data('valor-base')) || 0;
            const total = valorBase * qtd;
            const id = $input.attr('id').replace('quantidade-diarias-', '');

            $(`#valor-total-${id}`).val(total.toFixed(2));
            $(`#preview-total-${id}`).text(`üí∞ Total: R$ ${total.toFixed(2).replace('.', ',')}`);
        }

        // escuta mudan√ßas na quantidade de di√°rias
        $(document).on('input', '.quantidade-diarias', function () {
            atualizarTotal($(this));
        });





            // === MODAL EDITAR VENDA ===
            $(".btn-editar-venda").on("click", function () {
                $("#editar-id").val($(this).data("id"));
                $("#editar-descricao").val($(this).data("descricao"));
                $("#editar-valor").val($(this).data("valor"));
                $("#editar-metodo").val($(this).data("metodo"));
                $("#editar-data").val($(this).data("data"));
                $("#editar-observacao").val($(this).data("observacao"));

                $("#form-editar-venda").attr("action",
                    "{{ path('clinica_editar_venda', {petId: pet.id, id: 'PLACEHOLDER'}) }}".replace('PLACEHOLDER', $(this).data("id"))
                );

                modalEditarVenda.show();
            });

            // === INATIVAR VENDA ===
            $(".btn-inativar-venda").on("click", function () {
                if (!confirm("Tem certeza que deseja inativar esta venda?")) return;

                fetch(`/clinica/pet/{{ pet.id }}/venda/${$(this).data("id")}/inativar`, {
                    method: "POST"
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.status === "success") {
                            location.reload();
                        } else {
                            alert(d.mensagem || "Erro ao inativar venda.");
                        }
                    })
                    .catch(() => alert("Erro ao inativar venda."));
            });

            $("#form-editar-venda").on("submit", function (e) {
                e.preventDefault();
                fetch(this.action, {
                    method: "POST",
                    body: new FormData(this)
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.status === "success") {
                            modalEditarVenda.hide();
                            location.reload();
                        } else {
                            alert(d.mensagem);
                        }
                    })
                    .catch(() => alert("Erro ao editar venda."));
            });
            // Adicionar servi√ßo ao pet correspondente

        });

    $(document).on("click", ".add-servico", function () {
        let index = $(".servico-item").length + 1;

        let servicoHtml = `
            <div class="mb-3 servico-item border rounded-3 p-3 bg-light">
                <div class="mb-3">
                    <label class="form-label">Descri√ß√£o do Servi√ßo*</label>
                    <select class="form-select select-servico" name="descricao[]" required id="servico-descricao-${index}">
                        <option value="">Selecione um servi√ßo...</option>
                        {% for servico in servicos_clinica %}
                            <option value="{{ servico.id }}" data-valor="{{ servico.valor }}">
                                {{ servico.nome }} - R$ {{ servico.valor|number_format(2, ',', '.') }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Desconto (R$)</label>
                    <input type="number" step="0.01" class="form-control" name="desconto[]" value="0">
                </div>

                <button type="button" class="btn btn-danger remove-servico">
                    <i class="bx bx-trash"></i> Remover Servi√ßo
                </button>
            </div>
        `;

        $('#servicos-container').append(servicoHtml);

        // destr√≥i qualquer inst√¢ncia antiga antes de recriar
        const $novoSelect = $(`#servico-descricao-${index}`);
        if ($novoSelect.data('select2')) {
            $novoSelect.select2('destroy');
        }

        // ativa o Select2 corretamente dentro do modal
        $novoSelect.select2({
            dropdownParent: $('#modalAdicionarServico .modal-content'),
            placeholder: "Selecione ou pesquise um servi√ßo...",
            allowClear: true,
            width: '100%'
        });
    });


    // Remover servi√ßo
    $(document).on("click", ".remove-servico", function () {
        $(this).closest(".servico-item").remove();
    });

        $('.modal').on('hidden.modal.bs', function () {
            $('.modal-backdrop').remove()
        })


        $(document).ready(function() {
            $('#tabelaVacinas').DataTable({
                language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json' },
                order: [[2, 'desc']]
            });
        });

        $(document).on('change', '#servico-metodo', function() {
            const metodo = $(this).val();
            if (metodo === 'credito' || metodo === 'debito') {
                $('#cartao-opcoes').removeClass('d-none');
            } else {
                $('#cartao-opcoes').addClass('d-none');
            }
        });

        // === REMOVER VACINA DIRETO DO DASHBOARD ===
        $(document).on('submit', 'form[action*="vacina"][action*="remover"]', async function (e) {
            e.preventDefault(); 

            if (!confirm("Deseja remover esta vacina?")) return;

            const form = this;
            try {
                const resp = await fetch(form.action, { method: "POST" });
                const data = await resp.json();

                if (data.ok) {
                    const row = form.closest("tr");
                    if (row) {
                        $(row).fadeOut(300, () => $(row).remove());
                    }

                    if (window.Notify && Notify.toast) {
                        Notify.toast(data.msg || "Vacina removida com sucesso!", "success");
                    } else {
                        alert(data.msg || "Vacina removida com sucesso!");
                    }
                } else {
                    alert(data.msg || "Erro ao remover vacina.");
                }
            } catch (err) {
                alert("Erro ao remover vacina: " + err.message);
            }
        });

    </script>
{% endblock %}