{% extends 'baseClinica.html.twig' %}

{% block title %}Emitir Receita{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('assets/vendors/quill/quill.snow.css') }}" rel="stylesheet">
    <style>
        .receita-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 2rem;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        #editor-receita {
            min-height: 500px;
            font-size: 1.1rem;
            background: #f8f9fa; /* Fundo cinza para o editor */
            color: #000;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        @media print {
            body * { visibility: hidden !important; }
            #print-area, #print-area * { visibility: visible !important; }
            #print-area {
                position: absolute;
                left: 0; top: 0;
                width: 100%;
            }
            .ql-toolbar, #btn-pdf, #btn-print, .btn-voltar {
                display: none !important;
            }
        }
    </style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ path('clinica_detalhes_pet', {'id': pet.id}) }}" class="btn btn-outline-secondary btn-voltar">
            <i class="bi bi-arrow-left-circle"></i> Voltar
        </a>
        <div>
            <button id="btn-print" class="btn btn-success me-2">
                <i class="bi bi-printer"></i> Imprimir
            </button>
            <form id="form-pdf" method="POST" action="{{ path('clinica_receita', {'petId': pet.id}) }}" class="d-inline">
                <input type="hidden" name="conteudo">
                <button type="submit" id="btn-pdf" class="btn btn-primary">
                    <i class="bi bi-file-earmark-pdf"></i> Salvar como PDF
                </button>
            </form>
        </div>
    </div>

    <div class="receita-container">
        <div class="mb-4 text-center">
            <h4>{{ clinica.razaoSocial|default('Clínica Veterinária') }}</h4>
            <p><small>Tutor: {{ cliente.nome }} | Pet: {{ pet.nome }} ({{ pet.raca }})</small></p>
            <hr>
        </div>

        <div id="editor-receita" class="quill-editor"></div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quill = new Quill('#editor-receita', {
                theme: 'snow',
                placeholder: 'Escreva a prescrição aqui...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // Lógica para o botão "Salvar como PDF"
            const formPdf = document.getElementById('form-pdf');
            const conteudoInput = formPdf.querySelector('input[name="conteudo"]');

            formPdf.addEventListener('submit', function() {
                // Captura o conteúdo completo do editor Quill em formato Delta e o converte para uma string JSON
                conteudoInput.value = JSON.stringify(quill.getContents());
            });

            // Lógica para o botão de imprimir
            const btnPrint = document.getElementById('btn-print');
            if (btnPrint) {
                btnPrint.addEventListener('click', function() {
                    window.print();
                });
            }
        });
    </script>
{% endblock %}