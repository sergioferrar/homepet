{% extends 'base.html.twig' %}

{% block stylesheets %}
{{ parent() }}
<style>
    body.modal-open::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }
    .btn-primary {
        background-color: #004080;
        border-color: #003366;
        font-weight: bold;
        border-radius: 12px;
        padding: 8px 18px;
        color: #fff;
    }
    .btn-primary:hover {
        background-color: #003366;
    }
    .card-client {
        background: #f8fafd;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .card-title {
        color: #004080;
        font-weight: bold;
    }
    .card-table {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .card-table th {
        background-color: #0056b3;
        color: white;
        text-transform: uppercase;
        padding: 12px;
    }
    .card-table td {
        background-color: #f2f8ff;
        padding: 12px;
    }
    .offcanvas-body {
        background: linear-gradient(to bottom right, #e6f0ff, #ffffff);
    }
    .nav-tabs .nav-link.active {
        background-color: #004080;
        color: white;
        font-weight: bold;
        border-radius: 12px 12px 0 0;
    }
    .nav-tabs .nav-link {
        color: #004080;
    }
    .pet-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        background-color: #e6f0ff;
        border: 1px solid #99ccff;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .pet-card:hover {
        background-color: #d0eaff;
    }
    .pet-card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    .modal-pet-info {
        background-color: #f9fbff;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .modal-pet-info h6 {
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #004080;
    }
    .modal-pet-info div {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="text-primary mb-4">Clientes</h1>
    <form method="get" action="{{ path('cliente_index') }}" class="mb-4">
        <div class="input-group shadow-sm rounded">
            <input type="text" name="search" class="form-control" placeholder="Pesquisar por nome, e-mail ou telefone" value="{{ app.request.get('search') }}">
            <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
    </form>
    <a href="{{ path('cliente_novo') }}" class="btn btn-secondary mb-3">+ Novo Cliente</a>
    <div class="table-responsive">
        <table class="table table-bordered table-hover datatable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes %}
                    {% if cliente.nome is defined and cliente.email is defined and cliente.telefone is defined %}
                        <tr>
                            <td><a href="#" class="text-primary abrir-modal-cliente fw-bold" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling" data-id="{{ cliente.id }}">{{ cliente.nome }}</a></td>
                            <td>{{ cliente.email ?? '-' }}</td>
                            <td>{{ cliente.telefone ?? '-' }}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">A√ß√£o</button>
                                    <ul class="dropdown-menu">
                                        <li><a href="{{ path('cliente_agendamentos', {'id': cliente.id}) }}" class="dropdown-item">Ver Agendamentos</a></li>
                                        <li><a href="{{ path('cliente_editar', {'id': cliente.id}) }}" class="dropdown-item">Editar</a></li>
                                        <li>
                                            <form method="post" action="{{ path('cliente_deletar', {'id': cliente.id}) }}" class="d-inline">
                                                <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Tem certeza que deseja deletar este cliente?')">Deletar</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="offcanvas offcanvas-end" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold text-primary" id="offcanvasScrollingLabel">üìã Detalhes do Cliente</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body bg-light">
    <ul class="nav nav-tabs mb-4" id="clienteTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="dados-tab" data-bs-toggle="tab" href="#dados" role="tab">Dados do Cliente</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="agendamentos-tab" data-bs-toggle="tab" href="#agendamentos" role="tab">Agendamentos</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="pagamentos-tab" data-bs-toggle="tab" href="#pagamentos" role="tab">Pagamentos Pendentes</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="pets-tab" data-bs-toggle="tab" href="#pets" role="tab">Pets</a>
      </li>
    </ul>

<!-- Modal do Pet estilizado -->
<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="offcanvasPet" aria-labelledby="offcanvasPetLabel">
  <div class="offcanvas-header border-bottom" style="background-color: #f5faff;">
    <h5 class="offcanvas-title fw-bold text-success" id="offcanvasPetLabel">üêæ Detalhes do Pet</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
  </div>
  <div class="offcanvas-body bg-white" style="padding: 1.5rem 1.2rem;">
    
    <div class="mb-4 border rounded shadow-sm p-3 bg-light">
      <h6 class="text-muted mb-1">Nome do Pet</h6>
      <div id="modalPetNome" class="fw-bold fs-5 text-dark">-</div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Esp√©cie</h6>
          <div id="modalPetEspecie" class="fw-bold text-dark">-</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Sexo</h6>
          <div id="modalPetSexo" class="fw-bold text-dark">-</div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Ra√ßa</h6>
          <div id="modalPetRaca" class="fw-bold text-dark">-</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Porte</h6>
          <div id="modalPetPorte" class="fw-bold text-dark">-</div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Idade</h6>
          <div id="modalPetIdade" class="fw-bold text-dark">-</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3 bg-light mb-3">
          <h6 class="text-muted mb-1">Observa√ß√µes</h6>
          <div id="modalPetObs" class="fw-bold text-dark">-</div>
        </div>
      </div>
    </div>

  </div>
</div>




    <div class="tab-content">
      <div class="tab-pane fade show active" id="dados" role="tabpanel">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1 info-label">Nome:</p>
            <div class="info-box" id="clienteNome">-</div>
            <p class="mt-3 mb-1 info-label">Email:</p>
            <div class="info-box" id="clienteEmail">-</div>
            <p class="mt-3 mb-1 info-label">Telefone:</p>
            <div class="info-box" id="clienteTelefone">-</div>
          </div>
          <div class="col-md-6">
            <p class="mb-1 info-label">Endere√ßo:</p>
            <div class="info-box" id="clienteEndereco">-</div>
            <p class="mt-3 mb-1 info-label">Bairro:</p>
            <div class="info-box" id="clienteBairro">-</div>
            <p class="mt-3 mb-1 info-label">Cidade:</p>
            <div class="info-box" id="clienteCidade">-</div>
          </div>
        </div>
        <div class="mt-4">
          <p class="mb-1 info-label">Pend√™ncias:</p>
          <span class="badge bg-warning text-dark px-3 py-2 fs-6 rounded-pill" id="clientePendencias">-</span>
        </div>
      </div>

      <div class="tab-pane fade" id="agendamentos" role="tabpanel">
        <div id="clienteAgendamentos" class="d-flex flex-column gap-3"></div>
      </div>

        <div class="tab-pane fade" id="pagamentos" role="tabpanel">
            <div class="d-flex flex-column gap-3" id="clientePagamentos"></div>
        </div>

      <div class="tab-pane fade" id="pets" role="tabpanel">
        <div class="info-box" id="clientePets">Nenhum pet</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.abrir-modal-cliente').forEach(function (el) {
        el.addEventListener('click', function (e) {
            e.preventDefault();
            const clienteId = this.getAttribute('data-id');

            fetch('{{ path('cliente_detalhes', {'id': 'ID'}) }}'.replace('ID', clienteId))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        const c = data.cliente;
                        document.getElementById('clienteNome').innerText = c.nome || '-';
                        document.getElementById('clienteEmail').innerText = c.email || '-';
                        document.getElementById('clienteTelefone').innerText = c.telefone || '-';
                        document.getElementById('clienteEndereco').innerText = [c.rua, c.numero, c.complemento].filter(Boolean).join(', ') || '-';
                        document.getElementById('clienteBairro').innerText = c.bairro || '-';
                        document.getElementById('clienteCidade').innerText = c.cidade || '-';
                        document.getElementById('clientePendencias').innerText = c.temFinanceiroPendente ? 'Sim' : 'N√£o';

                        const petsDiv = document.getElementById('clientePets');
                        petsDiv.innerHTML = '';
                        if (c.pets && c.pets.length > 0) {
                            c.pets.forEach(p => {
                                const card = document.createElement('div');
                                card.className = 'pet-card';
                                card.innerHTML = `üêæ <strong>${p.nome}</strong>`;
                                card.addEventListener('click', () => {
                                    document.getElementById('modalPetNome').innerText = p.nome || '-';
                                    document.getElementById('modalPetEspecie').innerText = p.especie || '-';
                                    document.getElementById('modalPetSexo').innerText = p.sexo || '-';
                                    document.getElementById('modalPetRaca').innerText = p.raca || '-';
                                    document.getElementById('modalPetPorte').innerText = p.porte || '-';
                                    document.getElementById('modalPetIdade').innerText = p.idade || '-';
                                    document.getElementById('modalPetObs').innerText = p.observacoes || 'Nenhuma observac√£o';

                                    const petModal = new bootstrap.Offcanvas(document.getElementById('offcanvasPet'));
                                    petModal.show();
                                });
                                petsDiv.appendChild(card);
                            });
                        } else {
                            petsDiv.innerHTML = '<div class="text-muted">Nenhum pet cadastrado.</div>';
                        }

                        const agendamentosList = document.getElementById('clienteAgendamentos');
                        agendamentosList.innerHTML = '';
                        if (c.agendamentos && c.agendamentos.length > 0) {
                            const hoje = new Date();
                            c.agendamentos.forEach(function (ag) {
                                const dataAgendamento = new Date(ag.data);
                                const card = document.createElement('div');
                                card.className = 'agendamento-card' + (dataAgendamento < hoje ? ' agendamento-passado' : '');
                                card.innerHTML = `<strong>üìÖ Data:</strong> ${ag.data}<br><strong>üê∂ Pet:</strong> ${ag.pet}<br><strong>üíº Servi√ßo:</strong> ${ag.servico}`;
                                agendamentosList.appendChild(card);
                            });
                        } else {
                            agendamentosList.innerHTML = '<div class="text-muted">Nenhum agendamento encontrado.</div>';
                        }

                        const pagamentosList = document.getElementById('clientePagamentos');
                        pagamentosList.innerHTML = '';
                        if (c.pendencias && c.pendencias.length > 0) {
                            c.pendencias.forEach(function (pg) {
                                const card = document.createElement('div');
                                card.className = 'agendamento-card';
                                card.innerHTML = `<strong>üí≥ Descri√ß√£o:</strong> ${pg.descricao}<br><strong>R$</strong> ${parseFloat(pg.valor).toFixed(2)}<br><strong>üóì√æ Data:</strong> ${pg.data}`;
                                pagamentosList.appendChild(card);
                            });
                        } else {
                            pagamentosList.innerHTML = '<div class="text-muted">Nenhuma pend√™ncia registrada.</div>';
                        }
                    }
                })
                .catch(error => {
                    alert('Erro ao carregar os dados do cliente.');
                    console.error(error);
                });
        });
    });

    document.getElementById('offcanvasScrolling').addEventListener('show.bs.offcanvas', () => {
        document.body.classList.add('modal-open');
    });
    document.getElementById('offcanvasScrolling').addEventListener('hidden.bs.offcanvas', () => {
        document.body.classList.remove('modal-open');
    });
});
</script>
{% endblock %}

