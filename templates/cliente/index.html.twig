{% extends 'base.html.twig' %}

{% block page_title %}<i class="bi bi-people-fill me-2"></i> Clientes{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .card-title { color: #004080; font-weight: bold; }
    .tabela-container input.form-control-md { max-width: 450px; margin-bottom: 1.5rem; }
    .card-item { transition: box-shadow 0.2s; }
    .card-item:hover { box-shadow: 0 0 0 4px #e5eefe; }
    .dropdown-menu .dropdown-item.text-danger { color: #dc3545 !important; }
{#     .cliente-card {
        background: #fff;
        transition: all .25s ease;
    }

    .cliente-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0,0,0,.08);
    }

    .cliente-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6f42c1, #a98eda);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
    } #}
.info-group {
  margin-bottom: 1rem;
}

.info-label {
  font-size: .8rem;
  color: #6c757d;
}

.info-box {
  background: #f8f9fa;
  border-radius: 12px;
  padding: .6rem .9rem;
  font-weight: 500;
}

.pet-info-box {
  background: #f8f9fa;
  border-radius: 14px;
  padding: .9rem 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,.05);
}
</style>
{% endblock %}

{% block body %}

<div class="container">
    
    <div class="pagetitle">
        <h1>
            Clientes
            <a href="{{ path('cliente_novo') }}" class="btn btn-primary float-end">
                <i class="bx bx-plus-medical me-1"></i>Novo Cliente
            </a>
        </h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{url('home')}}">Home</a></li>
                <li class="breadcrumb-item">Atendimento</li>
                <li class="breadcrumb-item active">Clientes</li>
            </ol>
        </nav>
    </div>



    <!-- Action Bar -->



    <div class="tabela-container container-fluid px-2">
        <div id="cardContainerClientes" class="row gy-3">
            {% for cliente in clientes %}
                <div class="col-12 card-items" style="z-index: 99 !important;" data-search="{{ cliente.nome }} {{ cliente.cpf }} {{ cliente.email }} {{ cliente.telefone }}">
                    <div class="card shadow-lg border-0 rounded-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="flex-grow-1">
                                    <h5 class="card-title mb-1">
                                        <a href="#" class="text-primary abrir-modal-cliente fw-bold"
                                           data-bs-toggle="offcanvas"
                                           data-bs-target="#offcanvasScrolling"
                                           aria-controls="offcanvasScrolling"
                                        data-id="{{ cliente.id }}">
                                            {{ cliente.nome }}
                                    </a>
                                    </h5>
                                    <div class="d-flex flex-wrap gap-3 text-muted small mt-1">
                                        {% if cliente.cpf %}
                                            <span><i class="bx bx-id-card"></i> {{ cliente.cpf }}</span>
                                        {% endif %}
                                        <span><i class="bx bx-envelope"></i> {{ cliente.email ?? '-' }}</span>
                                        <span><i class="bx bx-phone"></i> {{ cliente.telefone ?? '-' }}</span>
                                    </div>
                                </div>
                                <!-- A√ß√µes -->
                                <div class="col-auto">
                                    <div class="dropdown dropstart">
                                        <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-toggle="dropdown">
                                            <i class="bx bx-dots-vertical-rounded"></i> A√ß√£o
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li class="d-none">
                                                <a href="{{ path('cliente_agendamentos', {'id': cliente.id}) }}" class="dropdown-item">
                                                    <i class="bx bx-calendar"></i> Ver Agendamentos
                                                </a>
                                            </li>
                                            <li>
                                                <a href="{{ path('cliente_editar', {'id': cliente.id}) }}" class="dropdown-item">
                                                    <i class="bx bx-edit"></i> Editar
                                                </a>
                                            </li>
                                            <li>
                                                <form method="post" action="{{ path('cliente_deletar', {'id': cliente.id}) }}">
                                                    <button type="submit" class="dropdown-item text-danger"
                                                    onclick="return confirm('Tem certeza que deseja deletar este cliente?')">
                                                    <i class="bx bx-trash"></i> Deletar
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center mb-0">Nenhum cliente encontrado.</div>
                </div>
            {% endfor %}
        </div>
        <div class="row mt-4">
            <div class="col text-center">
                <nav aria-label="Pagina√ß√£o">
                    <ul id="paginationClientes" class="pagination justify-content-center mb-0"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- OFFCANVAS: Mant√©m tudo aqui! -->
<div class="offcanvas offcanvas-end" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
<div class="offcanvas-header border-bottom bg-white">
  <div>
    <h5 class="offcanvas-title fw-bold text-primary mb-0">
      <i class="bx bx-user-circle"></i> Detalhes do Cliente
    </h5>
    <small class="text-muted">Informa√ß√µes completas, Agendamentos, pagamentos e pets</small>
  </div>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
</div>
  <div class="offcanvas-body bg-light">
<ul class="nav nav-pills gap-2 mb-4" id="clienteTabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active rounded-pill px-3" data-bs-toggle="tab" data-bs-target="#dados">
      <i class="bx bx-id-card"></i> Dados
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link rounded-pill px-3" data-bs-toggle="tab" data-bs-target="#agendamentos">
      <i class="bx bx-calendar"></i> Agenda
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link rounded-pill px-3" data-bs-toggle="tab" data-bs-target="#pagamentos">
      <i class="bx bx-credit-card"></i> Pagamentos
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link rounded-pill px-3" data-bs-toggle="tab" data-bs-target="#pets">
      <i class="bx bx-paw"></i> Pets
    </button>
  </li>
</ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="dados" role="tabpanel">
        <div class="row g-3 placeholder-glow">
          <div class="col-md-6">

            <div class="info-group">
              <span class="info-label"><i class="bx bx-user"></i> Nome</span>
              <div class="info-box placeholder col-12" id="clienteNome">-</div>
            </div>
            
            <div class="info-group">
              <span class="info-label"><i class="bx bxs-id-card"></i> CPF</span>
              <div class="info-box placeholder col-12" id="clienteCpf">-</div>
            </div>
            
            <div class="info-group">
              <span class="info-label"><i class="bx bx-envelope"></i> E-mail</span>
              <div class="info-box placeholder col-12" id="clienteEmail">-</div>
            </div>
            
            <div class="info-group">
              <span class="info-label"><i class="bx bx-phone"></i> Telefone</span>
              <div class="info-box placeholder col-12" id="clienteTelefone">-</div>
            </div>

          </div>
          <div class="col-md-6">
            
            <div class="info-group">
              <span class="info-label"><i class="bx bx-map-pin"></i> Endere√ßo</span>
              <div class="info-box placeholder col-12" id="clienteEndereco">-</div>
            </div>
            
            <div class="info-group">
              <span class="info-label"><i class="bx bx-map"></i> Bairro</span>
              <div class="info-box placeholder col-12" id="clienteBairro">-</div>
            </div>
            
            <div class="info-group">
              <span class="info-label"><i class="bx bx-pin"></i> Cidade</span>
              <div class="info-box placeholder col-12" id="clienteCidade">-</div>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <p class="mb-1 info-label">Pend√™ncias:</p>
          <span class="badge bg-warning text-dark px-3 py-2 fs-6 rounded-pill" id="clientePendencias">-</span>
        </div>
      </div>
      <div class="tab-pane fade" id="agendamentos" role="tabpanel">
        <div id="clienteAgendamentos" class="d-flex flex-column gap-3"></div>
      </div>
      <div class="tab-pane fade" id="pagamentos" role="tabpanel">
        <div class="d-flex flex-column gap-3" id="clientePagamentos"></div>
      </div>
      <div class="tab-pane fade" id="pets" role="tabpanel">
        <div class="info-box" id="clientePets">Nenhum pet</div>
      </div>
    </div>
    <!-- Modal do Pet dentro do offcanvas -->
    <div class="offcanvas offcanvas-end shadow" tabindex="-1" id="offcanvasPet" aria-labelledby="offcanvasPetLabel">
<div class="offcanvas-header border-bottom bg-white">
  <div>
    <h5 class="fw-bold text-success mb-0">
      <i class="bx bx-paw"></i> Detalhes do Pet
    </h5>
    <small class="text-muted">Ficha completa do animal</small>
  </div>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
</div>
      <div class="offcanvas-body bg-white" style="padding: 1.5rem 1.2rem;">
        <div class="mb-4 border rounded shadow-sm p-3 bg-light">
          <h6 class="text-muted mb-1">Nome do Pet</h6>
          <div id="modalPetNome" class="fw-bold fs-5 text-dark">-</div>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Esp√©cie</h6>
              <div id="modalPetEspecie" class="fw-bold text-dark">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Sexo</h6>
              <div id="modalPetSexo" class="fw-bold text-dark">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Ra√ßa</h6>
              <div id="modalPetRaca" class="fw-bold text-dark">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Porte</h6>
              <div id="modalPetPorte" class="fw-bold text-dark">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Idade</h6>
              <div id="modalPetIdade" class="fw-bold text-dark">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded shadow-sm p-3 bg-light mb-3">
              <h6 class="text-muted mb-1">Observa√ß√µes</h6>
              <div id="modalPetObs" class="fw-bold text-dark">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('js/TabelaDefault.js') }}"></script>
<script>
    $('#searchInput').attr('id','searchInputClientes');
document.addEventListener('DOMContentLoaded', function () {
    new TabelaDefault({
        cardContainerId: 'cardContainerClientes',
        paginationId: 'paginationClientes',
        searchInputId: 'searchInputClientes',
        itemsPerPage: 5 // ou qualquer valor
    });

    // Abre modal com detalhes do cliente (AJAX igual antes)
    $('.abrir-modal-cliente').on('click', function (e) {
        e.preventDefault();
        $('.info-box').addClass('placeholder').addClass('.col-12');
        const clienteId = $(this).data('id');

        $.getJSON(
            '{{ path('cliente_detalhes', {'id': 'ID'}) }}'.replace('ID', clienteId)
        )
        .done(function (data) {
            if (data.status === 'ok') {
                $('.info-box').removeClass('placeholder').removeClass('.col-12');
                const c = data.cliente;

                $('#clienteNome').text(c.nome || '-');
                $('#clienteCpf').text(c.cpf || '-');
                $('#clienteEmail').text(c.email || '-');
                $('#clienteTelefone').text(c.telefone || '-');
                $('#clienteEndereco').text(
                    [c.rua, c.numero, c.complemento].filter(Boolean).join(', ') || '-'
                );
                $('#clienteBairro').text(c.bairro || '-');
                $('#clienteCidade').text(c.cidade || '-');
                $('#clientePendencias').text(c.temFinanceiroPendente ? 'Sim' : 'N√£o');

                // üêæ Pets
                const $petsDiv = $('#clientePets');
                $petsDiv.html('');

                if (c.pets && c.pets.length > 0) {

                    const $table = $(`
                        <table class="table agendamento-tabela pets-tabela">
                            <thead>
                                <tr>
                                    <th>üêæ Nome</th>
                                    <th>Esp√©cie</th>
                                    <th>Sexo</th>
                                    <th>Ra√ßa</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    `);

                    c.pets.forEach(p => {
                        const $tr = $(`
                            <tr>
                                <td><a href="#" class="link-primary text-decoration-none pet-nome">${p.nome}</a></td>
                                <td>${p.especie}</td>
                                <td>${p.sexo}</td>
                                <td>${p.raca}</td>
                            </tr>
                        `);

                        // Modal do pet
                        $tr.find('.pet-nome').on('click', function (e) {
                            e.preventDefault();

                            $('#modalPetNome').text(p.nome || '-');
                            $('#modalPetEspecie').text(p.especie || '-');
                            $('#modalPetSexo').text(p.sexo || '-');
                            $('#modalPetRaca').text(p.raca || '-');
                            $('#modalPetPorte').text(p.porte || '-');
                            $('#modalPetIdade').text(p.idade || '-');
                            $('#modalPetObs').text(p.observacoes || 'Nenhuma observa√ß√£o');

                            const petModal = new bootstrap.Offcanvas($('#offcanvasPet')[0]);
                            petModal.show();
                        });

                        $table.find('tbody').append($tr);
                    });

                    $petsDiv.append($table);

                } else {
                    $petsDiv.html('<div class="text-muted">Nenhum pet cadastrado.</div>');
                }

                // üìÖ Agendamentos
                const $agendamentosList = $('#clienteAgendamentos');
                $agendamentosList.html('');

                if (c.agendamentos && c.agendamentos.length > 0) {

                    let tabela = `
                        <table class="table agendamento-tabela">
                            <thead>
                                <tr>
                                    <th class="icone"><i class"bx bx-calendar"></i></th>
                                    <th>Data</th>
                                    <th>Pet</th>
                                    <th>Servi√ßo</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    c.agendamentos.forEach(ag => {
                        tabela += `
                            <tr>
                                <td class="icone">üêæ</td>
                                <td>${ag.data}</td>
                                <td>${ag.pet}</td>
                                <td>${ag.servico}</td>
                            </tr>
                        `;
                    });

                    tabela += `</tbody></table>`;

                    $agendamentosList.html(tabela);

                } else {
                    $agendamentosList.html('<div class="text-muted">Nenhum agendamento encontrado.</div>');
                }

                // üí≥ Pagamentos
                const $pagamentosList = $('#clientePagamentos');
                $pagamentosList.html('');

                if (c.pendencias && c.pendencias.length > 0) {

                    let tabela = `
                        <table class="table agendamento-tabela pagamentos-tabela">
                            <thead>
                                <tr>
                                    <th>üí≥ Descri√ß√£o</th>
                                    <th class="valor">Valor</th>
                                    <th>üóìÔ∏è Data</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    c.pendencias.forEach(pg => {
                        tabela += `
                            <tr>
                                <td>${pg.descricao}</td>
                                <td class="valor">R$ ${parseFloat(pg.valor).toFixed(2)}</td>
                                <td>${pg.data}</td>
                            </tr>
                        `;
                    });

                    tabela += `</tbody></table>`;

                    $pagamentosList.html(tabela);

                } else {
                    $pagamentosList.html('<div class="text-muted">Nenhuma pend√™ncia registrada.</div>');
                }
            }
        })
        .fail(function (error) {
            alert('Erro ao carregar os dados do cliente.');
            console.error(error);
        });
});

    // Trava o fundo quando modal aberto
    document.getElementById('offcanvasScrolling').addEventListener('show.bs.offcanvas', () => {
        document.body.classList.add('modal-open');
    });
    document.getElementById('offcanvasScrolling').addEventListener('hidden.bs.offcanvas', () => {
        document.body.classList.remove('modal-open');
    });
});
</script>
{% endblock %}
