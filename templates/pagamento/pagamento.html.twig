{% extends 'baseLogin.html.twig' %}
{% block title %}Checkout - Pagamento{% endblock %}
{% block styesheets %}
	<style>
		body {
			font-family: Arial, sans-serif;
			background: #f9f9f9;
			display: flex;
			justify-content: center;
			align-items: flex-start;
			padding: 30px;
		}
		.checkout-container {
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 4px 10px rgba(0,0,0,0.1);
			width: 450px;
			padding: 25px;
			transition: all 0.3s ease-in-out;
		}
		h2 {
			margin-bottom: 20px;
			color: #333;
			text-align: center;
		}
		select {
			width: 100%;
			padding: 10px;
			margin-bottom: 20px;
			border-radius: 8px;
			border: 1px solid #ccc;
		}
		.payment-method {
			display: block;
			margin-top: 15px;
		}
		.loading {
			text-align: center;
			padding: 20px;
		}
		.success {
			text-align: center;
			color: green;
			font-weight: bold;
			padding: 20px;
		}
		.error {
			text-align: center;
			color: red;
			padding: 20px;
		}
	</style>
{% endblock %}
{% block body %}
	<div class="row">
		<div class="col-md-6 offset-md-3">
			<div class="card">
				<div class="card-header">
					<h2>Finalizar Pagamento</h2>
				</div>
				<div class="card-body p-3">
					<div class="checkout-container">
						
						<div class="alert alert-info mb-3">
							<strong>üí≥ Formas de pagamento aceitas:</strong><br>
							‚Ä¢ <strong>PIX:</strong> Aprova√ß√£o instant√¢nea<br>
							‚Ä¢ <strong>Cart√£o de Cr√©dito:</strong> Apenas cr√©dito (d√©bito n√£o √© aceito para pagamentos online)
						</div>
						
						<label for="paymentType">Selecione a forma de pagamento:</label>
						<select id="paymentType" class="form-select">
							<option value="">-- Escolha --</option>
							<option value="pix">PIX (Recomendado - Instant√¢neo)</option>
							<option value="card">Cart√£o de Cr√©dito</option>
						</select>
						<!-- √Årea din√¢mica -->
						<div class="area-pix" style="display: none;">
							<form id="form-checkout" action="{{ url('pagar_com_pix') }}" method="post">
								<div>
									<div>
										<label for="payerFirstName">Nome</label>
										<input class="form-control" id="form-checkout__payerFirstName" name="payerFirstName" type="text">
									</div>
									<div>
										<label for="payerLastName">Sobrenome</label>
										<input class="form-control" id="form-checkout__payerLastName" name="payerLastName" type="text">
									</div>
									<div>
										<label for="email">E-mail</label>
										<input class="form-control" id="form-checkout__email" name="email" type="text">
									</div>
									<div>
										<label for="identificationType">Documento</label>
										<select class="form-select" id="form-checkout__identificationType" name="identificationType" type="text">
											<option value="cpf">CPF</option>
											<option value="cnpj">CNPJ</option>
										</select>
									</div>
									<div>
										<label for="identificationNumber">N√∫mero do documento</label>
										<input class="form-control" id="form-checkout__identificationNumber" name="identificationNumber" type="text">
									</div>
								</div>
								<div>
									<div>
										<input type="hidden" name="transactionAmount" id="transactionAmount" value="{{price}}">
										<input type="hidden" name="description" id="description" value="{{title}}">
										<br>
										<button type="submit" class="btn btn-outline-success">Efetuar pagamento</button>
									</div>
								</div>
							</form>
						</div>
						<div id="payment-form" class="payment-method col-md-12 pt-4"></div>
						<div id="status"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
{% endblock %}
{% block javascripts %}
	<script src="//sdk.mercadopago.com/js/v2"></script>
	<script type="module">
		// Public Key de produ√ß√£o - Sergio Ferrari
		const mp = new MercadoPago("APP_USR-a6eb6213-ae14-4a59-ade4-f990a26ef542", {
			locale: 'pt-BR'
		});
		const paymentType = document.getElementById("paymentType");
		const formContainer = document.getElementById("payment-form");
		const statusDiv = document.getElementById("status");
		paymentType.addEventListener("change", async function () {
			formContainer.innerHTML = "";
			statusDiv.innerHTML = "";
			formContainer.style.display = "block";
			if (this.value === "card") {
				// Aviso sobre cart√£o de cr√©dito
				statusDiv.innerHTML = `
					<div class="alert alert-warning">
						<strong>‚ö†Ô∏è Aten√ß√£o:</strong> Apenas cart√µes de CR√âDITO s√£o aceitos.<br>
						Cart√µes de d√©bito n√£o funcionam para pagamentos online.<br>
						<strong>Recomendamos usar PIX</strong> para aprova√ß√£o instant√¢nea.
					</div>
				`;
				
				// Renderiza o Brick de Cart√£o
				const cardForm = mp.bricks();
				cardForm.create("cardPayment", "payment-form", {
					initialization: {
						amount: {{ price }}, // valor do plano escolhido
					},
					callbacks: {
						onReady: () => {
							console.log("‚úÖ Formul√°rio de cart√£o pronto!");
						},
						onSubmit: async (formData) => {
							statusDiv.innerHTML = `<div class="loading">Processando pagamento com cart√£o...</div>`;
							
							try {
								// Envia os dados do cart√£o para o backend
								const response = await fetch('{{ path('pagar_com_cartao') }}', {
									method: 'POST',
									headers: {
										'Content-Type': 'application/json',
									},
									body: JSON.stringify({
										...formData,
										email: '{{ email }}',
										amount: {{ price }},
										description: '{{ title }}'
									})
								});
								
								const result = await response.json();
								
								if (result.status === 'approved') {
									statusDiv.innerHTML = `<div class="success">‚úÖ Pagamento aprovado! Redirecionando...</div>`;
									setTimeout(() => {
										window.location.href = '{{ path('pagamento_sucesso') }}';
									}, 2000);
								} else if (result.status === 'pending' || result.status === 'in_process') {
									statusDiv.innerHTML = `<div class="alert alert-warning">‚è≥ Pagamento em processamento. Voc√™ receber√° um e-mail quando for confirmado.</div>`;
									setTimeout(() => {
										window.location.href = '{{ path('pagamento_pendente') }}';
									}, 3000);
								} else {
									let mensagemErro = 'Tente outro cart√£o de CR√âDITO';
									
									if (result.status_detail) {
										const erros = {
											'cc_rejected_insufficient_amount': 'Saldo insuficiente',
											'cc_rejected_bad_filled_security_code': 'C√≥digo de seguran√ßa inv√°lido',
											'cc_rejected_bad_filled_date': 'Data de validade inv√°lida',
											'cc_rejected_bad_filled_other': 'Dados do cart√£o incorretos',
											'cc_rejected_call_for_authorize': 'Entre em contato com seu banco',
											'cc_rejected_card_disabled': 'Cart√£o desabilitado',
											'cc_rejected_duplicated_payment': 'Pagamento duplicado',
											'cc_rejected_high_risk': 'Pagamento recusado por seguran√ßa',
											'cc_rejected_invalid_installments': 'N√∫mero de parcelas inv√°lido',
											'cc_rejected_max_attempts': 'Limite de tentativas excedido',
											'cc_rejected_other_reason': 'Cart√£o recusado pelo banco'
										};
										
										mensagemErro = erros[result.status_detail] || result.status_detail;
									}
									
									statusDiv.innerHTML = `
										<div class="alert alert-danger">
											<strong>‚ùå Pagamento Recusado</strong><br>
											${mensagemErro}<br><br>
											<small>
												<strong>Dica:</strong> Use PIX para aprova√ß√£o instant√¢nea ou tente outro cart√£o de CR√âDITO.<br>
												<em>Cart√µes de d√©bito n√£o s√£o aceitos para pagamentos online.</em>
											</small>
										</div>
									`;
								}
							} catch (error) {
								console.error('Erro:', error);
								statusDiv.innerHTML = `<div class="error">‚ùå Erro ao processar pagamento: ${error.message}</div>`;
							}
						},
						onError: (error) => {
							statusDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
						}
					}
				});
			}
		if (this.value === "pix") {
			document.querySelector('.payment-method').innerHTML = document.querySelector('.area-pix').innerHTML;
			// Renderiza o Brick de Pix
			(async function getIdentificationTypes() {
				try {
					const identificationTypes = await mp.getIdentificationTypes();
					const identificationTypeElement = document.getElementById('form-checkout__identificationType');
					createSelectOptions(identificationTypeElement, identificationTypes);
				} catch (e) {
					return console.error('Error getting identificationTypes: ', e);
				}
			})();
			function createSelectOptions(elem, options, labelsAndKeys = { label: "name", value: "id" }) {
				const { label, value } = labelsAndKeys;
				elem.options.length = 0;
				const tempOptions = document.createDocumentFragment();
				options.forEach(option => {
					const optValue = option[value];
					const optLabel = option[label];
					const opt = document.createElement('option');
					opt.value = optValue;
					opt.textContent = optLabel;
					tempOptions.appendChild(opt);
				});
				elem.appendChild(tempOptions);
			}
		}
	});
	</script>
{% endblock %}