<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Checkout - Pagamento</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="{{ asset('images/logo.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ asset('apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset('favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset('favicon-16x16.png') }}">
    <link rel="manifest" href="{{ asset('manifest.webmanifest') }}" crossorigin="use-credentials">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="{{ asset('landing/assets/vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ asset('landing/assets/vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet">
    <link href="{{ asset('landing/assets/vendor/aos/aos.css') }}" rel="stylesheet">
    <link href="{{ asset('landing/assets/vendor/glightbox/css/glightbox.min.css') }}" rel="stylesheet">
    <link href="{{ asset('landing/assets/vendor/swiper/swiper-bundle.min.css') }}" rel="stylesheet">
    <!-- Main CSS File -->
    <link href="{{ asset('landing/assets/css/main.css') }}" rel="stylesheet">
    <style>

        .checkout-container {
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        {# width: 450px; #} padding: 25px;
            transition: all 0.3s ease-in-out;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .payment-method {
            display: block;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .success {
            text-align: center;
            color: green;
            font-weight: bold;
            padding: 20px;
        }

        .error {
            text-align: center;
            color: red;
            padding: 20px;
        }
    </style>
</head>
<body class="index-page">
<header id="header" class="header d-flex align-items-center fixed-top mb-5">
    <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center me-auto me-xl-0">
            <!-- Uncomment the line below if you also wish to use an image logo -->
            <!-- <img src="assets/img/logo.webp" alt=""> -->
            <h1 class="sitename">System Home Pet</h1><span>.</span>
        </a>
        <nav id="navmenu" class="navmenu d-none">
            <ul>
                <li><a href="#hero" class="active">Página inicial</a></li>
                <li><a href="#about">Sobre nós</a></li>
                {# <li><a href="#services">Services</a></li> #}
                {# <li><a href="#portfolio">Portfolio</a></li> #}
                <li><a href="#pricing">Preços</a></li>
                {# <li><a href="#team">Team</a></li> #}

                {# <li><a href="#contact">Contact</a></li> #}
            </ul>
            <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
        <a class="btn-getstarted" href="{{ url('landing_home') }}">Voltar ao site</a>
    </div>
</header>
<main class="main mb-5 mt-5 pt-5 container-fluid">
    <!-- Pricing Section -->
    <section id="pricing" class="pricing section container-fluid">
        <!-- Section Title -->
        <div class="container section-title mt-4 mb-3" data-aos="fade-up">
            <h2>Finalizar Pagamento</h2>
        </div><!-- End Section Title -->
        <div class="container" data-aos="fade-up" data-aos-delay="100">
            <div class="checkout-container col-md-6">
                <label for="paymentType">Selecione a forma de pagamento:</label>
                <select id="paymentType" class="form-select">
                    <option value="">-- Escolha --</option>
                    <option value="card">Cartão de Crédito</option>
                    <option selected value="pix">PIX</option>
                </select>
                <!-- Área dinâmica -->

                <div id="payment-form" class="payment-method">
                    <div class="d-flex justify-aligh-between">
                        <div class="col-12">
                            <center>

                                <img class="img-responsive" width="250"
                                     src="data:image/jpeg;base64,{{ pix_entities.transaction_data.qr_code_base64 }}"/>
                                <p></p>
                            </center>

                            <div class="row d-block"><p>{{ valor|formataValorEmReal }}</p></div>
                            <div class="row d-block">

                                <div class="input-group mb-3">
                                    <input type="text" class="form-control pix-copia-e-cola"
                                           value="{{ pix_entities.transaction_data.qr_code }}">
                                    <button class="btn btn-outline-secondary" type="button" id="copiaecola">Copia e
                                        Cola
                                    </button>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <a class="btn btn-info" href="{{ pix_entities.transaction_data.ticket_url }}" target="_blank">Ir para o
                    Mercado Pago</a>
                <div id="status"></div>
            </div>
        </div>
        </div>
    </section><!-- /Pricing Section -->

</main>
<footer id="footer" class="footer light-background container-fluid">
    <div class="container-fluid copyright text-center mt-4">
        <p>© <span>Copyright</span> <strong class="px-1 sitename">System Home PET</strong> <span>Todos os direitos reservados</span>
        </p>
        <div class="credits">
            <!-- All the links in the footer should remain intact. -->
            <!-- You can delete the links only if you've purchased the pro version. -->
            <!-- Licensing information: https://bootstrapmade.com/license/ -->
            <!-- Purchase the pro version with working PHP/AJAX contact form: [buy-url] -->
            Desenvolvido por <a
                    href="https://api.whatsapp.com/send/?phone=5531995318362&text=Gostaria+de+mais+informações+sobre+o+sistema&type=phone_number&app_absent=0">Sérgio
                Ferrari</a>

        </div>
    </div>
</footer>
<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
<!-- Preloader -->
<div id="preloader"></div>
<!-- Vendor JS Files -->
<script src="{{ asset('js/plugins/jquery/jquery.min.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/php-email-form/validate.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/aos/aos.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/glightbox/js/glightbox.min.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/imagesloaded/imagesloaded.pkgd.min.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/isotope-layout/isotope.pkgd.min.js') }}"></script>
<script src="{{ asset('landing/assets/vendor/swiper/swiper-bundle.min.js') }}"></script>
<!-- Main JS File -->
<script src="{{ asset('landing/assets/js/main.js') }}"></script>
<script src="//sdk.mercadopago.com/js/v2"></script>
<script type="module">
    $(document).on('click', '#copiaecola', function () {
        var pixCopiaeCola = $('.pix-copia-e-cola').val();
        var _this = $(this)
        navigator.clipboard.writeText(pixCopiaeCola)
            .then(function () {
                _this.html('Texto copiado!');
            })
            .catch(function (error) {
                console.log(error);
            })
    })
    // Verificação automática do status do pagamento
    {% if payment_id is defined %}
    let verificacoes = 0;
    const maxVerificacoes = 60; // 5 minutos (60 x 5 segundos)

    function verificarPagamento() {
        verificacoes++;

        if (verificacoes > maxVerificacoes) {
            console.log('Tempo limite de verificação atingido');
            return;
        }
        fetch('{{ path('pagamento_verificar_status') }}?payment_id={{ payment_id }}')
            .then(response => response.json())
            .then(data => {
                console.log('Status do pagamento:', data.status);

                if (data.status === 'approved') {
                    // Pagamento aprovado - redireciona para página de sucesso
                    $('#status').html('<div class="alert alert-success"><strong>✅ Pagamento Aprovado!</strong><br>Redirecionando...</div>');
                    setTimeout(() => {
                        window.location.href = '{{ path('pagamento_sucesso') }}';
                    }, 2000);
                } else if (data.status === 'rejected' || data.status === 'cancelled') {
                    // Pagamento recusado ou cancelado
                    $('#status').html('<div class="alert alert-danger"><strong>❌ Pagamento ' + data.status + '</strong></div>');
                } else if (data.status === 'pending' || data.status === 'in_process') {
                    // Ainda pendente - continua verificando
                    setTimeout(verificarPagamento, 5000); // Verifica a cada 5 segundos
                } else {
                    // Outro status - continua verificando
                    setTimeout(verificarPagamento, 5000);
                }
            })
            .catch(error => {
                console.error('Erro ao verificar pagamento:', error);
                setTimeout(verificarPagamento, 5000); // Tenta novamente em caso de erro
            });
    }

    // Inicia a verificação após 5 segundos
    setTimeout(verificarPagamento, 5000);

    // Mostra mensagem de aguardando pagamento
    $('#status').html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Aguardando confirmação do pagamento...</div>');
    {% endif %}
    const mp = new MercadoPago("TEST-f9dcb738-f6dd-4eb2-a42f-dac0ea45143d", {
        locale: 'pt-BR'
    });
    const paymentType = document.getElementById("paymentType");
    const formContainer = document.getElementById("payment-form");
    const statusDiv = document.getElementById("status");
    paymentType.addEventListener("change", async function () {
        formContainer.innerHTML = "";
        statusDiv.innerHTML = "";
        formContainer.style.display = "block";
        if (this.value === "card") {
            // Renderiza o Brick de Cartão
            const cardForm = mp.bricks();
            cardForm.create("cardPayment", "payment-form", {
                initialization: {
                    amount: 100.00, // valor do pagamento
                },
                callbacks: {
                    onReady: () => {
                        console.log("✅ Formulário de cartão pronto!");
                    },
                    onSubmit: (formData) => {
                        statusDiv.innerHTML = `<div class="loading">Processando pagamento...</div>`;
                        // Aqui você envia formData ao seu backend
                        console.log("Dados do Cartão:", formData);
                        setTimeout(() => {
                            statusDiv.innerHTML = `<div class="success">✅ Pagamento aprovado!</div>`;
                        }, 2000);
                    },
                    onError: (error) => {
                        statusDiv.innerHTML = `<div class="error">❌ Erro: ${error.message}</div>`;
                    }
                }
            });
        }
        if (this.value === "pix") {
            window.location.reload()
            return;
            document.querySelector('.payment-method').innerHTML = document.querySelector('.area-pix').innerHTML;
            // Renderiza o Brick de Pix
            (async function getIdentificationTypes() {
                try {
                    const identificationTypes = await mp.getIdentificationTypes();
                    const identificationTypeElement = document.getElementById('form-checkout__identificationType');
                    createSelectOptions(identificationTypeElement, identificationTypes);
                } catch (e) {
                    return console.error('Error getting identificationTypes: ', e);
                }
            })();

            function createSelectOptions(elem, options, labelsAndKeys = {label: "name", value: "id"}) {
                const {label, value} = labelsAndKeys;
                elem.options.length = 0;
                const tempOptions = document.createDocumentFragment();
                options.forEach(option => {
                    const optValue = option[value];
                    const optLabel = option[label];
                    const opt = document.createElement('option');
                    opt.value = optValue;
                    opt.textContent = optLabel;
                    tempOptions.appendChild(opt);
                });
                elem.appendChild(tempOptions);
            }
        }
    });
</script>
</body>
</html>