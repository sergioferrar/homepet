{% extends 'baseLogin.html.twig' %}
{% block title %}Checkout - Pagamento{% endblock %}
{% block styesheets %}
	<style>
		body {
			font-family: Arial, sans-serif;
			background: #f9f9f9;
			display: flex;
			justify-content: center;
			align-items: flex-start;
			padding: 30px;
		}
		.checkout-container {
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 4px 10px rgba(0,0,0,0.1);
			width: 450px;
			padding: 25px;
			transition: all 0.3s ease-in-out;
		}
		h2 {
			margin-bottom: 20px;
			color: #333;
			text-align: center;
		}
		select {
			width: 100%;
			padding: 10px;
			margin-bottom: 20px;
			border-radius: 8px;
			border: 1px solid #ccc;
		}
		.payment-method {
			display: block;
			margin-top: 15px;
		}
		.loading {
			text-align: center;
			padding: 20px;
		}
		.success {
			text-align: center;
			color: green;
			font-weight: bold;
			padding: 20px;
		}
		.error {
			text-align: center;
			color: red;
			padding: 20px;
		}
	</style>
{% endblock %}
{% block body %}<div class="row">
	<div class="col-md-6 offset-md-3">
		<div class="card">
			<div class="card-header">
				<h2>Finalizar Pagamento</h2>
			</div>
			<div class="card-body p-3">
				<div class="checkout-container">
					<label for="paymentType">Selecione a forma de pagamento:</label>
						<select id="paymentType" class="form-select">
							<option value="">-- Escolha --</option>
							<option value="card">Cartão de Crédito</option>
							<option selected value="pix">PIX</option>
						</select>
					<!-- Área dinâmica -->
					
					<div id="payment-form" class="payment-method">
						<div class="d-flex justify-aligh-between">
							<div class="col-12">
							<center>
								
								<img class="img-responsive" width="150" src="data:image/jpeg;base64,{{ pix_entities.transaction_data.qr_code_base64 }}"/>
								<p></p>
							</center>
								
							<div class="row d-block"><p>{{ valor|formataValorEmReal }}</p></div>
							<div class="row d-block">
								
								<div class="input-group mb-3">
  <input type="text" class="form-control pix-copia-e-cola" value="{{ pix_entities.transaction_data.qr_code }}">
  <button class="btn btn-outline-secondary" type="button" id="copiaecola">Copia e Cola</button>
</div>
							</div>
							</div>
							
						
						
						
						</div>
						<a class="btn btn-info float-end" href="{{ pix_entities.transaction_data.ticket_url }}" target="_blank">Ir para o Mercado Pago</a>
					</div>
					<div id="status"></div>
				</div>
			</div>
		</div>
	</div>
</div>
</div>
{% endblock %}

{% block javascripts %}
	<script src="//sdk.mercadopago.com/js/v2"></script>
	<script type="module">
		$(document).on('click', '#copiaecola', function(){
			var pixCopiaeCola = $('.pix-copia-e-cola').val();
			var _this = $(this)
			navigator.clipboard.writeText(pixCopiaeCola)
			.then(function(){
				_this.html('Texto copiado!');
			})
			.catch(function(error){
				console.log(error);
			})
		})

		// Verificação automática do status do pagamento
		{% if payment_id is defined %}
		let verificacoes = 0;
		const maxVerificacoes = 60; // 5 minutos (60 x 5 segundos)
		
		function verificarPagamento() {
			verificacoes++;
			
			if (verificacoes > maxVerificacoes) {
				console.log('Tempo limite de verificação atingido');
				return;
			}

			fetch('{{ path('pagamento_verificar_status') }}?payment_id={{ payment_id }}')
				.then(response => response.json())
				.then(data => {
					console.log('Status do pagamento:', data.status);
					
					if (data.status === 'approved') {
						// Pagamento aprovado - redireciona para página de sucesso
						$('#status').html('<div class="alert alert-success"><strong>✅ Pagamento Aprovado!</strong><br>Redirecionando...</div>');
						setTimeout(() => {
							window.location.href = '{{ path('pagamento_sucesso') }}';
						}, 2000);
					} else if (data.status === 'rejected' || data.status === 'cancelled') {
						// Pagamento recusado ou cancelado
						$('#status').html('<div class="alert alert-danger"><strong>❌ Pagamento ' + data.status + '</strong></div>');
					} else if (data.status === 'pending' || data.status === 'in_process') {
						// Ainda pendente - continua verificando
						setTimeout(verificarPagamento, 5000); // Verifica a cada 5 segundos
					} else {
						// Outro status - continua verificando
						setTimeout(verificarPagamento, 5000);
					}
				})
				.catch(error => {
					console.error('Erro ao verificar pagamento:', error);
					setTimeout(verificarPagamento, 5000); // Tenta novamente em caso de erro
				});
		}

		// Inicia a verificação após 5 segundos
		setTimeout(verificarPagamento, 5000);
		
		// Mostra mensagem de aguardando pagamento
		$('#status').html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Aguardando confirmação do pagamento...</div>');
		{% endif %}
		const mp = new MercadoPago("TEST-f9dcb738-f6dd-4eb2-a42f-dac0ea45143d", {
			locale: 'pt-BR'
		});
		const paymentType = document.getElementById("paymentType");
		const formContainer = document.getElementById("payment-form");
		const statusDiv = document.getElementById("status");
		paymentType.addEventListener("change", async function () {
			formContainer.innerHTML = "";
			statusDiv.innerHTML = "";
			formContainer.style.display = "block";
			if (this.value === "card") {
				// Renderiza o Brick de Cartão
				const cardForm = mp.bricks();
				cardForm.create("cardPayment", "payment-form", {
					initialization: {
				amount: 100.00, // valor do pagamento
			},
			callbacks: {
				onReady: () => {
					console.log("✅ Formulário de cartão pronto!");
				},
				onSubmit: (formData) => {
					statusDiv.innerHTML = `<div class="loading">Processando pagamento...</div>`;
				// Aqui você envia formData ao seu backend
					console.log("Dados do Cartão:", formData);
					setTimeout(() => {
						statusDiv.innerHTML = `<div class="success">✅ Pagamento aprovado!</div>`;
					}, 2000);
				},
				onError: (error) => {
					statusDiv.innerHTML = `<div class="error">❌ Erro: ${error.message}</div>`;
				}
			}
		});
		}
		if (this.value === "pix") {
			window.location.reload()
			return;
			document.querySelector('.payment-method').innerHTML = document.querySelector('.area-pix').innerHTML;
			// Renderiza o Brick de Pix
			(async function getIdentificationTypes() {
				try {
					const identificationTypes = await mp.getIdentificationTypes();
					const identificationTypeElement = document.getElementById('form-checkout__identificationType');
					createSelectOptions(identificationTypeElement, identificationTypes);
				} catch (e) {
					return console.error('Error getting identificationTypes: ', e);
				}
			})();
			function createSelectOptions(elem, options, labelsAndKeys = { label: "name", value: "id" }) {
				const { label, value } = labelsAndKeys;
				elem.options.length = 0;
				const tempOptions = document.createDocumentFragment();
				options.forEach(option => {
					const optValue = option[value];
					const optLabel = option[label];
					const opt = document.createElement('option');
					opt.value = optValue;
					opt.textContent = optLabel;
					tempOptions.appendChild(opt);
				});
				elem.appendChild(tempOptions);
			}
		}
	});
	</script>
{% endblock %}