{% set rotaAtual = app.request.attributes.get('_route') %}

{#
    Regra de exibição do menu dinâmico:

    - SA puro (sem impersonation)  → NÃO exibe o menu de estabelecimento
    - SA em impersonation          → EXIBE o menu do estabelecimento acessado
    - Usuário normal               → EXIBE o menu do seu próprio estabelecimento

    IMPORTANTE: não usar apenas 'ROLE_SUPER_ADMIN in app.user.roles' porque
    durante o impersonation o SA continua tendo esse role — a flag de sessão
    'impersonating_establishment' é a fonte de verdade.
#}

{% set isSuperAdminPuro = app.user
    and 'ROLE_SUPER_ADMIN' in app.user.roles
    and not app.session.get('impersonating_establishment') %}

{% if not isSuperAdminPuro %}

    {% for rows in menuService.getMenu() %}

        {% if rows.submenu == false %}

            {% if rows.menu.status == 'ativo' %}
                <li class="nav-item">
                    <a class="nav-link {% if rotaAtual == rows.menu.rota %} active {% else %} collapsed {% endif %}"
                       href="{% if rows.menu.rota != '#' %}{{ path(rows.menu.rota) }}{% endif %}">
                        <i class="bi bi-{{ rows.menu.icone }}"></i>
                        <span>{{ rows.menu.titulo }}</span>
                    </a>
                </li>
            {% endif %}

        {% else %}

            {% if rows.menu.status == 'ativo' %}

                {# Verifica se algum submenu está ativo #}
                {% set menuAberto = false %}
                {% for sub in rows.submenu %}
                    {% if sub.rota == rotaAtual %}
                        {% set menuAberto = true %}
                    {% endif %}
                {% endfor %}

                <li class="nav-item">
                    <a class="nav-link {% if not menuAberto %}collapsed{% else %}active{% endif %}"
                       href="#"
                       data-bs-toggle="collapse"
                       data-bs-target="#menu-{{ rows.menu.id }}">
                        <i class="bi bi-{{ rows.menu.icone }}"></i>
                        <span>{{ rows.menu.titulo }}</span>
                        <i class="bi bi-chevron-down ms-auto"></i>
                    </a>

                    <ul id="menu-{{ rows.menu.id }}"
                        class="nav-content collapse {% if menuAberto %}show{% endif %}"
                        data-bs-parent="#sidebar-nav">

                        {% for sub in rows.submenu %}
                            <li>
                                <a href="{{ path(sub.rota) }}"
                                   class="{% if rotaAtual == sub.rota %}active{% endif %}">
                                    <i class="bi bi-circle"></i>
                                    <span>{{ sub.titulo }}</span>
                                </a>
                            </li>
                        {% endfor %}

                    </ul>
                </li>

            {% endif %}

        {% endif %}

    {% endfor %}

{% endif %}
