{% extends 'base.html.twig' %}

{% block title %}Agendamentos{% endblock %}
{% block page_title %}<i class="bi bi-calendar-check me-2"></i> Agendamentos{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .card-title { color: #004080; font-weight: bold; }
    .tabela-container input.form-control-md { max-width: 450px; margin-bottom: 1.5rem; }
    .card-item { transition: box-shadow 0.2s; }
    .card-item:hover { box-shadow: 0 0 0 4px #e5eefe; }
    .dropdown-menu .dropdown-item.text-danger { color: #dc3545 !important; }
    .text-danger.fw-bold { color: #c00 !important; font-weight: bold !important; }
    .text-success.fw-bold { color: #007f00 !important; font-weight: bold !important; }

    .agenda-card {
        transition: all .25s ease;
        background: #fff;
    }

    .agenda-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0,0,0,.08);
    }

    .agenda-date {
        width: 64px;
        background: #f8f9fa;
        border-radius: 14px;
        padding: .5rem;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
    }

    .info-group {
      margin-bottom: 1.5rem;
    }

    .info-label {
      font-size: .8rem;
      color: #6c757d;
    }

    .info-box {
      background: #fff;
      border-radius: 12px;
      padding: .6rem .9rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <!-- Action Bar -->
    <div class="pagetitle">
      <h1>Gerencie os agendamentos através do calendário integrado
            <a href="{{ path('agendamento_novo') }}" class="btn btn-primary float-end">
                <i class="bx bx-plus-medical me-1"></i>Novo Agendamento
            </a>
        </h1>
      <nav></h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{url('home')}}">Home</a></li>
          <li class="breadcrumb-item">Atendimento</li>
          <li class="breadcrumb-item active">Agendamentos</li>
        </ol>
      </nav>
    </div>

    <div class="tabela-container container-fluid px-2">

        <div id="cardContainerAgendamento" class="row gy-3">

            {% for agendamento in agendamentos %}
            {% set cor_texto = '' %}
            {% if agendamento.metodo_pagamento == 'pendente' %}
                {% set cor_texto = 'text-danger fw-bold' %}
            {% elseif agendamento.concluido %}
                {% set cor_texto = 'text-success fw-bold' %}
            {% endif %}

            <div class="col-12 card-items"
                 data-search="{{ agendamento.pet_nome }} {{ agendamento.dono_nome }} {{ agendamento.servico_nome }} {{ agendamento.horaChegada|date('d/m/Y') }}">

            <div class="card agenda-card border-0 rounded-4 shadow-sm">
                <div class="card-body p-3">

                    <div class="row align-items-center g-3">

                        <!-- Data -->
                        <div class="col-md-2 col-sm-6 col-xs-12 text-center agenda-date {{ cor_texto }}">
                            <div class="fs-4 fw-bold">
                                {{ agendamento.horaChegada ? agendamento.horaChegada|date('d') : '--' }}
                            </div>
                            <div class="text-uppercase small">
                                {{ agendamento.horaChegada|mes_br }}
                            </div>
                            <div class="small">
                                {{ agendamento.horaChegada ? agendamento.horaChegada|date('H:i') : '--:--' }}
                            </div>
                        </div>

                        <!-- Conteúdo -->
                        <div class="col-md-6 col-sm-6 col-xs-12">

                            <h6 class="mb-1 {{ cor_texto }}">
                                <i class="bx bx-briefcase"></i> {{ agendamento.servico_nome }}
                            </h6>

                            <div class="d-flex flex-wrap gap-3 text-muted small">

                                <span>
                                    <i class="bx bx-user"></i>
                                    <a href="javascript:void(0);"
                                       class="buscar-cliente text-decoration-none {{ cor_texto }}"
                                       data-dono-id="{{ agendamento.dono_id }}">
                                        {{ agendamento.dono_nome }}
                                    </a>
                                </span>

                                <span><i class="bx bx-paw"></i> {{ agendamento.pet_nome }}</span>

                                <span>
                                    <i class="bx bx-car"></i>
                                    Táxi Dog: {{ agendamento.taxi_dog ? 'Sim' : 'Não' }}
                                    {% if agendamento.taxi_dog %}
                                        — R$ {{ agendamento.taxa_taxi_dog }}
                                    {% endif %}
                                </span>

                                <span>
                                    <i class="bx bx-credit-card"></i>
                                    {{ agendamento.metodo_pagamento|capitalize }}
                                </span>

                            </div>

                        </div>

                        <!-- Ações -->
                        <div class="col-md-4 col-sm-6 col-xs-12 text-end">
                            <div class="dropdown dropstart">
                                <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-toggle="dropdown">
                                    <i class="bx bx-dots-vertical-rounded"></i> Ação
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3" style="width: 350px !important;">
                                    <li>
                                        <a href="{{ path('agendamento_editar', {'id': agendamento.id}) }}" class="dropdown-item">
                                            <i class="bx bx-edit"></i> Editar
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);"
                                           class="dropdown-item open-concluir-modal"
                                           data-id="{{ agendamento.id }}"
                                           data-action="{{ path('agendamento_concluir', {'id': agendamento.id}) }}">
                                            <i class="bx bx-check-circle"></i> Concluir Pagamento
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);"
                                           class="dropdown-item text-danger reload-form"
                                           data-id="{{ agendamento.id }}"
                                           data-action="{{ path('agendamento_executar_acao', {'id': agendamento.id, 'acao': 'deletar'}) }}">
                                            <i class="bx bx-trash"></i> Deletar
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            </div>

            {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center mb-0">Nenhum agendamento encontrado.</div>
            </div>
            {% endfor %}

            </div>

        <div class="row mt-4">
            <div class="col text-center">
                <nav aria-label="Paginação">
                    <ul id="paginationAgendamento" class="pagination justify-content-center mb-0"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow">

      <div class="modal-header bg-white border-bottom">
        <div>
          <h5 class="modal-title fw-bold text-primary mb-0">
            <i class="bx bx-user-circle"></i> Informações do Cliente
          </h5>
          <small class="text-muted">Ficha completa do cliente</small>
        </div>
        <button type="button" class="btn-close fs-3" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body bg-light placeholder-glow">

        <div class="row g-3">

          <div class="col-md-6">
            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-user"></i> Nome</strong>
              <div class="info-box" id="clienteNome">-</div>
            </div>

            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-envelope"></i> Email</strong>
              <div class="info-box" id="clienteEmail">-</div>
            </div>

            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-phone"></i> Telefone</strong>
              <div class="info-box" id="clienteTelefone">-</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-map"></i> Endereço</strong>
              <div class="info-box" id="clienteEndereco">-</div>
            </div>

            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-current-location"></i> Bairro</strong>
              <div class="info-box" id="clienteBairro">-</div>
            </div>

            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-buildings"></i> Cidade</strong>
              <div class="info-box" id="clienteCidade">-</div>
            </div>

            <div class="info-group mb-3">
              <strong class="info-label"><i class="bx bx-mail-send"></i> CEP</strong>
              <div class="info-box" id="clienteCep">-</div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>


<!-- Modal Concluir Agendamento -->
<div class="modal fade" id="modalConcluir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Concluir Agendamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Serviços Prestados</h6>
                <div id="servicos-list"></div>
                <hr>
                <h6>Financeiro Pendente</h6>
                <div id="pendentes-list">
                    <p>Nenhum registro pendente encontrado.</p>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="desconto" class="form-label">Desconto (R$):</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="desconto" value="0">
                </div>
                <div class="mb-3">
                    <label for="total" class="form-label">Total (R$):</label>
                    <input type="text" class="form-control" id="total" readonly>
                </div>
                <div class="mb-3">
                    <label for="metodo_pagamento" class="form-label">Método de Pagamento:</label>
                    <select name="metodo_pagamento" id="metodo_pagamento" class="form-control">
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="credito">Cartão de Crédito</option>
                        <option value="debito">Cartão de Débito</option>
                        <option value="pacote_semanal_1">Pacote Semanal 1</option>
                        <option value="pacote_semanal_2">Pacote Semanal 2</option>
                        <option value="pacote_semanal_3">Pacote Semanal 3</option>
                        <option value="pacote_semanal_4">Pacote Semanal 4</option>
                        <option value="pacote_quinzenal">Pacote Quinzenal</option>
                        <option value="pacote_mensal">Pacote Mensal</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-warning" id="btn-marcar-pendente" data-id="" data-ja-acionado="false">
                        <i class="bi bi-clock-history"></i> Pagamento Pendente
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btn-concluir-pagamento">
                        <i class="bi bi-cash-coin"></i> Concluir Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('js/TabelaDefault.js') }}"></script>
<script>
let agendamentosPendentesMarcados = new Set();
let totalOriginal = 0;

    $('#searchInput').attr('id','searchInputAgendamento');
document.addEventListener('DOMContentLoaded', function () {
    new TabelaDefault({
        cardContainerId: 'cardContainerAgendamento',
        paginationId: 'paginationAgendamento',
        searchInputId: 'searchInputAgendamento',
        itemsPerPage: 10
    });

    // Modal concluir
    $('.open-concluir-modal').on('click', function(e) {
        e.preventDefault();
        const rota = $(this).data('action');
        const agendamentoId = $(this).data('id');
        $('#btn-marcar-pendente').data('id', agendamentoId);

        fetch(rota, { method: "GET" })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                const servicosList = $('#servicos-list');
                const pendentesList = $('#pendentes-list');
                const totalInput = $('#total');
                servicosList.empty();
                pendentesList.empty();

                $.each(data.clientes, function(clienteNome, info) {
                    servicosList.append(`<h6>Cliente: ${clienteNome}</h6>`);
                    const ul = $('<ul></ul>');
                    $.each(info.servicos, function(index, servico) {
                        ul.append(`<li>${servico.servico_nome} para ${servico.pet_nome}: R$ ${servico.valor.toFixed(2)}</li>`);
                    });
                    if (data.agendamento.taxi_dog) {
                        const taxaTaxiDog = parseFloat(data.agendamento.taxa_taxi_dog) || 0;
                        ul.append(`<li>Táxi Dog: R$ ${taxaTaxiDog.toFixed(2)}</li>`);
                    }
                    servicosList.append(ul);
                });

                if (data.pendentes && data.pendentes.length > 0) {
                    const ul = $('<ul></ul>');
                    $.each(data.pendentes, function(index, pendente) {
                        const valorPendente = parseFloat(pendente.valor) || 0;
                        ul.append(`<li>${pendente.descricao}: R$ ${valorPendente.toFixed(2)}</li>`);
                    });
                    pendentesList.html(ul);
                } else {
                    pendentesList.html('<p>Nenhum registro pendente encontrado.</p>');
                }

                totalOriginal = parseFloat(data.total_geral) || 0;
                totalInput.val(totalOriginal.toFixed(2));
                const modalElement = document.getElementById('modalConcluir');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                Notify.toast("Erro: " + data.mensagem, "danger");
            }
        })
        .catch(error => {
            Notify.toast("Erro ao carregar os dados: " + error.message, "danger");
        });
    });

    // Concluir pagamento
    $('#btn-concluir-pagamento').off('click').on('click', function() {
        const agendamentoId = $('#btn-marcar-pendente').data('id');
        const desconto = parseFloat($('#desconto').val()) || 0;
        const metodoPagamento = $('#metodo_pagamento').val();
        const url = "{{ path('agendamento_concluir_pagamento', {'id': 'AGENDAMENTO_ID'}) }}".replace('AGENDAMENTO_ID', agendamentoId);

        fetch(url, {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ 'desconto': desconto, 'metodo_pagamento': metodoPagamento })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                Notify.toast(data.mensagem, "success");
                const modalElement = document.getElementById('modalConcluir');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                const mensagemErro = data.mensagem === "Este agendamento já foi concluído anteriormente."
                    ? "Pagamento já foi lançado ou concluído."
                    : data.mensagem || "Erro ao processar o pagamento.";
                Notify.toast(mensagemErro, "danger");
            }
        })
        .catch(error => {
            Notify.toast("Erro ao processar o pagamento: " + error.message, "danger");
        });
    });

    // Atualiza total ao mudar desconto
    $('#desconto').on('input', function() {
        const desconto = parseFloat($(this).val()) || 0;
        const total = totalOriginal - desconto;
        $('#total').val(total.toFixed(2));
    });

    // Modal buscar cliente
    $(document).on('click', '.buscar-cliente', function () {
        var donoId = $(this).data('dono-id');
        var modalCliente = $('#modalCliente');
        if (!donoId) {
            Notify.modal("Erro: Dono ID não encontrado.", 'md', 'Mensagem do sistema');
            return;
        }
        const url = "{{ absolute_url(path('api_buscar_cliente')) }}";
                    const modal = new bootstrap.Modal(document.getElementById('modalCliente'));
                    modal.show();
        $.ajax({
            type: 'POST',
            url: url,
            data: { dono_id: donoId },
            dataType: 'json',
            beforeSend: function(){
                $('.info-box').addClass('placeholder').addClass('col-12');
            },
            success: function (data) {
                if (data.status === "sucesso") {
                    modalCliente.find('#clienteNome').html(data.cliente.nome || '-');
                    modalCliente.find('#clienteEmail').html(data.cliente.email || '-');
                    modalCliente.find('#clienteTelefone').html(data.cliente.telefone || data.cliente.whatsapp || '-');
                    const endereco = [
                        data.cliente.rua,
                        data.cliente.numero,
                        data.cliente.complemento
                    ].filter(Boolean).join(', ');
                    modalCliente.find('#clienteEndereco').html(endereco || '-');
                    modalCliente.find('#clienteBairro').html(data.cliente.bairro || '-');
                    modalCliente.find('#clienteCidade').html(data.cliente.cidade || '-');
                    modalCliente.find('#clienteCep').html(data.cliente.cep || '-');
                    $('.info-box').removeClass('placeholder').removeClass('col-12');
                } else {
                    Notify.toast("Erro: " + data.mensagem, "danger");
                }
            },
            error: function (xhr, status, error) {
                Notify.toast("Erro na requisição: " + error, "danger");
            }
        });
        return false;
    });

    // Deletar agendamento
    $('.reload-form').on('click', function() {
        var rota = $(this).data('action');
        fetch(rota, { method: "POST", body: {} })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                Notify.toast(data.mensagem, data.status);
            } else {
                Notify.toast("Erro: " + data.mensagem, "danger");
            }
        })
        .catch(error => Notify.toast("Erro na requisição: " + error, "danger"));
    });

    // Alterar pagamento/saída
    $('.reload-form-select').on('change', function() {
        var rota = $(this).attr('action');
        let formData = new FormData(this);
        fetch(rota, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "sucesso") {
                Notify.toast(data.mensagem, 'success');
            } else {
                Notify.toast(data.mensagem, 'danger');
            }
        })
        .catch(error => Notify.toast("Erro na requisição: " + error, "danger"));
    });

    // Marcar pagamento pendente
    $('#btn-marcar-pendente').off('click').on('click', function () {
        const botao = $(this);
        const agendamentoId = botao.data('id');
        if (agendamentosPendentesMarcados.has(agendamentoId)) {
            Notify.toast("⚠️ Este agendamento já foi marcado como pendente anteriormente.", "warning");
            return;
        }
        const rota = "{{ path('agendamento_executar_acao', {'id': 'ID_PLACEHOLDER', 'acao': 'pendente'}) }}".replace('ID_PLACEHOLDER', agendamentoId);
        fetch(rota, { method: "POST", body: {} })
        .then(response => response.json())
        .then(data => {
            if (data.status === "sucesso") {
                Notify.toast(data.mensagem, 'success');
                agendamentosPendentesMarcados.add(agendamentoId);
                botao.prop('disabled', true);
                const modalElement = document.getElementById('modalConcluir');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                location.reload();
            } else {
                Notify.toast(data.mensagem || "Erro ao marcar como pendente.", 'danger');
            }
        })
        .catch(error => Notify.toast("Erro na requisição: " + error.message, 'danger'));
    });
});
</script>
{% endblock %}
