{% extends 'base.html.twig' %}

{% block title %}{{ estabelecimento.razaoSocial }} - Detalhes - Super Admin{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-building text-primary me-2"></i>
                {{ estabelecimento.razaoSocial }}
            </h2>
            <p class="text-muted mb-0">{{ estabelecimento.cidade }} - {{ estabelecimento.cnpj }}</p>
        </div>
        <div>
            <a href="{{ path('superadmin_estabelecimentos') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
            <a href="{{ path('superadmin_acessar_estabelecimento', {id: estabelecimento.id}) }}" class="btn btn-primary">
                <i class="fas fa-sign-in-alt me-2"></i>Acessar Estabelecimento
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Coluna Esquerda - Informações -->
        <div class="col-lg-8">
            <!-- Status do Plano -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Status da Assinatura
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-calendar-check fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Plano Atual</small>
                                    <h4 class="mb-0">{{ estabelecimento.plano.titulo}}</h4>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="rounded-circle {% if expirado %}bg-danger{% elseif dias_expiracao <= 15 %}bg-warning{% else %}bg-success{% endif %} bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-clock fa-2x {% if expirado %}text-danger{% elseif dias_expiracao <= 15 %}text-warning{% else %}text-success{% endif %}"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Status</small>
                                    {% if expirado %}
                                        <h5 class="mb-0 text-danger">
                                            <i class="fas fa-times-circle me-1"></i>
                                            Expirado há {{ dias_expiracao }} dias
                                        </h5>
                                    {% elseif dias_expiracao <= 15 %}
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Vence em {{ dias_expiracao }} dias
                                        </h5>
                                    {% else %}
                                        <h5 class="mb-0 text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Ativo
                                        </h5>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row text-center">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Início do Plano</small>
                            <strong>{{ estabelecimento.dataPlanoInicio|date('d/m/Y') }}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Fim do Plano</small>
                            <strong>{{ estabelecimento.dataPlanoFim|date('d/m/Y') }}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Status do Sistema</small>
                            {% if estabelecimento.status == 'Ativo' %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dados Cadastrais -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Dados Cadastrais
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small fw-bold">CNPJ</label>
                            <p class="mb-0 font-monospace">{{ estabelecimento.cnpj }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-bold">Razão Social</label>
                            <p class="mb-0">{{ estabelecimento.razaoSocial }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-bold">Cidade</label>
                            <p class="mb-0">{{ estabelecimento.cidade }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-bold">Data de Cadastro</label>
                            <p class="mb-0">{{ estabelecimento.dataCadastro|date('d/m/Y H:i') }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histórico de Pagamentos -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt me-2 text-primary"></i>
                        Histórico de Pagamentos
                        <span class="badge bg-primary ms-2">{{ invoices|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if invoices|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="px-4 py-3">Número</th>
                                    <th>Data Emissão</th>
                                    <th>Vencimento</th>
                                    <th class="text-end">Valor</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                <tr>
                                    <td class="px-4 font-monospace fw-bold">{{ invoice.numeroInvoice }}</td>
                                    <td>
                                        <small>
                                            <i class="far fa-calendar me-1"></i>
                                            {{ invoice.dataEmissao|date('d/m/Y') }}
                                        </small>
                                    </td>
                                    <td>
                                        <small>
                                            <i class="far fa-calendar-times me-1"></i>
                                            {{ invoice.dataVencimento|date('d/m/Y') }}
                                        </small>
                                    </td>
                                    <td class="text-end fw-bold">R$ {{ invoice.valorTotal|number_format(2, ',', '.') }}</td>
                                    <td class="text-center">
                                        {% if invoice.status == 'pago' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Pago
                                            </span>
                                        {% elseif invoice.status == 'pendente' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Pendente
                                            </span>
                                        {% elseif invoice.status == 'cancelado' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Cancelado
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ invoice.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if invoice.status == 'pendente' %}
                                        <button class="btn btn-sm btn-success" 
                                                onclick="marcarComoPago({{ invoice.id }})"
                                                data-bs-toggle="tooltip"
                                                title="Marcar como pago manualmente">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Nenhum pagamento registrado ainda</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Resumo e Ações -->
        <div class="col-lg-4">
            <!-- Card de Ações Rápidas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>
                        Ações Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('superadmin_acessar_estabelecimento', {id: estabelecimento.id}) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Acessar como Estabelecimento
                        </a>
                        <button class="btn btn-outline-success" onclick="alert('Funcionalidade em desenvolvimento')">
                            <i class="fas fa-paper-plane me-2"></i>
                            Enviar Notificação
                        </button>
                        <button class="btn btn-outline-info" onclick="alert('Funcionalidade em desenvolvimento')">
                            <i class="fas fa-sync-alt me-2"></i>
                            Renovar Plano
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card de Estatísticas -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2 text-success"></i>
                        Estatísticas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="fas fa-receipt me-2"></i>
                                Total de Invoices
                            </span>
                            <span class="badge bg-primary fs-6">{{ invoices|length }}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="fas fa-check-circle me-2"></i>
                                Pagos
                            </span>
                            <span class="badge bg-success fs-6">
                                {{ invoices|filter(i => i.status == 'pago')|length }}
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="fas fa-clock me-2"></i>
                                Pendentes
                            </span>
                            <span class="badge bg-warning text-dark fs-6">
                                {{ invoices|filter(i => i.status == 'pendente')|length }}
                            </span>
                        </div>
                    </div>

                    <hr>

                    <div class="text-center">
                        <small class="text-muted">Cliente desde</small>
                        <div class="fw-bold">{{ estabelecimento.dataCadastro|date('d/m/Y') }}</div>
                        <small class="text-muted">
                            ({{ date().diff(estabelecimento.dataCadastro).days }} dias)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function marcarComoPago(invoiceId) {
    if (!confirm('Deseja marcar este invoice como pago manualmente?')) {
        return;
    }

    fetch(`/superadmin/invoice/${invoiceId}/marcar-pago`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice marcado como pago com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao processar requisição');
        console.error('Error:', error);
    });
}

// Inicializar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
